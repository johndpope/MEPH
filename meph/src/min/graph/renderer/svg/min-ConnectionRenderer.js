MEPH.define("MEPH.graph.renderer.svg.ConnectionRenderer",{requires:["MEPH.util.Renderer","MEPH.util.SVG","MEPH.util.Dom"],extend:"MEPH.graph.renderer.ConnectionRenderer",properties:{singleNodePosition:null,controlpointstroke:"#ff0021",controlpointstrokewidth:3,controlpointfill:"blue",$connectioncache:null},initialize:function(){var a=this;MEPH.Events(a);a.$connectioncache=[];a.singleNodePosition={x:100,y:100};a.callParent.apply(a,arguments);a.svgrenderer=new MEPH.util.SVG()},draw:function(d,c,f){var e=this,b;f=f||{};var a=c.select(function(g){b=e.options(d);b=e.options(f);b.start=g.start;b.end=g.end;return b});return e.renderer.draw(a)},calculateEndPoints:function(d,h,c){var f=this;h=h||{x:0,y:0};var b=c.getZones();var a=b.summation(function(i,k,j){var l=i.getPosition();if(k){return{x:l.x+k.x,y:l.y+k.y}}return{x:l.x,y:l.y}})||{x:0,y:0};var e={x:(a.x/b.length),y:(a.y/b.length)};var g=c.getZones().select(function(i){var j=i.getPosition();return{start:{x:j.x,y:j.y},end:e}});return g},addEventsToConnection:function(a,d){var c=this,b=d.connection;c.don("mouseover",d.path.shape,function(e){var f=a.getXY(e);a.fire("nodeoverconnection",{node:a.isDraggingNode?a.isDraggingNode.node:null,connection:b,xy:f})},d);b.on("selected",function(e){e.path.shape.classList.add("selected")}.bind(c,d));b.on("unselected",function(e){e.path.shape.classList.remove("selected")}.bind(c,d));c.don("click",d.path.shape,function(e){a.selectionConnection(e.connection)}.bind(c,d),d);b.on("removed",function(e){c.svgrenderer.remove(e.path);c.dun(e);c.$connectioncache.removeWhere(function(f){return f===e})}.bind(c,d))},render:function(c,d,i,e){var f=this;if(i&&i.length&&c&&e){var a=i.where(function(j){return !f.$connectioncache.some(function(k){return k.connection===j})});var b=e.getPosition();a.foreach(function(j){var k={connection:j,path:f.createPath(c).first()};f.addEventsToConnection(e,k);f.$connectioncache.push(k)});if(f.$connectioncache.length>0){f.$connectioncache.foreach(function(k){var j=k.connection;var n=k.path;if(j.$zones.length>1){var o=j.$zones.first().$dom;var m=j.$zones.second().$dom;var p=Dom.getRelativeSvgPosition(o,c.parentElement,"center");var l=Dom.getRelativeSvgPosition(m,c.parentElement,"center");if(!(MEPH.equals(n.options.start,p)&&MEPH.equals(n.options.end,l))){n.options.start=p;n.options.end=l;f.svgrenderer.drawLine(n.options,n);n.shape.parentNode.insertBefore(n.shape,n.shape.parentNode.firstChild)}}})}}else{if(c&&d&&!i){if(!f.connectionflowpath){f.connectionflowpath=f.createPath(c).first();f.don("dblclick",f.connectionflowpath.shape,function(){f.dun(f.connectionflowpath.shape);h.viewport.onDblClick()},f.connectionflowpath.shape)}var h=d.first();var g=Dom.getRelativeSvgPosition(h.zone.$dom,c.parentElement,"center");f.connectionflowpath.options.start=h.start;f.connectionflowpath.options.end=g;f.connectionflowpath.shape.classList.add("preconnection");f.svgrenderer.drawLine(f.connectionflowpath.options,f.connectionflowpath);if(f.connectionflowpath.shape.parentNode){f.connectionflowpath.shape.parentNode.insertBefore(f.connectionflowpath.shape,f.connectionflowpath.shape.parentNode.firstChild)}}}},clearFlow:function(){var a=this;if(a.connectionflowpath){a.svgrenderer.remove(a.connectionflowpath);a.connectionflowpath=null}},createPath:function(b,d,a){var c=this;c.svgrenderer.setCanvas(b);return c.svgrenderer.draw({name:"line",shape:MEPH.util.SVG.shapes.line,end:{x:0,y:0},start:{x:0,y:0},strokeStyle:"css",fill:"css",strokeWidth:c.controlpointstrokewidth,"class":"connection"})},renderConnection:function(c,d,g,f){var e=this;var b=c.getNodes();var a=e.calculateEndPoints(b,g,c);e.render(d,a,f);return true},options:function(b){var a={shape:MEPH.util.Renderer.shapes.line,fillStyle:"grey",x:10,y:10,width:200,height:100,radius:4};for(var c in b){a[c]=b[c]}return a},drawToCache:function(c,b){b=b||{};var d=this,a=d.options(b);d.callParent.apply(d,[c,a])}});
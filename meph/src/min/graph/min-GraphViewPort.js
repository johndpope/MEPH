MEPH.define("MEPH.graph.GraphViewPort",{requires:["MEPH.math.J3DIVector3","MEPH.graph.ActiveZone","MEPH.util.Style"],properties:{noViewPortDrag:false,maskDownZIndex:10,maskUpZIndex:20,isDestroyed:false,connectionFlow:null,maxSelectionDistance:30,cancelDragging:false,boundaries:null,templates:null,selectConnectionOnClick:false,resizeDelay:1000,boundaryRetensionSpeed:0.91,fullwindow:false},statics:{start_connection:"start_connection",create:function(g,i,b,d){b=b||"body";var e=new MEPH.graph.GraphViewPort();var f=new MEPH.graph.GraphRenderer();var h=new MEPH.graph.renderer.ConnectionRenderer();var c=new MEPH.graph.renderer.BlenderNode(e);var a=new MEPH.graph.ConnectionHandler();a.setGraph(g);e.setConnectionHandler(a);e.setup(b,i);f.setNodeRenderer(c);f.setConnectionRenderer(h);f.setGraph(g);f.setViewPort(e);f.use("viewport");e.setGraph(g);f.render();if(d&&document.querySelector(d)){e.setHolder(d);e.resize();window.addEventListener("resize",function(){e.resize()})}e.selectConnectionOnClick=true;return e}},initialize:function(){var a=this;MEPH.Events(a);a.$activeZones=MEPH.util.Observable.observable([]);a.$templates=[];a.$selectedConnections=MEPH.util.Observable.observable([]).on("onpush",a.onSelectedConnectionAdded.bind(a));a.setPosition(0,0,0)},onSelectedConnectionAdded:function(d,b){var e=this;var a=b.added;var c=[].interpolate(0,a.length,function(f){return a[f]});c.foreach(function(f){f.on("removed",function(){e.getSelectedConnections().removeWhere(function(g){return g===f})})})},setGraph:function(b){var a=this;a.$graph=b;a.$graph.$viewport=a;a.$graph.on("change",a.onGraphChange.bind(a));return a},destroy:function(){var b=this;var a=b.getDock();if(a&&a.parentNode){a.parentNode.removeChild(a)}b.isDestroyed=true},onGraphChange:function(a){var b=this;a.viewport={position:b.getPosition()};b.fire("change",a)},getGraph:function(){var a=this;return a.$graph},setRenderer:function(b){var a=this;a.$renderer=b},getRenderer:function(){var a=this;return a.$renderer},refresh:function(){var a=this;a.onGraphChange({})},setup:function(a,c){var e=this;var f=document.querySelector(a);var d=document.createElement("div");var b=document.createElement(c&&c.element?c.element:"canvas");b.style.position="absolute";b.style.zIndex=3;c=c||{height:400,width:450};f.appendChild(d);d.appendChild(b);e.setCanvas(b);e.setCanvasSize({height:c.height,width:c.width});e.setDock(d);e.applyMask(d)},setHolder:function(a){var b=this;if(typeof(a)==="string"){a=document.querySelector(a)}b.holder=a},setPosition:function(a,d,c){var b=this;if(b.isMoving(a,d,c)){b.$position=new J3DIVector3(a,d,c);b.fire("moved",{node:b})}},isMoving:function(b,e,d){var c=this,a=c.getPosition();if(a){return !(a.x==b&&a.y==e&&a.z==d)}return true},getPosition:function(){var a=this;if(a.$position){return{x:a.$position[0],y:a.$position[1],z:a.$position[2]}}return null},getRelPosition:function(b){var c=this,a=c;var d=a.getXY(b);var e=a.maskDomPosition();return{x:d.x-e.x,y:d.y-e.y}},onClick:function(a){var d=this;var c=d.getRelPosition(a);var b=d.getGraph().getConnections().minSelect(function(e){return e.distanceFrom(c)});if(b){if(b.distanceFrom(c)<d.maxSelectionDistance){d.selectionConnection(b)}}},onDblClick:function(){var a=this;if(a.connectionFlow&&a.connectionFlow.state===MEPH.graph.GraphViewPort.start_connection){a.connectionFlow=null;a.fire("viewportconnectionflowclear",{})}},onConnectorClick:function(d){var c=this;if(c.connectionFlow==null){c.connectionFlow={zone:d,state:MEPH.graph.GraphViewPort.start_connection};c.fire("startconnection",{zone:d})}else{if(c.connectionFlow&&c.connectionFlow.state===MEPH.graph.GraphViewPort.start_connection){var b=c.getConnectionHandler();if(b){if(MEPH.graph.ActiveZone.canCreateConnection(c.connectionFlow.zone,d)){var a=b.createConnection([c.connectionFlow.zone,d]);if(a){c.connectionFlow=null;c.fire("viewportconnectionflowcomplete",{})}}}}}},createConnection:function(b){var c=this,a=c.getConnectionHandler();if(a){return a.createConnection(b)}return null},getConnectionHandler:function(){var a=this;return a.$connectionHandler},setConnectionHandler:function(a){var b=this;b.$connectionHandler=a;return b},requestZone:function(c,a){var d,b=this;d=b.getActiveZones().first(function(f){return f.id==a.id});if(!d){d=new ActiveZone();d.setNode(c);d.setGraphViewPort(b);d.setZoneType(a.type);d.setOptions(a);switch(a.type){case ActiveZone.type.color:d.on("click",d.onColorZoneClick.bind(d));d.on("change",b.onActiveZoneChange.bind(b));d.clickable();break;case ActiveZone.type.title:d.on("click",d.onTitleZoneClick.bind(d));d.clickable();break;case ActiveZone.type.connector:d.on("click",b.onConnectorClick.bind(b,d));d.clickable();break;case ActiveZone.type.select:d.clickable();break;case ActiveZone.type.header:d.draggable();break;case ActiveZone.type.custom:break}d.on("activezone_dragstart",b.activeZoneDrag.bind(b,d,c));var e=b.createZoneDom(a,c);d.setDom(e);d.on("destroy",function(f){b.getActiveZones().removeWhere(function(g){return g===f})});b.getActiveZones().push({zone:d,id:a.id});b.fire("newactivezone",{id:a.id,zone:d})}else{d=d.zone}d.ignoreCanvas=b.ignoreCanvas;d.setPosition(a.x,a.y,0);return d},activeZoneDrag:function(e,d,b,a){var c=this;Style.zIndex(c.getMask(),c.maskUpZIndex);if(!c.isDraggingNode){c.setDragData(a.evt);c.isDraggingNode={activezone:e,node:d,startPos:d.getPosition()}}},addTemplate:function(a){var b=this;b.$templates.push(a)},getTemplates:function(){var a=this;return a.$templates},createZoneDom:function(k,d){var j,h=this,a=document.createElement("div"),e;switch(k.type){case ActiveZone.type.custom:j=k.template.selector;if(j){e=document.querySelector(j);var g=e.content.cloneNode(true);a.classList.add("custom");a.appendChild(g);if(k.template){for(var f in k.template.style){a.style[f]=k.template.style[f]}if(k.template.promise&&typeof(k.template.promise)==="function"){k.template.promise(a,g,d)}if(k.template.handlers){for(var c in k.template.handlers){var b=k.template.handlers[c];ConvertToList(a.querySelectorAll(c)).foreach(function(l){for(var i in b){l.addEventListener(i,b[i].bind(h,d))}})}}}}break;default:Style.width(a,k.width);Style.height(a,k.height);Style.backgroundColor(a,"rgba(1,1,1,0)");Style.translate(a,k.x,k.y);Style.position(a,"absolute");break}return a},getActiveZones:function(){var a=this;return a.$activeZones},clear:function(){var a=this;a.getActiveZones().removeWhere(function(){return true});a.getSelectedConnections().removeWhere(function(){return true});a.getRenderer().clear()},setDock:function(b){var a=this;if(b.style){b.style.overflow="hidden"}a.$dock=b},getCanvasBag:function(){var a=this;return a.getDock()},getDock:function(){var a=this;return a.$dock||null},setCanvas:function(a){var b=this;if(b.$canvas){b.$canvas.parentNode.removeChild(b.$canvas)}b.$canvas=a;return b},getCanvas:function(){var a=this;return a.$canvas},applyMask:function(c){var b=this,a=b.getCanvasSize();b.$mask=b.$mask||document.createElement("div");b.$mask.style.height=a.height+"px";b.$mask.style.width=a.width+"px";Style.zIndex(b.$mask,b.maskDownZIndex);b.$mask.style.position="absolute";(c||document.body).appendChild(b.$mask);b.$mask.addEventListener("mousedown",b.onMaskMouseDown.bind(b));b.$mask.addEventListener("mouseup",b.onMaskMouseUp.bind(b));b.$mask.addEventListener("mouseout",b.onMaskMouseOut.bind(b));b.$mask.addEventListener("mousemove",b.onMaskMouseMove.bind(b));b.$mask.addEventListener("dblclick",b.onDblClick.bind(b));b.$mask.addEventListener("click",b.onClick.bind(b));window.addEventListener("resize",function(){if(b.resizeTimout){clearTimeout(b.resizeTimout)}b.resizeTimout=setTimeout(b.onResizeEvent.bind(b),b.resizeDelay)});b.on("startdrag",b.onStartDrag.bind(b));b.on("stopdrag",b.onStopDrag.bind(b));b.on("viewportmove",b.onViewPortMove.bind(b));b.on("nodedragging",b.onNodeDragging.bind(b));b.on("nodedragging",b.hoverConnection.bind(b))},getCenter:function(){var b=this,a;a=b.getCanvasSize();return{x:a.width/2+b.getPosition().x,y:a.height/2+b.getPosition().y}},resize:function(a){var b=this;if(b.holder){a=a||Style.size(b.holder)}a=a||Style.windowSize();b.setCanvasSize(a);Style.width(b.getMask(),a.width);Style.height(b.getMask(),a.height);b.getRenderer().getCanvases().foreach(function(c){Style.width(c,a.width);Style.height(c,a.height)})},onResizeEvent:function(){var b=this;if(b.fullwindow){var a=Style.windowSize();b.setCanvasSize(Style.windowSize());Style.width(b.getMask(),a.width);Style.height(b.getMask(),a.height);b.getRenderer().getCanvases().foreach(function(c){Style.width(c,a.width);Style.height(c,a.height)})}},onViewPortMove:function(c,b){var d=this;var e=d.getXY(b);var a=d.calculateRelativePosition(e.x,e.y);d.setDragData(b);d.setPosition(d.dragdata.startPos.x+a.x,d.dragdata.startPos.y+a.y,0)},hoverConnection:function(c,a){var d=this;var b=d.getGraph().getConnections().minSelect(function(f){return f.distanceFrom(a)});if(b){if(b.distanceFrom(a)<d.maxSelectionDistance){var e=d.getXY(a);d.fire("nodeoverconnection",{node:d.isDraggingNode.node,connection:b,xy:e})}}},onNodeDragging:function(d,c){var f=this;var e=f.isDraggingNode.node;var g=f.getXY(c);var b=f.dragdata;var a={x:g.x-b.x,y:g.y-b.y};e.setPosition(f.isDraggingNode.startPos.x+a.x,f.isDraggingNode.startPos.y+a.y,0)},getXY:function(a){var b=this,d={x:0,y:0},c=a.currentTarget;return{x:((a.pageX!==undefined?a.pageX:a.x)||0)+d.x,y:((a.pageX!==undefined?a.pageY:a.y)||0)+d.y}},selectionConnection:function(a){var b=this;if(b.getSelectedConnections().first(a)){b.removeSelectedConnection(a);a.fire("unselected",a)}else{b.addSelectedConnection(a);a.fire("selected",a)}},addSelectedConnection:function(a){var b=this;b.$selectedConnections.push(a)},removeSelectedConnections:function(){var b=this;var a=b.getSelectedConnections().select(function(c){return c}).foreach(function(c){b.removeSelectedConnection(c)});return a},removeSelectedConnection:function(a){var b=this;b.getSelectedConnections().removeWhere(function(c){return c===a})},getSelectedConnections:function(){var a=this;return a.$selectedConnections},calculateRelativePosition:function(a,c){var b=this;if(b.dragdata){return{x:a-b.dragdata.x,y:c-b.dragdata.y}}return{x:0,y:0}},onStartDrag:function(b,a){var c=this;if(!c.cancelDragging&&!c.noViewPortDrag){c.isDragging=true;c.setDragData(a);Style.zIndex(c.$mask,c.maskUpZIndex)}},setDragData:function(a){var b=this;b.dragdata=b.dragdata||{};var c=b.getXY(a);b.dragdata.startPos=b.getPosition();b.dragdata.x=c.x;b.dragdata.y=c.y},getMousePosition:function(){var a=this;return a.mousePosition||{x:0,y:0}},maskDomPosition:function(){var a=this;var b=Style.getOffset(a.getMask(),null);return b},onActiveZoneChange:function(){var a=this;a.fire("change",{})},onMaskMouseMove:function(a){var b=this;b.calculateMousePosition(a);if(b.isDragging){b.fire("viewportmove",a)}else{if(b.isDraggingNode){b.fire("nodedragging",a)}else{if(b.connectionFlow){b.fire("viewportconnectionflow",a)}else{b.fire("mousemove",a)}}}},calculateMousePosition:function(a){var b=this;var c=b.getXY(a);var d=b.maskDomPosition();var e=b.getPosition();b.mousePosition={x:c.x-d.x,y:c.y-d.y}},onMaskMouseOut:function(a){var b=this;if(b.isDragging){b.isDragging=false;b.dragdata=null;b.fire("canceldrag",a)}},onStopDrag:function(b,a){var c=this;if(c.isDragging){c.isDragging=false;c.fire("stopdrag",a);c.handleBoundaries()}},handleBoundaries:function(){var c=this,d,b,a;if(c.boundaries){a=c.getPosition();if(c.boundaries.xmin>a.x){d=c.boundaries.xmin}else{if(c.boundaries.xmax<a.x){d=c.boundaries.xmax}}if(c.boundaries.ymin>a.y){b=c.boundaries.ymin}else{if(c.boundaries.ymax<a.y){b=c.boundaries.ymax}}c.animateBoundary(d,b)}},animateBoundary:function(b,d){var c=this,a=c.getPosition();b=b===undefined?a.x:b;d=d===undefined?a.y:d;c.setPosition(b,d,0)},onMaskMouseDown:function(a){var b=this;if(!b.isDragging){b.fire("startdrag",a)}},onMaskMouseUp:function(a){var b=this;if(b.isDragging||b.isDraggingNode){b.dragdata=null;b.isDraggingNode=null;Style.zIndex(b.$mask,b.maskDownZIndex);b.fire("stopdrag",a)}},getMask:function(){var a=this;return a.$mask},getCanvasSize:function(){var b=this,a=b.getCanvas();return{height:a.height,width:a.width}},setCanvasSize:function(b){var c=this,a=c.getCanvas();Style.height(a,b.height);Style.width(a,b.width)}});
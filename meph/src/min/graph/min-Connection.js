MEPH.define("MEPH.graph.Connection",{requires:["MEPH.math.Vector"],properties:{$connectionDetectionDepth:10,$selectable:true,$deleteable:true},isSelectable:function(a){var b=this;if(a!==undefined){b.$selectable=a}return b.$selectable},isDeleteable:function(a){var b=this;if(a!==undefined){b.$deleteable=a}return b.$deleteable},initialize:function(a){var b=this;MEPH.Events(b);b.$zones=[];b.nodes=MEPH.util.Observable.observable([]).on("afterpush",b.handleNewNodes.bind(b)).on("beforepush",b.fire.bind(b,"beforenodeadded")).on("afterpush",b.fire.bind(b,"afternodeadded")).on("onpush",b.fire.bind(b,"nodeadded")).on("onpush",b.fire.bind(b,"changed")).on("beforesplice",b.fire.bind(b,"beforenoderemoved")).on("aftersplice",b.fire.bind(b,"afternoderemoved")).on("onremove",b.fire.bind(b,"noderemoved")).on("onremove",b.fire.bind(b,"changed"))},handleNewNodes:function(c,e){var d=this,a=[];for(var b=0;b<e.added.length;b++){if(a.indexOf(e.added[b])===-1){a.push(e.added[b])}}if(a){a.foreach(function(f){f.addConnection(d);f.on("removed",d.onNodeRemoved.bind(d,f))})}},removed:function(){var a=this;a.fire("removed",{})},selectZones:function(a,c){var b=this;return b.getZones().where(function(d){return d.getNode()===c})},onNodeRemoved:function(b){var a=this;a.removeNode(b)},setConnectionDetectionDepth:function(b){var a=this;a.$connectionDetectionDepth=b},getConnectionDetectionDepth:function(){var a=this;return a.$connectionDetectionDepth},distanceFrom:function(a){var b=this;var d=Vector.Create(a);var c=b.calculateEndPoints(b);return c.min(function(e){var h=Vector.Create(e.start);var f=Vector.Create(e.end);var g=b.getConnectionDetectionDepth();return[].interpolate(0,g,function(i){return Vector.Lerp2D(h,f,i/g).distance(d)}).min()})},calculateEndPoints:function(c){var e=this;var g={x:0,y:0};var b=c.getZones();var a=b.summation(function(h,j,i){var k=h.getPosition();if(j){return{x:k.x+j.x,y:k.y+j.y}}return{x:k.x,y:k.y}})||{x:0,y:0};var d={x:(a.x/b.length),y:(a.y/b.length)};var f=c.getZones().select(function(h){var i=h.getPosition();return{start:{x:i.x,y:i.y},end:d}});return f},setId:function(b){var a=this;if(!a.$id){a.$id=b}},getId:function(){var a=this;return a.$id},addNodes:function(a){var b=this;if(!Array.isArray(a)){a=[a]}a.foreach(function(c){b.nodes.push(c)})},addZone:function(a){var c=this;var b=a.getNode();if(!c.$zones.first(a)){c.$zones.push(a)}},getZones:function(){var a=this;return a.$zones},save:function(){var b=this,a={};a.id=b.getId()||b.setId(MEPH.GUID())||b.getId();a.nodes=b.getNodes().select(function(c){return c.getId()});a.zones=b.getZones().select(function(c){return c.getOptions().id});return a},hasZone:function(a){var b=this;return b.getZones().contains(function(c){return c===a})},hasNode:function(b){var a=this;return a.nodes.contains(function(c){return c===b})},addNode:function(b){var a=this;if(!a.nodes.contains(function(c){return c===b})){a.nodes.push(b)}},getNode:function(b){var a=this;return a.nodes.first(function(c){return c===b})},getNodes:function(){var a=this;return a.nodes},removeNode:function(c){var b=this;var a=b.nodes.removeWhere(function(d){return d===c});if(b.nodes.length<2){b.fire("emptyconnection",b)}}});
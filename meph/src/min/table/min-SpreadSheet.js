MEPH.define("MEPH.table.SpreadSheet",{alias:"spreadsheet",templates:true,requires:["MEPH.util.Renderer","MEPH.util.Style","MEPH.util.Dom","MEPH.scrollbar.Scrollbar","MEPH.util.SVG"],extend:"MEPH.control.Control",statics:{states:{Selectingleft:"selectingleft",Selectingtop:"selectingtop",Selecting:"selecting"}},properties:{width:0,height:0,vertical:false,animatemode:false,animFrame:null,enablesvg:false,columnOffsets:null,rowOffsets:null,columnheaders:0,endselectonmouseout:false,rowheaders:0,state:null,columns:null,rows:null,defaultRowHeight:50,selectedrange:null,selectedrangeleft:null,selectedrangetop:null,defaultColumnWidth:80,defaultHeaderColumnWidth:80,gridlinecolor:"#d6ccf0",startColumn:0,vbarposition:null,hbarposition:null,startRow:0,startTopRow:0,startLeftColumn:0,verticalSize:0,horizontalSize:0,selectedleftheader:null,selectedtopheader:null,cache:null,visibleleftheader:null,visibletopheader:null,visiblegrid:null},initialize:function(){var a=this;a.callParent.apply(a,arguments);a.cache={};a.renderer=new MEPH.util.Renderer();a.rendererContent=new MEPH.util.Renderer();a.leftRenderer=new MEPH.util.Renderer();a.leftContentRenderer=new MEPH.util.Renderer();a.topRenderer=new MEPH.util.Renderer();a.topContentRenderer=new MEPH.util.Renderer();a.columnOffsets=null;a.rowOffsets=null;a.requestActiveSelect=null;a.requestActiveCell=null;a.on("altered",function(d,b){var c=parseFloat(a.rowheaders);var g=parseFloat(a.columns);var f=parseFloat(a.rows);var e=parseFloat(a.columnheaders);if(b.path==="rowheaders"||b.property==="gridlinecolor"||b.path==="columnheaders"||b.path==="columns"||b.path==="vertical"||b.property==="enablesvg"||b.property==="startColumn"||b.property==="startRow"||b.property==="vbarposition"||b.property==="hbarposition"||b.path==="rows"){if(b.property==="enablesvg"){if(a.enablesvg&&!a.svgrenderer){a.svgrenderer=new MEPH.util.SVG();a.svgrenderer.batchdraw=true;a.svgrenderer.setCanvas(a.canvassvg)}}if(b.property==="vbarposition"){a.setStartRow(a.vbarposition)}if(b.property==="hbarposition"){a.setStartColumn(a.hbarposition)}if(!a.columnOffsets&&c&&g){a.columnOffsets=[].interpolate(0,g,function(h){return a.defaultColumnWidth});a.columnHeaderOffsets=[].interpolate(0,e,function(h){return a.defaultHeaderColumnWidth});a.refreshRowColPositions()}if(!a.rowOffsets&&f&&e){a.rowOffsets=[].interpolate(0,f,function(h){return a.defaultRowHeight});a.rowHeaderOffsets=[].interpolate(0,c,function(h){return a.defaultRowHeight});a.refreshRowColPositions()}a.update()}})},refreshRowColPositions:function(){var a=this;if(a.columnOffsets){a.columnPositions=a.columnOffsets.subset(0,a.columnOffsets.length).cumsum();a.columnHeaderPositions=a.columnHeaderOffsets.subset(0,a.columnHeaderOffsets.length).cumsum()}if(a.rowOffsets){a.rowPositions=a.rowOffsets.subset(0,a.rowOffsets.length).cumsum();a.rowHeaderPositions=a.rowHeaderOffsets.subset(0,a.rowHeaderOffsets.length).cumsum()}},onLoaded:function(){var a=this;a.callParent.apply(a,arguments);a.appendEvents();a.rendererContent.setCanvas(a.canvascontent);a.leftContentRenderer.setCanvas(a.leftheadercontent);a.topContentRenderer.setCanvas(a.topheadercontent)},appendEvents:function(){var a=this;a.don("resize",window,a.update.bind(a));a.appendCanvasEvents();a.appendHeaderEvents()},appendHeaderEvents:function(){var a=this;a.don("click",a.topheader,function(b){a.handleSingleHeaderCellCalculations(a.topheader,b,"topheadercellclicked","top")});a.don("click",a.leftheader,function(b){a.handleSingleHeaderCellCalculations(a.leftheader,b,"leftheadercellclicked","left")});a.don("mousemove",a.topheader,function(b){a.handleSingleHeaderCellCalculations(a.topheader,b,"mousemovetopheader","top")});a.don("mousemove",a.leftheader,function(b){a.handleSingleHeaderCellCalculations(a.leftheader,b,"mousemoveleftheader","left")});a.don("mousemovetopheader",a.topheader,function(b){a.handleMouseMoveHeaderCell(b,"top")});a.don("mousemoveleftheader",a.leftheader,function(b){a.handleMouseMoveHeaderCell(b,"left")});a.don("mouseover",a.leftheader,a.headerMouseEventHandler.bind(a,"left",a.leftheader,"mouseoverheader"));a.don("mousemove",a.leftheader,a.headerMouseMoveHandler.bind(a,"left",a.leftheader));a.don("mousemoveselectleft",a.leftheader,a.headerMouseMoveSelectHandler.bind(a,"left",a.leftheader));a.don("mousedown",a.leftheader,a.headerMouseDownHandler.bind(a,"left",a.leftheader));a.don("mouseup",a.leftheader,a.onHeaderMouseupSelecting.bind(a,"left",a.leftheader));if(a.endselectonmouseout){a.don("mouseout",a.leftheader,a.onHeaderMouseupSelecting.bind(a,"left",a.leftheader))}a.don("mousedown",a.topheader,a.headerMouseDownHandler.bind(a,"top",a.topheader));a.don("mousemove",a.topheader,a.headerMouseMoveHandler.bind(a,"top",a.topheader));a.don("mouseover",a.topheader,a.headerMouseEventHandler.bind(a,"top",a.topheader,"mouseoverheader"));a.don("mousemoveselecttop",a.topheader,a.headerMouseMoveSelectHandler.bind(a,"top",a.topheader));a.don("mouseup",a.topheader,a.onHeaderMouseupSelecting.bind(a,"top",a.topheader));if(a.endselectonmouseout){a.don("mouseout",a.topheader,a.onHeaderMouseupSelecting.bind(a,"top",a.topheader))}},onHeaderMouseupSelecting:function(d,e,a){var b=this;if(b.state===MEPH.table.SpreadSheet.states.Selecting+d){var c=b.getSelectedStartRow(b.selecting);b["selectedrange"+d]=b.selecting;if(b["selected"+d+"header"]){b["selected"+d+"header"].clear();if(c){[].interpolate(c.startrow,c.endrow+1,function(f){[].interpolate(c.startcolumn,c.endcolumn+1,function(g){b["selected"+d+"header"].push({row:f,column:g})})})}}b.selecting=null;b.state=null}},headerMouseMoveSelectHandler:function(c,e,a){var b=this;var d=a.selecting;if(!d||!d.end||!d.start){return null}b.handleHeaderMouseMoveCellSelect(c,a)},handleHeaderMouseMoveCellSelect:function(h,a){var e=this;if(a.selecting){var g=e.getSelectedStartRow(a.selecting);if(g){var f=e.getCellPosition({row:g.startrow,column:g.startcolumn},h);var d=e.getCellPosition({row:g.startrow,column:g.endcolumn+1},h);var c=e.getCellPosition({row:g.startrow,column:g.endcolumn},h);var b=e.getCellPosition({row:g.endrow+1,column:g.endcolumn},h);e.setHeaderActiveSelect(f.x,d.x,c.y,b.y,h)}}},headerMouseEventHandler:function(e,g,c,a){var d=this;var b=d.getHeaderCells(a);var f=MEPH.util.Dom.getEventPositions(a,g);g.dispatchEvent(MEPH.createEvent(c+e,{cells:b,position:f}))},headerMouseMoveHandler:function(e,f,b){var d=this;if(d.state===MEPH.table.SpreadSheet.states.Selecting+e){var c=d.getHeaderCells(b);var a=c.first();d.selecting.end=a;f.dispatchEvent(MEPH.createEvent("mousemoveselect"+e,{selecting:d.selecting}))}},headerMouseDownHandler:function(e,f,b){var d=this;if(!d.state){var c=d.getHeaderCells(b,e);var a=c.first();d.selecting={start:a};document.body.classList.add("noselect");d.state=MEPH.table.SpreadSheet.states.Selecting+e;f.dispatchEvent(MEPH.createEvent(e+"selectstart",{cell:a}))}},appendCanvasEvents:function(){var b=this;b.don("click",[b.canvassvg,b.canvas],function(c){b.handleSingleCellCalculations(c,"cellclicked")});b.don("keypress",[b.canvassvg,b.canvas],function(c){b.onKeyPress(c)});b.don("keypress",b.leftheader,function(c){b.onKeyPress(c)});if(b.movemoverequest){cancelAnimationFrame(b.movemoverequest)}b.don("mousemove",[b.canvassvg,b.canvas],function(c){var d=function(){b.handleSingleCellCalculations(c,["mouseovercell","mousemovecell"]);if(b.state===MEPH.table.SpreadSheet.states.Selecting){var e=b.hovercells?b.hovercells.first():b.getCanvasCells(c).first();b.selecting.end=e;b.canvas.dispatchEvent(MEPH.createEvent("mousemoveselect",{selecting:b.selecting}))}};if(b.animatemode){b.movemoverequest=requestAnimationFrame(d)}else{d()}});b.don("mousemovecell",b.canvas,function(c){b.handleMouseMoveCell(c)});b.don("mousemoveselect",b.canvas,function(c){var d=c.selecting;if(!d||!d.end||!d.start){return null}b.handleMouseMoveCellSelect(c)});b.don("mousedown",[b.canvassvg,b.canvas],function(c){if(b.commands&&b.commands.first(function(d){return d.command==="select"})){return}b.select(c)});b.don("mouseout",[b.canvassvg,b.canvas],b.onMouseupSelecting.bind(b));b.don("mouseup",[b.canvassvg,b.canvas],b.onMouseupSelecting.bind(b));var a=function(){document.body.classList.remove("noselect")};b.don("mouseup",document.body,a);b.don("mouseout",document.body,a)},getSelectedStartRow:function(e){if(!e||!e.end||!e.start){return null}var c=Math.min(e.end.row,e.start.row);var b=Math.max(e.end.row,e.start.row);var d=Math.min(e.end.column,e.start.column);var a=Math.max(e.end.column,e.start.column);return{startrow:c,endrow:b,startcolumn:d,endcolumn:a}},onMouseupSelecting:function(){var a=this;if(a.commands&&a.commands.first(function(b){return b.command==="select"})){return}a.endselect()},handleMouseMoveCell:function(i){var h=this;var e=i.cells.minSelect(function(k){return k.row});var d=i.cells.maxSelection(function(k){return k.row});var a=i.cells.minSelect(function(k){return k.column});var g=i.cells.maxSelection(function(k){return k.column});var b=h.getCellPosition(e);var f=h.getCellPosition({row:d.row,column:d.column+1});var c=h.getCellPosition(a);var j=h.getCellPosition({row:g.row+1,column:g.column});h.setActiveCell(b.x,f.x,c.y,j.y)},handleMouseMoveHeaderCell:function(j,g){var i=this;var e=j.cells.minSelect(function(l){return l.row});var d=j.cells.maxSelection(function(l){return l.row});var a=j.cells.minSelect(function(l){return l.column});var h=j.cells.maxSelection(function(l){return l.column});var b=i.getCellPosition(e,g);var f=i.getCellPosition({row:d.row,column:d.column+1},g);var c=i.getCellPosition(a,g);var k=i.getCellPosition({row:h.row+1,column:h.column},g);i.setActiveHeaderCell(b.x,f.x,c.y,k.y,g)},updateSelectedMouse:function(){var a=this;if(a.selectedrange){a.handleMouseMoveCellSelect({selecting:a.selectedrange})}if(a.selectedrangeleft){a.handleHeaderMouseMoveCellSelect("left",{selecting:a.selectedrangeleft})}if(a.selectedrangetop){a.handleHeaderMouseMoveCellSelect("top",{selecting:a.selectedrangetop})}},handleMouseMoveCellSelect:function(a){var e=this;if(a.selecting){var g=e.getSelectedStartRow(a.selecting);if(g){var f=e.getCellPosition({row:g.startrow,column:g.startcolumn});var d=e.getCellPosition({row:g.startrow,column:g.endcolumn+1});var c=e.getCellPosition({row:g.startrow,column:g.endcolumn});var b=e.getCellPosition({row:g.endrow+1,column:g.endcolumn});e.setActiveSelect(f.x,d.x,c.y,b.y)}}},setHeaderActiveSelect:function(c,a,j,i,g){var h=this,b={x1:c,x2:a,y1:j,y2:i};var e="requestHeaderActiveSelectArea"+g;if(h[e]!=null||h[e]!=undefined){cancelAnimationFrame(h[e])}var f="selectarea"+g;var d="selectArea"+g;h[e]=requestAnimationFrame(function(){if(h[f]&&MEPH.equals(h[f],b)){}else{if(arguments.length===4){h[d]=b;Style.top(h[f],j+(g==="left"?h.getColumnHeaderHeight():0));Style.left(h[f],c+(g==="left"?0:h.getRowsHeaderWidth()));Style.width(h[f],a-c);Style.height(h[f],i-j);h[f].classList.add("active")}else{h[f].classList.remove("active")}}h["requestHeaderActiveSelect"+g]=null}.bind(c,a,j,i))},setActiveHeaderCell:function(c,a,j,i,g){var h=this,b={x1:c,x2:a,y1:j,y2:i};var e="requestHeaderActiveSelect"+g;if(h[e]!=null||h[e]!=undefined){cancelAnimationFrame(h[e])}var f="activearea"+g;var d="activeArea"+g;h[e]=requestAnimationFrame(function(){if(h[f]&&MEPH.equals(h[f],b)){}else{if(arguments.length===4){h[d]=b;Style.top(h[f],j+(g==="left"?h.getColumnHeaderHeight():0));Style.left(h[f],c+(g==="left"?0:h.getRowsHeaderWidth()));Style.width(h[f],a-c);Style.height(h[f],i-j);h[f].classList.add("active")}else{h[f].classList.remove("active")}}h["requestHeaderActiveSelect"+g]=null}.bind(c,a,j,i))},setActiveSelect:function(b,a,d,c){var f=this,e={x1:b,x2:a,y1:d,y2:c};if(f.requestActiveSelect!=null){cancelAnimationFrame(f.requestActiveSelect)}f.requestActiveSelect=requestAnimationFrame(function(){if(f.selectArea&&MEPH.equals(f.selectArea,e)){}else{if(arguments.length===4){f.selectArea=e;Style.top(f.selectarea,d+f.getColumnHeaderHeight());Style.left(f.selectarea,b+f.getRowsHeaderWidth());Style.width(f.selectarea,a-b);Style.height(f.selectarea,c-d);f.selectarea.classList.add("active")}else{f.selectarea.classList.remove("active")}}f.requestActiveSelect=null}.bind(b,a,d,c))},setActiveCell:function(b,a,d,c){var f=this,e={x1:b,x2:a,y1:d,y2:c};if(f.requestActiveCell){cancelAnimationFrame(f.requestActiveCell)}f.requestActiveCell=requestAnimationFrame(function(){if(f.activeArea&&MEPH.equals(f.activeArea,e)){}else{if(arguments.length===4){f.activeArea=e;Style.top(f.activearea,d+f.getColumnHeaderHeight());Style.left(f.activearea,b+f.getRowsHeaderWidth());Style.width(f.activearea,a-b);Style.height(f.activearea,c-d);f.activearea.classList.add("active")}else{f.activearea.classList.remove("active")}}f.requestActiveCell=null}.bind(b,a,d,c))},handleSingleHeaderCellCalculations:function(d,a,c,f){var e=this;var b=e.getHeaderCells(a,f);d.dispatchEvent(MEPH.createEvent(c,{cells:b,offset:f}))},handleSingleCellCalculations:function(a,c){var d=this;var b=d.getCanvasCells(a);d.hovercells=b||d.hovercells;var e=MEPH.util.Dom.getEventPositions(a,d.canvas);c=Array.isArray(c)?c:[c];e=e.first();c.foreach(function(f){d.canvas.dispatchEvent(MEPH.createEvent(f,{cells:b,position:e}))})},getHeaderCells:function(a,e){var d=this;var c=MEPH.util.Dom.getPosition(e==="left"?d.leftheader:d.topheader);var f=MEPH.util.Dom.getEventPositions(a,e==="left"?d.leftheader:d.topheader);var b=d.calculateHeaderCells(f,{x:0,y:0},e);return b},getCanvasCells:function(a){var d=this;var c=MEPH.util.Dom.getPosition(d.canvas);var e=MEPH.util.Dom.getEventPositions(a,d.canvas);var b=d.calculateCells(e,{x:0,y:0});return b},getCellPosition:function(a,e){var d=this;var c=0;var b=0;c=d.getCellRowPosition(a,e);b=d.getCellColumnPosition(a,e);return{x:b,y:c}},getCellColumnPx:function(a,c){var b=this;return b.getCellColumnPosition({column:a.column},c)},getCellColumnPosition:function(a,d){var c=this,b=0;if(d=="left"){c.columnHeaderOffsets.subset(c.startLeftColumn,a.column).first(function(e){b+=e})}else{if(c.columnPositions){return c.columnPositions[a.column]-c.columnPositions[c.startColumn]}c.columnOffsets.subset(c.startColumn,a.column).first(function(e){b+=e})}return b},getCellRowPx:function(a,c){var b=this;return b.getCellRowPosition({row:a.row},c)},getCellRowPosition:function(a,d){var c=this;var b=0;if(d=="top"){c.rowHeaderOffsets.subset(c.startTopRow,a.row).first(function(e){b+=e})}else{if(c.rowPositions){return c.rowPositions[a.row]-c.rowPositions[c.startRow]}c.rowOffsets.subset(c.startRow,a.row).first(function(e){b+=e})}return b},getColumnWidth:function(a){var b=this;return b.columnOffsets[a]},getRowHeight:function(b){var a=this;return a.rowOffsets[b]},getColumnHeaderHeight:function(){var a=this;a.cache.columnHeaderHeight=a.cache.columnHeaderHeight||a.rowHeaderOffsets.summation(function(b,c){return c+=b});return a.cache.columnHeaderHeight},getRowsHeaderWidth:function(){var a=this;a.cache.rowHeaderWidth=a.cache.rowHeaderWidth||a.columnHeaderOffsets.summation(function(b,c){return c+=b});return a.cache.rowHeaderWidth},calculateHeaderCells:function(a,d,e){var c=this;var b=a.select(function(f){return{row:c.getRelativeRow(f.y-d.y,e),column:c.getRelativeColum(f.x-d.x,e)}});return b},calculateCells:function(a,d){var c=this;var b=a.select(function(e){return{row:c.getRelativeRow(e.y-d.y),column:c.getRelativeColum(e.x-d.x)}});return b},setStartRow:function(a){if(!isNaN(a)){var b=this;b.startRow=b.setStart(a,b.rowOffsets,b.calculateVertical())}},setStart:function(a,f,g){if(!isNaN(a)){var e=this;var b=g*a;var d=0;var c=0;f.first(function(h,j){d+=h;c=j;return d>b});return c}},setStartColumn:function(a){if(!isNaN(a)){var b=this;b.startColumn=b.setStart(a,b.columnOffsets,b.calculateHorizontal())}},getRelativeRow:function(a,e){var d=this,c=d.startRow,b=d.rowPositions;switch(e){case"top":b=d.rowHeaderPositions;break}var f=d.qvisible(a,c,b,null,d.defaultRowHeight);return f+d.startRow},getRelativeColum:function(b,e){var d=this,a=d.defaultColumnWidth,c=d.columnPositions;switch(e){case"left":a=d.defaultHeaderColumnWidth;c=d.columnHeaderPositions;break}var f=d.qvisible(b,d.startColumn,c,null,a);return f+d.startColumn},calculateVertical:function(){var a=this;a.verticalSize=a.verticalSize||a.rowOffsets.summation(function(b,c){return c+=b});return a.verticalSize},calculateHorizontal:function(){var a=this;a.horizontalSize=a.horizontalSize||a.columnOffsets.summation(function(b,c){return c+=b});return a.horizontalSize},update:function(){var a=this;a.render();a.updateSelectedMouse();a.updateCells()},updateCells:function(){var a=this;if(!a.loaded){return}if(a.updateCellsAnimFrame!==null&&a.updateCellsAnimFrame!==undefined){cancelAnimationFrame(a.updateCellsAnimFrame)}a.updateCellsAnimFrame=requestAnimationFrame(function(){var c=a.getTopHeaderInstructions(a.visibletopheader);if(c){a.topContentRenderer.clear();a.topContentRenderer.draw(c)}c=a.getLeftHeaderInstructions(a.visibleleftheader);if(c){a.leftContentRenderer.clear();a.leftContentRenderer.draw(c)}c=a.getMainContentInstructions(a.visiblegrid);if(c){if(a.enablesvg){a.svgrenderer.clear();var b=a.svgrenderer.draw(c);b.foreach(function(d){a.dun(d.shape);a.don("mouseover",d.shape,function(e){a.dispatchEvent("mouseoveritem",{items:[e.options.relObj],header:null},a.canvas)}.bind(a,d),d.shape)})}else{a.rendererContent.clear();a.rendererContent.draw(c)}}a.updateCellsAnimFrame=null})},drawContent:function(a){var c=this,d;d=c.getMainContentInstructions(c.visiblegrid)||[];if(c.enablesvg){c.svgrenderer.clear();var b=c.svgrenderer.draw(d);b.foreach(function(e){c.dun(e.shape);c.don("mouseover",e.shape,function(f){c.dispatchEvent("mouseoveritem",{items:[f.options.relObj],header:null},c.canvas)}.bind(c,e),e.shape)})}else{c.rendererContent.clear();c.rendererContent.draw(a)}},getTopHeaderInstructions:function(a){},getLeftHeaderInstructions:function(a){},getMainContentInstructions:function(a){},render:function(){var a=this;if(!a.rowOffsets||!a.columnOffsets){return}if(a.animFrame!==null){cancelAnimationFrame(a.animFrame)}a.animFrame=requestAnimationFrame(function(){var g,d,i;if(!a.rendered){a.renderer.setCanvas(a.canvas);a.leftRenderer.setCanvas(a.leftheader);a.topRenderer.setCanvas(a.topheader)}if(!a.body){return}a.lastCanvasSize=a.lastCanvasSize||{};var f=a.body.clientHeight;var e=a.body.clientWidth;var c=a.getLeftCanvasWidth();var b=a.getTopCanvasHeight();f-=b;e-=c;a.calculateVertical();a.calculateHorizontal();if(a.lastCanvasSize.height===f&&a.lastCanvasSize.width===e){}else{a.positionCanvas(a.canvas,c,b,e,f);a.positionCanvas(a.canvascontent,c,b,e,f);a.positionCanvas(a.canvassvg,c,b,e,f);a.positionCanvas(a.leftheader,0,b,c,f);a.positionCanvas(a.leftheadercontent,0,b,c,f);a.positionCanvas(a.topheader,c,0,e,b);a.positionCanvas(a.topheadercontent,c,0,e,b);a.renderer.clear()}var h=a.lastCanvasSize.height===f&&a.lastCanvasSize.width===e;a.drawGrid(f,e,h);a.drawTopGrid(b,e,h);a.drawLeftGrid(f,c,h);a.lastCanvasSize={height:f,width:e};a.animFrame=null})},positionCanvas:function(b,e,d,c,a){Style.left(b,e);Style.top(b,d);Style.width(b,c);Style.height(b,a)},getLeftCanvasWidth:function(){var a=this;a.cache.leftcanvaswidth=a.cache.leftcanvaswidth||(a.columnHeaderOffsets?a.columnHeaderOffsets.summation(function(b,c){return c+=b}):0);return a.cache.leftcanvaswidth},getTopCanvasHeight:function(){var a=this;a.cache.topcanvasheight=a.cache.topcanvasheight||(a.rowHeaderOffsets?a.rowHeaderOffsets.summation(function(b,c){return c+=b}):0);return a.cache.topcanvasheight},drawTopGrid:function(a,b,d){var c=this;c.visibletopheader=c.drawSubGrid(c.topheader,c.rowHeaderOffsets,c.columnOffsets,a,b,c.topRenderer,c.startTopRow,c.startColumn,d)},drawLeftGrid:function(a,b,d){var c=this;c.visibleleftheader=c.drawSubGrid(c.leftheader,c.rowOffsets,c.columnHeaderOffsets,a,b,c.leftRenderer,c.startRow,c.startLeftColumn,d)},drawGrid:function(a,b,d){var c=this;c.visiblegrid=c.drawSubGrid(c.canvas,c.rowOffsets,c.columnOffsets,a,b,c.renderer,c.startRow,c.startColumn,d)},rowDrawInstruction:function(c,a){var b=this;return{shape:MEPH.util.Renderer.shapes.line,end:{x:a,y:c},start:{x:0,y:c},strokeStyle:b.gridlinecolor}},columnDrawInstruction:function(b,a){var c=this;return{shape:MEPH.util.Renderer.shapes.line,end:{x:b,y:a},start:{x:b,y:0},strokeStyle:c.gridlinecolor}},drawSubGrid:function(d,f,b,o,a,j,n,g,m){var k=this;var q=0;var l=function(s){var r=k.rowDrawInstruction(q,a);q+=s;return r};var e=0;var p=function(s){var r=k.columnDrawInstruction(e,o);e+=s;return r};var i=k.visibleRows(o,n);var c=f.subset(n,n+i+1).select(l).where();if(f.length<n+i&&!m){c=c.concat([].interpolate(0,n+i-f.length,function(r){return k.defaultRowHeight}).select(l).where())}var h=k.visibleColumns(a,g);if(!m){c=c.concat(b.subset(g,g+h+1).select(p).where())}if(b.length<g+h&&!m){c=c.concat([].interpolate(0,g+h-b.length,function(r){return k.defaultColumnWidth}).select(p).where())}if(!m){Style.height(d,o);Style.width(d,a);j.draw(c)}return{visibleColumns:h,visibleRows:i,row:n,column:g}},visibleColumns:function(a,c){var b=this;return b.qvisible(a,c,b.columnPositions,null,b.defaultColumnWidth)},visibleRows:function(a,c){var b=this;return b.qvisible(a,c,b.rowPositions,null,b.defaultRowHeight)},qvisible:function(b,a,c,e,k,g,f){var h=this,j;g=g||0;f=f||a;e=e||(c.length-1);var i=Math.floor((e-f)/2)+f;var d=c[i]-c[a];if(g>20){}if((Math.abs(e-f)<=1)){j=i-a}else{if(d>b){j=h.qvisible(b,a,c,i,k,g,f)}else{j=h.qvisible(b,a,c,e,k,g,i)}}return j},onKeyPress:function(a){var c=this,b=MEPH.util.Dom.getCharCode(a);if(c.commands){var d=c.commands.first(function(e){return e.key.toLowerCase()===String.fromCharCode(b).toLowerCase()});if(d){switch(d.command){case"select":c.state===MEPH.table.SpreadSheet.states.Selecting?c.endselect():c.select();break;default:if(d["function"]){d["function"](a)}break}}}},select:function(b){var c=this;if(!c.state){var a=c.hovercells?c.hovercells.first()||c.getCanvasCells(b).first():c.getCanvasCells(b).first();c.selecting={start:a};document.body.classList.add("noselect");c.state=MEPH.table.SpreadSheet.states.Selecting;c.canvas.dispatchEvent(MEPH.createEvent("selectstart",{cell:a}))}},endselect:function(){var a=this;if(a.state===MEPH.table.SpreadSheet.states.Selecting){var b=a.getSelectedStartRow(a.selecting);a.selectedrange=MEPH.clone(a.selecting);if(a.selected){a.selected.clear();if(b){[].interpolate(b.startrow,b.endrow+1,function(c){[].interpolate(b.startcolumn,b.endcolumn+1,function(d){a.selected.push({row:c,column:d})})})}}a.selecting=null;a.state=null}}});
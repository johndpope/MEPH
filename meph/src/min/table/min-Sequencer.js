MEPH.define("MEPH.table.Sequencer",{alias:"sequencer",templates:true,extend:"MEPH.table.SpreadSheet",requires:["MEPH.util.Observable","MEPH.util.Style"],statics:{grabbing:"grabbing"},properties:{grabkeycode:"G",source:null,radius:2,leftHeaderLeftPadding:3,topheadersource:null,leftheadersource:null,grabbeditem:null,timescale:1,time:null,settime:null,rowheader:null,columnheader:null,lane:null,length:null},initialize:function(){var a=this;a.callParent.apply(a,arguments);a.on("altered",function(c,b){if(b.property==="source"){if(b.old){b.old.un(null,a);if(Array.isArray(b.old)){b.old.foreach(function(d){if(MEPH.util.Observable.isObservable(d)){d.un(null,a)}})}}a.onSourceUpdated()}})},onLoaded:function(){var a=this;a.great();a.don("mouseovercell",a.canvas,function(b){a.onMouseOverCell(a.canvas,b)});a.don("mousemovecell",a.canvas,function(b){a.onMouseMoveCell(a.canvas,b)});a.don("mouseoveritem",a.canvas,function(b){a.onMouseOverItem(b)});a.don("mouseovercelltop",a.topheader,function(b){a.onMouseOverCell(a.topheader,b,"top")});a.don("mouseovercellleft",a.leftheader,function(b){a.onMouseOverCell(a.topheader,b,"left")})},onSourceUpdated:function(){var a=this;if(a.source&&MEPH.util.Observable.isObservable(a.source)){a.source.on("changed",a.sourceItemChanged.bind(a),a);a.source.foreach(function(b){if(MEPH.util.Observable.isObservable(b)){b.on("changed",a.sourceItemChanged.bind(a),a)}})}a.updateCells()},sourceItemChanged:function(b,a){var c=this;c.updateCells()},drawSingleDataItem:function(b){var c=this;var a=c.getInstructionsFor(b);if(a){c.drawContent(a)}},getMainContentInstructions:function(b){var c=this;var a=c.getItemsInCellSpace(b).concatFluent(function(d){return(c.getInstructionsFor(d))});return a},getLeftHeaderInstructions:function(b){var c=this;var a=c.getItemsInLeftSpace(b).concatFluent(function(d){return c.getInstructionsForLeft(d)});return a},getTopHeaderInstructions:function(b){var c=this;var a=c.getItemsInTopSpace(b).concatFluent(function(d){return c.getInstructionsForTop(d)});return a},getItemsInCellSpace:function(a){var b=this;return b.getItemInSpace(a,b.source)},getItemsInTopSpace:function(a){var b=this;return b.getItemInSpace(a,b.topheadersource,"top")},getItemsInLeftSpace:function(a){var b=this;return b.getItemInSpace(a,b.leftheadersource,"left")},deleteSelected:function(){var b=this;if(b.selectedrange&&b.selectedrange.end&&b.selectedrange.start){var a=b.getItemInSpace({row:b.selectedrange.start.row,visibleRows:b.selectedrange.end.row-b.selectedrange.start.row,column:b.selectedrange.start.column,visibleColumns:b.selectedrange.end.column-b.selectedrange.start.column},b.source);if(b["delete"]&&b["delete"]["function"]){b["delete"]["function"](a)}}},getItemInSpace:function(h,a,f){var j=[],d,e,c,b,g,i=this;if(h){if(i.time&&i.length&&i.lane&&typeof(i.time["function"])==="function"&&typeof(i.length["function"])==="function"&&typeof(i.lane["function"])==="function"){if(a){a.where(function(k){d=i.time["function"](k);b=i.length["function"](k);e=i.lane["function"](k);g=i.getScaled(d);c=g+i.getScaled(b);var o=h.row<=e&&e<=h.visibleRows+h.row;var m=h.column<=g&&g<=h.visibleColumns+h.column;var n=h.column<=c&&c<=h.visibleColumns+h.column;var p=(m&&o);var l=(n&&o);if((p||l)&&!f){return true}else{if(f==="left"){return o}else{if(f==="top"){return m}}}return false}).foreach(function(k){j.push(k)})}}}return j},getScaled:function(b){var a=this;return b/a.timescale},unscaleValue:function(b){var a=this;return b*a.timescale},getInstructionsFor:function(a){var c=this,b;a=Array.isArray(a)?a:[a];return a.select(function(d){b=c.getItemMetrics(d);b.shape=MEPH.util.Renderer.shapes.rectangle;b.radius=c.radius;return b})},getInstructionsForLeft:function(a){var d=this,c;c=d.getItemMetrics(a,"left");var b=d.rowheader&&d.rowheader["function"]?d.rowheader["function"](a):null;if(b===null){}else{if(typeof b==="string"){c.font="12px Arial";c.textAlign="left";c.x+=d.leftHeaderLeftPadding;c.y=d.getCellRowPx(c,"left");c.textBaseline="top";c.shape=MEPH.util.Renderer.shapes.text;c.text=b;return[c]}else{console.log("Unhandled: ")}}return[]},getInstructionsForTop:function(a){var d=this,c;c=d.getItemMetrics(a,"top");var b=d.columnheader&&d.columnheader["function"]?d.columnheader["function"](a):null;if(b===null){}else{if(typeof b==="string"){c.font="12px Arial";c.textAlign="left";c.x+=d.leftHeaderLeftPadding;c.y=d.getCellRowPx(c,"top");c.textBaseline="top";c.shape=MEPH.util.Renderer.shapes.text;c.text=b;return[c]}else{console.log("Unhandled: ")}}return[]},getItemMetrics:function(l,g){var j=this;var e=j.lane["function"](l,g);var d=j.time["function"](l,g);var c=j.length["function"](l);var h=j.getScaled(d);var f=Math.floor(h);var k=j.getCellPosition({row:e,column:f},g);var b=j.getColumnWidth(f);var i=(h-f)*b;var a=j.getScaled(c)*b;var m=j.getRowHeight(e);return{x:k.x+i,y:k.y,width:a,fillStyle:j.color&&j.color["function"]?j.color["function"](l):"#ff0000",height:m,column:f,row:e,relObj:l}},onMouseOverCell:function(d,b,h){var e,g,f=this;if(!h&&f.enablesvg){return}var a=b.cells.first();var c;switch(h){case"left":g=f.getItemsInLeftSpace.bind(f);break;case"top":g=f.getItemsInTopSpace.bind(f);break;default:g=f.getItemsInCellSpace.bind(f);break}c=g({row:a.row,column:a.column,visibleRows:1,visibleColumns:1});c=c.where(function(i){e=f.getItemMetrics(i);return(b.position.x>=e.x&&b.position.x<=e.x+e.width&&b.position.y>=e.y&&b.position.y<=e.y+e.height)});f.dispatchEvent("mouseoveritem",{items:c,header:h},d)},onMouseMoveCell:function(d,c){var f=this;if(f.state===MEPH.table.Sequencer.grabbing){var b=f.lane["function"](f.grabbeditem);var g=Math.min(parseFloat(d.clientHeight),Math.max(0,f.getCellRowPx({row:b})))+f.topheader.clientHeight;var a=c.position.x;var e=f.getItemMetrics(f.grabbeditem);f.lastgrabposition={x:a,y:g};f.positionGrabRep({x:a+(parseFloat(f.leftheader.clientWidth)||0),y:g,width:e.width,height:e.height})}},dispatchEvent:function(d,b,a){var c=this;a.dispatchEvent(MEPH.createEvent(d,b))},onMouseOverItem:function(b){var a=this;switch(b.header){case"left":case"top":break;default:a.lastitem=b.items.first()||a.lastitem;break}},grab:function(b){var a=this;if(a.settime&&typeof(a.settime["function"])==="function"&&!a.state){a.state=MEPH.table.Sequencer.grabbing;a.grabbeditem=b;if(a.grabrep){Style.show(a.grabrep)}return true}else{return false}},ungrab:function(f){var e=this;if(e.grabbeditem===f&&e.state===MEPH.table.Sequencer.grabbing){e.grabbeditem=null;if(e.grabrep){var a=MEPH.util.Dom.getRelativePosition(e.grabrep,e.canvas);var d=e.getRelativeColum(a.x);var c=e.getCellColumnPosition({column:d});var h=(e.lastgrabposition.x-c)/e.getColumnWidth(d);var g=d+h;g=Math.max(0,g);var b=e.unscaleValue(g);e.settime["function"](b,f);Style.hide(e.grabrep)}e.state=null}},onKeyPress:function(a){var c=this,b=MEPH.util.Dom.getCharCode(a);if(String.fromCharCode(b).toLowerCase()===c.grabkeycode.toLowerCase()){if(c.lastitem){if(c.state===null){c.grab(c.lastitem)}else{if(c.state===MEPH.table.Sequencer.grabbing){c.ungrab(c.grabbeditem)}}}}else{c.great()}},positionGrabRep:function(a){var b=this;Style.height(b.grabrep,a.height);Style.width(b.grabrep,a.width);Style.left(b.grabrep,a.x);Style.top(b.grabrep,a.y)}});
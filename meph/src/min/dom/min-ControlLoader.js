MEPH.define("MEPH.dom.ControlLoader",{requires:["MEPH.util.Dom","MEPH.bind.Binder"],statics:{getTemplateDom:function(c){var b=this,d=b.getUnattachedDiv(),a;d.innerHTML=c.template;a=MEPH.util.Array.convert(d.childNodes);return a},getUnattachedDiv:function(){return document.createElement("div")}},properties:{MEPHUniqueId:"mephuniqueid",MEPHId:"mephid"},initialize:function(){var a=this},generateBoundControls:function(b){var a=this;MEPH.Array(b);return b.select(function(c){return a.generateBoundControl(c)})},generateBoundControl:function(b){var a=this;MEPH.Binder.bindObject(b.classInstance,b.templateNode);MEPH.Binder.bindControlPackage(b);return b},loadSubControls:function(b,a){var e=this,d,c;c=MEPH.Array(b).select(function(g){d=(e.loadSubControl(g,a));d=(e.appendResultsToControl(g,a,d));return(e.processSubControls(g,a,d))});var f=b.classInstance;if(f&&f.fire){f.fire("subcontrolsloaded")}return b},processSubControls:function(d,a,e){var c=this,b;b=MEPH.Array(e).select(function(f){d.classInstance.addSubControl(f.classInstance);return(c.processSubControl(d,a,f))});return b},processSubControl:function(e,b,d){var c=this,a;return(c.loadSubControls([d],b))},appendResultsToControl:function(d,a,e){var c=this,b;b=MEPH.Array(e).select(function(f){return(c.appendResultToControl(d,a,f))});return e},appendResultToControl:function(f,b,e){var c=this,d,a,g;if(e&&e.controlObject&&e.controlObject.node){a=e.controlObject;g=a.node;d=f.templateNode.where(function(h){if(h.nodeType===MEPH.util.Dom.textType){return false}return true}).select(function(h){return(h.querySelector(a.alias+"["+c.MEPHUniqueId+'="'+e.classInstance.getUniqueId()+'"]'))}).first();if(d===null){d=f.templateNode.first(function(h){return h.getAttribute(c.MEPHUniqueId)===e.classInstance.getUniqueId()})}if(d){c.manageConnectionBetween(f,e,g);MEPH.Binder.bindControl(f.classInstance,e.classInstance,g);MEPH.Binder.bindDomControl(f,e,g);e.templateNode.foreach(function(h){MEPH.util.Dom.insertBefore(g,h)});MEPH.util.Dom.removeFromDom(g)}else{throw"subnode not found: MEPH.dom.ControlLoader.js"}}else{throw"cannot append result to control if custom tag node is gone"}return f},manageConnectionBetween:function(f,e,g){var c=this,a=e.classInstance,d=f.classInstance,b;a.addReferenceConnection(MEPH.control.Control.connectables.subcontrol,d);a.addReferenceConnection(MEPH.control.Control.connectables.self,a);if(!a.parent){Object.defineProperty(a,"parent",{enumerable:false,writable:true,configurable:true,value:d})}b=g.getAttribute(c.MEPHId);if(b){Object.defineProperty(d,b,{enumerable:false,writable:false,configurable:false,value:a});Object.defineProperty(d,MEPH.privatePropertyPrefix+MEPH.privateClassPrefix+b,{enumerable:false,writable:false,configurable:false,value:a});Object.defineProperty(d,MEPH.privatePropertyPrefix+b,{enumerable:false,writable:false,configurable:false,value:e.templateNode})}},loadSubControl:function(f,c){var e=this,g,b,d=f.templateNode,a;a=MEPH.Binder.getSubObjects(d,1).select(function(h){var i=MEPH.getTemplateByNode(h);return{node:h,alias:i.alias}});g=e.loadControls(a,f.classInstance,c);b=e.generateBoundControls(g);return e.loadSubControls(b,c)},loadControls:function(a,d,b){var e=this,c;c=MEPH.util.Array.create(a).select(function(f){return(e.loadControl(f,d,b))});return e.bindObjectReferences(d,b,c)},bindObjectReferences:function(d,b,a){var e=this,c;c=MEPH.Array(a).select(function(f){return e.bindObjectReference(d,b,f)});return c},bindObjectReference:function(h,f,c){var e=this,j=Promise.resolve(),i,b=c.controlObject,a=[],g;templateNode=c.templateNode,classInstance=c.classInstance;if(b&&templateNode&&classInstance){i=h?h.getReferenceConnections():[];g=e.getObjectReferences(b.node);i.foreach(function(k){classInstance.addReferenceConnectionObj(k);if(!a.some(function(l){return k.type===l.type})&&k.type!=="control"&&k.type!=="subcontrol"){a.push({type:k.type,instance:k.obj})}});if(b.node){var d=e.getNodeInstanceReferences(b.node);if(d.length){g=g||[];d.foreach(function(k){g.removeWhere(function(l){return l.type===k.type})});d.foreach(function(k){g.push(k)})}}if(g){MEPH.Array(g);g.foreach(function(k){classInstance.removeReferenceConnection(k.type)});g.foreach(function(l){var k=new l.classDefinition();if(f){f.addInstance(k)}if(!a.some(function(m){return m.type===l.type})&&l.type!=="control"&&l.type!=="subcontrol"){a.push({type:l.type.type,instance:k})}classInstance.addReferenceConnection(l.type,k,true)})}a.foreach(function(k){a.foreach(function(l){if(k.instance.isReferrerable){k.instance.addReferenceConnection(l.type,l.instance)}});if(k.instance.fire){k.instance.fire("referencesbound")}});if(classInstance.fire){classInstance.fire("referencesbound")}return c}else{throw"missing argument : ControlLoader.bindObjectReference"}},getNodeInstanceReferences:function(b){var a=this;return MEPH.Array(b.attributes).where(function(c){return c.name.startsWith("ref-")}).select(function(c){return{type:c.name.split("").subset(4).join(""),classDefinition:MEPH.getDefinedClass(b.getAttribute(c.name))}})},hasReferences:function(b){var a=b.getAttribute(MEPH.dataObjectReferenceAttribute);return a!==null&&a!==undefined},getObjectReferences:function(e){var l=this,f=MEPH.util.Dom,p,a,g,o,h,p,m=[],d,j,c,k,n,q=Promise.resolve(),b;b=e.getAttribute(MEPH.dataObjectReferenceAttribute);if(b){p=f.tryParseAttributeJson(b);for(g in p){if(p.hasOwnProperty(g)){a=MEPH.getBindPrefixShortCut(g);h=p[g];d=MEPH.getDefinedClassInformation(h);c=MEPH.getPathValue(d?d.classifiedName:h);n=g;k=MEPH.getBindPrefixShortCut(n);if(k){k=k.type}m.push({key:n,type:k,classDefinition:c})}}return(m)}else{p=null;return null}return q},loadControl:function(d,h,g){var f=this,j,a=MEPH.getDefinedClassInformation(d.alias)||MEPH.getTemplate(d.alias),c,e,i=Promise.resolve(),b;if(a){b=MEPH.getDefinedClass(a.classifiedName);if(b){e=new b(d.injections||null);e.setUniqueId(MEPH.GUID());if(d.view){e.addReferenceConnection("view",e,true)}if(g){e.setApplication(g);g.addControl(e)}if(e.fire){e.fire("init")}d.node.setAttribute(f.MEPHUniqueId,e.getUniqueId());if(e.setInstanceTemplate){e.setInstanceTemplate(d.node);if(e.fire){e.fire("setinstancetemplate")}}c=e.getGeneratedTemplateDom();e.setDomTemplate(c);if(e.fire){e.fire("setdomtemplate")}j={controlObject:d,templateNode:c,classInstance:e};e.setControlObject(j);return j}else{throw"unhandled occurence in ControlLoader.js"}}else{throw"Template information not found"}},getTemplateDom:function(c){var b=this,d=b.getUnattachedDiv(),a;d.innerHTML=c.template;a=MEPH.util.Array.convert(d.childNodes);return a},getUnattachedDiv:function(){return document.createElement("div")}});
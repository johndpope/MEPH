MEPH.define("MEPH.bind.Binder",{requires:["MEPH.util.Dom"],statics:{events:{altered:"altered",domevent:"domevent"},isOnPath:function(b,a){return b.indexOf(a)!==-1}},properties:{MEPHId:"mephid",$bindPromise:null},initialize:function(){var a=this;a.$bindPromise=Promise.resolve()},bindObject:function(b,g){var c=this,e,f,a={},d={};e=c.getDomObjectsForBinding(g);e.foreach(function(h){var i=h.getAttribute(c.MEPHId);if(i){Object.defineProperty(b,i,{enumerable:false,writable:false,configurable:false,value:h})}d=c.parseDomAttributes(h);c.addObjectDomEvent(h,b);c.addEventListeners(d,b,h);if(d){f=c.reverseInstructions(d,b,h);c.addEventListeners(f,b,b)}})},bindControlPackage:function(e){var b=this,g=MEPH.bind.Binder,h,f=e.controlObject.node,d,a=b.parseDomAttributes(f,MEPH.getEventDataBindingPrefixes(),MEPH.defaultEventPrefix),c=b.parseDomAttributes(f,null,null,e.classInstance);if(c&&e.classInstance.isReferrerable){e.classInstance.getReferenceConnections().foreach(function(i){if(i.type!=="control"&&i.type!=="subcontrol"){h=b.trimInstructions(c,i.type);if(h){b.addPackageListeners(h,i.obj,e.classInstance);d=b.reverseInstructions(h,e.classInstance,i.obj);if(d){b.addEventListeners(d,e.classInstance,i.obj)}}}})}if(a){}},trimInstructions:function(f,d){var e=this,b,a=false,c;if(!f){return false}for(c in f){if(f.hasOwnProperty(c)){b=e.parseInstructionString(f[c]).first();if(b.shortCut&&d===b.shortCut.type){a=a||{};a[c]=f[c]}}}return a},addPackageListeners:function(c,g,h){var m=this,a,e,l,j,o=MEPH.bind.Binder,k=o.events.altered,d,b,n=m.getConnectableTypes(g),f;if(!c){return}g.on(k,function(q,p){var i;for(f in c){if(c.hasOwnProperty(f)){d=c[f];e=m.parseInstructionString(d,g);a=e.first();if(n.some(function(r){return r===a.shortCut.type})){l=m.getConnection(h,a.shortCut.type);i=a.path.subset(1).join(".");if(l&&o.isOnPath(i,p.path)){m.executeInstructions(h,i,k,e,g,f,false,p)}}}}},g)},addObjectDomEvent:function(f,b){var c,d=this,e=MEPH.bind.Binder,a;a=d.parseDomAttributes(f,MEPH.getEventDataBindingPrefixes(),MEPH.defaultEventPrefix);for(c in a){f.addEventListener(c,function(g,h){b.fire(e.events.domevent,{eventType:g,domEvent:h})}.bind(d,c))}d.addDomEventListeners(a,b,b)},reverseInstructions:function(c,j,e){var h=this,g,l={},k,f,a,d,b;if(!c){return false}for(g in c){if(MEPH.mephHasOwnProperty(c,g)){if(c[g].indexOf(MEPH.pipeString)===-1){k=MEPH.Array(c[g].trim().split(MEPH.pathDelimiter));b=k.first();if(b){f=MEPH.getBindPrefixShortCut(b);if(f){d=j.getConnection(f.type);a=MEPH.getBindPrefixShortCuts().first(function(i){return i.type==="self"}).prefix;l[k.subset(1).join(MEPH.pathDelimiter)]=a+MEPH.pathDelimiter+g}}else{throw"MEPH.bind.Binder : no reference type found"}}}}return l},bindControl:function(g,h,c){var e=this,b,d,i,f,a;a=e.parseDomAttributes(c,null,null,h);f=e.reverseInstructions(a,g,h);b=e.parseDomAttributes(c,MEPH.getReverseDataBindingPrefixes(),MEPH.defaultReversePrefix);MEPH.apply(b,f);if(a){i=e.trimInstructions(a,"control");e.addEventListeners(i,g,h)}if(f){e.addEventListeners(f,h,g)}},bindDomControl:function(e,d,g){var c=this,b,f=MEPH.bind.Binder,a;a=c.parseDomAttributes(g,MEPH.getEventDataBindingPrefixes(),MEPH.defaultEventPrefix);for(b in a){d.templateNode.where(function(h){return h.nodeType===MEPH.util.Dom.elementType}).foreach(function(h){h.addEventListener(b,function(i,j){j.stopPropagation();if(!j.cancelled){d.classInstance.fire(f.events.domevent,{eventType:i,domEvent:j})}}.bind(c,b))})}c.addDomEventListeners(a,d.classInstance,e.classInstance)},addDomEventListeners:function(a,e,c){var g=this,f,b,d,j=MEPH.bind.Binder,h=j.events.domevent;if(!a){return}e.on(h,function(l,k,i){for(f in l){if(i.eventType===f){if(l.hasOwnProperty(f)){b=l[f];d=g.parseInstructionString(b,e);g.executeInstructions(c,null,h,d,c,f,true,i)}}}}.bind(g,a));e.bindingInformations=e.bindingInformations||[];e.bindingInformations.push(a)},addEventListeners:function(e,k,o){var u=this,p,a,v,j,r=MEPH.bind.Binder,t=r.events.altered,c,f,m=u.getConnectableTypes(k),n;if(!e){return}var l=[];for(var s in e){var p=u.parseInstructionString(e[s],k);if(p){var d=p.first();if(d){var g=d.shortCut.type;var h=k.getReferenceConnections().first(function(b){return b.type===g});if(!h){continue}if(!l.some(function(b){return b.type===g})){l.push({type:g,ref:h.obj,bindingInformation:{}})}var q=l.first(function(b){return b.type===g});q.bindingInformation[s]=e[s]}}}if(l.length===0){l.push({ref:k,bindingInformation:e})}l.foreach(function(b){b.ref.on(t,function(x,y,F){var A;try{for(var C in x){var z=x[C];if(z){var B=u.parseInstructionString(z,k);var w=B.first();if(m.some(function(i){return i===w.shortCut.type})){var E=u.getConnection(k,w.shortCut.type);A=w.path.subset(1).join(".");if(E&&r.isOnPath(A,F.path)){u.executeInstructions(o,A,t,B,k,C,false,F)}}}}}catch(D){console.log(D)}}.bind(u,b.bindingInformation),b.ref)})},getValuesOfParameter:function(c,d){var b=this,a;return(c||[]).select(function(f){var e;if(f&&f.shortCut&&b.getConnection(d,f.shortCut.type)){if(f.shortCut.type==="subcontrol"){e=MEPH.getPathValue(f.path.subset(1).join("."),d)}else{e=MEPH.getPathValue(f.path.subset(1).join("."),b.getConnection(d,f.shortCut.type))}return e}else{return f.value}})},executeInstructions:function(d,a,b,e,f,g,h,j){var i=this,c=e?e.length:0,k;k=i.$bindPromise.then(function(){var n,m,l=e.first();if(l.shortCut.type==="subcontrol"){m=MEPH.getPathValue(l.path.subset(1).join("."),f)}else{m=MEPH.getPathValue(l.path.subset(1).join("."),i.getConnection(f,l.shortCut.type))}return m});e.foreach(function(l,m){var o=i.getConnection(f,l.shortCut.type),n;k=k.then(function(t,q,p){var u,s=l.path.subset(1).join(".");n=MEPH.getPathValue(s,t);if(typeof(n)==="function"){var r=i.getValuesOfParameter(l.params,f);r=r.concat([p,d,a,b,e,f,j]);return n.apply(t,r)}else{if(c>1){u=MEPH.setPathValue(t,s,p);if(!u){throw"Unable to set path : "+s}}return p}return MEPH.getPathValue(s,t)}.bind(i,o,m))});if(!h){k=k.then(function(l){i.setValueOnDom(l,d,g)})}k=k["catch"](function(l){MEPH.Log(l);throw l});i.$bindPromise=k;return i.$bindPromise},setValueOnDom:function(a,b,c){if(b){if(MEPH.util.Dom.elementType===b.nodeType){switch(c){case"type":case"for":case"step":case"max":case"min":b.setAttribute(c,a);break;case"class":MEPH.util.Array.convert(b.classList).foreach(function(d){b.classList.remove(d)});if(a){MEPH.Array(a.split(" ")).select(function(d){return d.trim()}).where(function(d){return d}).foreach(function(d){b.classList.add(d)})}break;case"innerHTML":MEPH.setPathValue(b,c,a);break;case"nothing":break;default:b.setAttribute(c,a);break}}else{switch(c){default:MEPH.setPathValue(b,c,a);break}}}},getConnection:function(c,a){var b=this;return c.getConnection(a)},getConnectableTypes:function(b){var a=this;return b.getConnectableTypes()},getSubObjects:function(e,d){var c=this,a=[],b;if(d===0){return a}if(e.length!==undefined&&e.nodeType!==MEPH.util.Dom.textType&&e.nodeType!==MEPH.util.Dom.commentType){a=MEPH.Array(e).concatFluentReverse(function(f){return MEPH.Array(c.getSubObjects(f,d))})}else{if(e.nodeType!==MEPH.util.Dom.elementType){return a}else{b=MEPH.getTemplateByNode(e);if(b){a.push(e);a=a.concat(c.getSubObjects(e.childNodes,d-1))}else{a=a.concat(c.getSubObjects(e.childNodes,d))}}}return MEPH.Array(a).where(function(f){return f})},getDomObjectsForBinding:function(d){var c=this,a=[],b;if(d.length!==undefined&&(d.nodeName?d.nodeName.toLowerCase()!=="select":true)&&d.nodeType!==MEPH.util.Dom.textType&&d.nodeType!==MEPH.util.Dom.commentType){a=MEPH.Array(d).concatFluentReverse(function(e){return c.getDomObjectsForBinding(e)})}else{if(d.nodeType!==MEPH.util.Dom.elementType){return a}else{b=MEPH.getTemplateByNode(d);if(b){return a}else{a.push(d);a=a.concat(c.getDomObjectsForBinding(d.childNodes))}}}return MEPH.Array(a)},parseInstructionString:function(c,d){var f=this,g,b,e,a;a=MEPH.Array(c.split(MEPH.pipeString)).select(function(h){return h.trim()}).select(function(j){var h=j.split(MEPH.ParameterDelimiter).trim().first();var k=j.split(MEPH.ParameterDelimiter).trim().subset(1);var i=MEPH.Array(h.split(MEPH.pathDelimiter)),m,l;l=i.first();e=MEPH.getBindPrefixShortCuts().first(function(n){return n.type==="subcontrol"});if(l.startsWith(e.prefix)){g=l.substr(e.prefix.length,l.length);l=l.substr(0,e.prefix.length);i=MEPH.Array([l].concat(i.subset(1)))}m=MEPH.getBindPrefixShortCuts().first(function(n){return n.prefix===l});if(d&&d.getReferenceConnections){b=d.getReferenceConnections().first(function(n){return n.type===l});if(b){m=b}}return{path:i,uniqueId:g,shortCut:m,params:f.getParameters(j,d)}});return a},getParameters:function(b,c){var g=this,a,h,f=MEPH.getBindPrefixShortCuts().first(function(i){return i.type==="subcontrol"}),d=[],e=b.split(MEPH.ParameterDelimiter).trim().subset(1);return e.select(function(i){a=i.split(MEPH.pathDelimiter);shortCut=a.first();if(shortCut.startsWith(f.prefix)){h=shortCut.substr(f.prefix.length,shortCut.length);shortCut=shortCut.substr(0,f.prefix.length);a=MEPH.Array([shortCut].concat(a.subset(1)))}prefixShortCut=MEPH.getBindPrefixShortCuts().first(function(j){return j.prefix===shortCut});if(c&&c.getReferenceConnections){reference=c.getReferenceConnections().first(function(j){return j.type===shortCut});if(reference){prefixShortCut=reference}}return{path:a,uniqueId:h,shortCut:prefixShortCut,value:i}})},parseDomAttributes:function(c,f,i,j){var h=this,d,b,g,e,a={};e=f||MEPH.getDataBindPrefixes();d=MEPH.util.Array.convert(c.attributes||[]).select(function(k){return k.name||k.nodeName});var g=d.where(function(k){return k!==(MEPH.defaultDataBindString||k!==MEPH.defaultReversePrefix||k!==MEPH.defaultEventPrefix)}).select(function(l){var k,m=e.first(function(n){return l.startsWith(n+MEPH.bindPrefixDelimiter)});k=l.after(m+MEPH.bindPrefixDelimiter);return{prefix:m,property:k}});if(d.some(function(k){return k===MEPH.defaultDataBindString||k===MEPH.defaultReversePrefix||k!==MEPH.defaultEventPrefix})){b=c.getAttribute(i||MEPH.defaultDataBindString);a=b?MEPH.util.Dom.tryParseAttributeJson(b):false}if(j){if(j.getListOfTransferableAttributes){j.getListOfTransferableAttributes().where(function(k){return d.some(function(l){return l===k.name.toLowerCase()})}).foreach(function(k){g.push({prefix:"",property:k.name})})}if(j.getAutoBindProperties&&j.getAutoBindPropertyPath){j.getAutoBindProperties().where(function(k){return d.some(function(l){return l===k.property.toLowerCase()})}).foreach(function(k){c.setAttribute(k.autoProperty,j.getAutoBindPropertyPath(k.property,k.autoProperty));g.push({prefix:"",property:k.autoProperty})})}}g.foreach(function(k){var l,m;l=k.prefix?(k.prefix+MEPH.bindPrefixDelimiter+k.property):k.property;m=c.getAttribute(l?l.toLowerCase():l);if(m){a=a||{};a[k.property]=m}});if(a&&Object.keys(a).length>0){return a}return false}}).then(function(){MEPH.Binder=new MEPH.bind.Binder()});
MEPH.define("MEPH.mobile.activity.ActivityController",{requires:["MEPH.Constants","MEPH.mobile.services.MobileServices","MEPH.mobile.mixins.Activity"],statics:{viewProvider:"viewProvider"},properties:{activities:null,activityHolder:null,currentActivity:null,tokens:null,openActivityOnStop:true,$appPath:null,activityControllerPromise:null},initialize:function(){var a=this;a.activityControllerPromise=Promise.resolve();a.tokens=[];a.activities=[];a.tokens.push(MEPH.subscribe(MEPH.Constants.startView,a.onStartView.bind(a)));a.tokens.push(MEPH.subscribe(MEPH.Constants.showView,a.onShowView.bind(a)));a.tokens.push(MEPH.subscribe(MEPH.Constants.closeView,a.onCloseActivity.bind(a)));a.tokens.push(MEPH.subscribe(MEPH.Constants.OPEN_ACTIVITY,a.onOpenActivity.bind(a)));a.listenToStatePop()},setAppPath:function(a){var b=this;b.$appPath=a},getAppPath:function(){var a=this;return a.$appPath||""},listenToStatePop:function(){var a=this;MEPH.Events(a);a.don("popstate",window,a.onPopState.bind(a))},onPopState:function(d){var a=this,b=d.state,c;MEPH.Log("on pop state ");if(b){c=a.getActivity(b.activityId);a.activityControllerPromise=a.activityControllerPromise.then(function(){if(c){MEPH.Log("showing an activity");return a.showActivity(c)}else{MEPH.Log("start activity from path.");return a.startActivityFromPath(b.path,false)}})["catch"](function(f){MEPH.Log(f)});return a.activityControllerPromise}return Promise.resolve()},startActivityFromPath:function(a,c){var b=this;if(!a){return Promise.resolve()}return MEPH.MobileServices.get(MEPH.mobile.activity.ActivityController.viewProvider).then(function(d){if(d){return d.getViews().then(function(f){var e=f.first(function(g){return g.path===a});if(e){return b.startActivity(e).then(function(g){if(c){var h=g.classInstance;b.pushState(b.$window,{activityId:h.getActivityId(),path:h.getPath()},"",b.getCombinedPath(h.getPath()))}return g})}return Promise.resolve()})}}).then(function(){MEPH.Log("activity started from path.")})["catch"](function(d){MEPH.Log("activity failed to start.");throw d})},replaceState:function(c,d,a,b){c.history.replaceState((d),a,b)},pushState:function(c,d,a,b){c.history.pushState((d),a,b)},getPath:function(a){if(a){if(a.path){return a.path}}return null},getActivityName:function(a,b){return""},setApplication:function(a){var b=this;b.application=a;b.application.on("controladded",b.onControlAdded.bind(b))},onControlAdded:function(a,c){var b=this;if(c&&c.isActivity){b.addActivity(c)}},getApplication:function(){var a=this;return a.application},setActivityHolder:function(a){var b=this;b.activityHolder=a},getActivityHolder:function(){var a=this;return a.activityHolder},onStartView:function(b,a){var c=this;MEPH.Log("onstartview");c.activityControllerPromise=c.activityControllerPromise.then(function(){return c.startActivity(a)["catch"](function(){MEPH.Log.apply(MEPH,arguments)})})["catch"](function(d){MEPH.Log(d)}).then(function(){MEPH.Log("view started")})},onShowView:function(b,a){var c=this;c.activityControllerPromise=c.activityControllerPromise.then(function(){return c.showActivity(a.activity).then(function(d){if(a.activity.getActivityPath()){c.pushState(c.$window,{activityId:a.activity.getActivityId(),path:a.activity.getActivityPath()},"",c.getCombinedPath(a.activity.getActivityPath()))}return d})})["catch"](function(d){MEPH.Log(d)});return c.activityControllerPromise},onCloseActivity:function(b,a){var c=this;c.activityControllerPromise=c.activityControllerPromise.then(function(){return c.closeActivity(a.activity)})["catch"](function(d){MEPH.Log(d)}).then(function(){c.setCurrentActivity(null)})},getCombinedPath:function(c){var b=this;try{return"/"+MEPH.Array(b.getAppPath().split("/").concat(c.split("/"))).where(function(d){return d}).join("/")}catch(a){MEPH.Log(a);return""}},onOpenActivity:function(b,a){var c=this;return c.openOrCreateActivity(a,null)},openOrCreateActivity:function(b,a){var c=this;c.activityControllerPromise=c.activityControllerPromise.then(function(){var e,f=c.getActivity(b);var d=c.getCurrentActivity();if(f){f.setActivityArguments(b);e=c.openActivity(f).then(function(g){c.pushState(c.$window,{activityId:f.getActivityId(),path:f.getActivityPath()},"",c.getCombinedPath(f.getActivityPath()));return f})}else{e=c.startActivity(b,a).then(function(g){var h=g.classInstance;return h})}return e})},startActivity:function(b,a){var d=this,c=d.getCurrentActivity();return Promise.resolve().then(function(){if(c){return c.initHide()}}).then(function(){d.setCurrentActivity(null);return d.createActivity(b).then(function(f){var e=f.first();e.classInstance.setActivityArguments(b);d.addActivity(e.classInstance,b.parentActivity||null);if(d.openActivityOnStop){return d.showActivity(e.classInstance).then(function(){return e})}return e}).then(function(e){var h=e.classInstance,f="",g=d.getPath(b);if(g!==null){f=d.getCombinedPath(a||g);h.setPath(a||g);d.pushState(d.$window,{activityId:h.getActivityId(),path:a||g},d.getActivityName(b,h),f)}if(e.classInstance.afterShow){e.classInstance.afterShow()}MEPH.publish(MEPH.Constants.ActivityStarted,{activity:h});return e})["catch"](function(e){MEPH.Log(e)})})},createActivity:function(a){var c=this,b=MEPH.mobile.activity.ActivityController,d=Promise.resolve();d=d.then(function(){return MEPH.MobileServices.get(b.viewProvider).then(function(e){return e.getView(a)})}).then(function(e){var f;if(e){f=MEPH.Array(MEPH.patternTypes).where(function(g){if(e){return e.hasOwnProperty(g)}return null}).select(function(g){return e[g]})}else{throw"no view config passed"}f=f||[];return MEPH.requires.apply(MEPH,f).then(function(){if(e){var g=MEPH.getDefinedClassInformation(e.view);e.alias=g.alias;e.patterns=f;return e}return null})}).then(function(g){var e,f=c.getApplication(),j=a.positionDom||c.getActivityHolder(),i=document.createElement(g.alias),h=MEPH.Array(MEPH.patternTypes).where(function(k){return g.hasOwnProperty(k)});e=h.where(function(k){return k!=="view"}).select(function(k){return'"'+k+'" :  "'+g[k]+'" '}).join(",");i.setAttribute(MEPH.dataObjectReferenceAttribute,e);return f.loadViewObject([{node:i,alias:g.alias,view:true}],j).then(function(k){k.foreach(function(l){l.classInstance.$viewConfiguration=l.classInstance.$viewConfiguration||g});return k})});return d},getAncestorActivities:function(c){var b=this,c,a=[];activityStructure=b.getActivities().first(function(d){return d.activity===c});if(activityStructure&&activityStructure.parent){a.push(activityStructure.parent);a=a.concat(b.getAncestorActivities(activityStructure.parent))}else{if(!activityStructure){throw"no activity found : ActivityController"}}return MEPH.Array(a)},showActivity:function(c){if(typeof(c)==="string"){c=this.getActivity(c)}var b=this,d=Promise.resolve(),a=b.getCurrentActivity();if(!c){return d}if(c===a){return d}if(a){d=d.then(function(){return a.initHide({activityToBeShown:c})})}d=d.then(function(){return c.initShow()}).then(function(e){if(e.success){b.setCurrentActivity(c)}return e});return d},closeActivity:function(c){var b=this,d=Promise.resolve(),a=b.getCurrentActivity();d=d.then(function(){return c.initClose()}).then(function(e){if(e.success){if(c===a){b.setCurrentActivity(null)}}return e});return d},openActivity:function(c){var b=this,d=Promise.resolve(),a=b.getCurrentActivity();if(a){d=d.then(function(){return a.initHide({activityToBeShown:c})})}d=d.then(function(){return c.initOpen()}).then(function(e){if(e.success){b.setCurrentActivity(c)}if(c.afterShow){c.afterShow()}return e});return d},getCurrentActivity:function(){var a=this;return a.currentActivity},setCurrentActivity:function(b){var a=this;a.currentActivity=b},addActivity:function(c,b){var a=this,d=a.getActivities().first(function(e){return e.activity===b});if(c.isActivity()&&!a.activities.some(function(e){return e.activity.getActivityId()===c.getActivityId()})){if(MEPH.IsEventable(c)){c.on("destroy",a.onActivityDestroy.bind(a,c))}a.activities.push({activity:c,parent:b?b:null})}},onActivityDestroy:function(d,a){var b=this,c;c=b.removeActivity(d);if(c.length){MEPH.publish(MEPH.Constants.ActivityDestroyed,{})}},setActivityParent:function(c,b){var a=this,d;d=a.getActivities().first(function(e){return e.activity===c});if(d){d.parent=b}},removeActivity:function(b){var a=this;return a.activities.removeWhere(function(c){return c.activity===b})},getActivity:function(c){var a=this,b;b=a.getActivities().first(function(d){if(typeof c==="object"){if(d.activity.$viewConfiguration.viewId!==c.viewId){return false}return true}return d.activity.getActivityId()===c});if(b){return b.activity}return null},getActivities:function(){var a=this;return a.activities}});
MEPH.define("MEPH.mobile.providers.identity.FacebookProvider",{alternateNames:["FacebookProvider"],extend:"MEPH.mobile.providers.identity.IdentityProvider",properties:{},statics:{key:"facebook",maxWaitTime:10000,login:function(){return new Promise(function(b,c){var a=setTimeout(function(){b(false)},FacebookProvider.maxWaitTime);FB.getLoginStatus(function(d){if(d.status!=="connected"){FB.login(function(e){FacebookProvider.response=e;MEPH.publish(MEPH.Constants.provider.IDENTITY_STATUS_CHANGE,{status:e.status});MEPH.publish("facebook_provider_response",{type:"facebook",response:e});MEPH.publish(Connection.constant.Constants.ProviderStatusChange,{provider:provider,online:e&&(e.status==="connected")});if(e.status==="connected"){b(true)}else{if(e.status==="not_authorized"){b(false)}else{b(false)}}})}else{b(true)}})})},online:function(a){return new Promise(function(d,c){var b=setTimeout(function(){d(true)},FacebookProvider.maxWaitTime);FB.getLoginStatus(function(e){clearTimeout(b);MEPH.publish(Connection.constant.Constants.ProviderStatusChange,{provider:a,online:e&&(e.status==="connected")});d(e&&(e.status==="connected"))})})},init:function(a){return new Promise(function(c,d){if(!MEPH.mobile.providers.identity.FacebookProvider.initStarted&&a&&a.appId){window.fbAsyncInit=window.fbAsyncInit||function(){try{FB.init({cookie:true,appId:a.appId,xfbml:true,version:"v2.2"});MEPH.publish("facebook_provider_inited",{type:"facebook"});c()}catch(f){MEPH.Log(f);d(f)}};function e(){}MEPH.mobile.providers.identity.FacebookProvider.checkLoginState=e;if(a.loginbtn){var b;if(typeof a.loginbtn==="string"){b=document.querySelector(a.loginbtn)}else{b=a.loginbtn}if(b){b.innerHTML='<fb:login-button scope="public_profile,email" onlogin="MEPH.mobile.providers.identity.FacebookProvider.checkLoginState();"></fb:login-button>'}}if(!MEPH.mobile.providers.identity.FacebookProvider.libraryLoaded){(function(i,f,j){var h,g=i.getElementsByTagName(f)[0];if(i.getElementById(j)){return}h=i.createElement(f);h.id=j;h.src="//connect.facebook.net/en_US/sdk.js";g.parentNode.insertBefore(h,g)}(document,"script","facebook-jssdk"));MEPH.mobile.providers.identity.FacebookProvider.libraryLoaded=true}MEPH.mobile.providers.identity.FacebookProvider.initStarted=true}})}},properties:{},contacts:function(){var a=this;if(a.isReady){return new Promise(function(b,c){FB.api("/me/friends",function(d){if(d&&!d.error){b(d)}})})}return false},property:function(b){var a=this;a.$providerpromise=a.$providerpromise.then(function(){return new Promise(function(e,d){if(a.cachedResponse){e(a.cachedResponse)}var c=setTimeout(function(){e(null)},FacebookProvider.maxWaitTime);a.contact().then(function(f){e(f)})}).then(function(c){var d=null;if(c){if(c.error){d=null}else{switch(b){case"name":d=c.name;break;case"gender":d=c.gender;break;case"link":d=c.link;break;case"profileimage":d="https://graph.facebook.com/"+c.id+"/picture";break}}}return{provider:a,type:FacebookProvider.key,response:c,value:d}})});return a.$providerpromise},contact:function(){var a=this;return(!a.isReady?a.ready():Promise.resolve()).then(function(){return new Promise(function(c,b){try{if(a.cachedResponse){return a.cachedResponse}FB.api("/me",function(e){if(e.error){a.cachedResponse=null;b(null)}console.log("Successful login for: "+e.name);a.cachedResponse=e;c(e)})}catch(d){b(d)}})})},Callback:function(a){var b=this;FacebookProvider.response=a;MEPH.publish(MEPH.Constants.provider.IDENTITY_STATUS_CHANGE,{status:a.status});MEPH.publish("facebook_provider_response",{type:"facebook",response:a})},renderBtn:function(a){var b=this;window.FacebookCallback=b.Callback.bind(b);a.innerHTML='<fb:login-button size="medium" onlogin="FacebookCallback">Connect with Facebook</fb:login-button>';a.classList.add("g-signin");var c="c"+MEPH.GUID();a.setAttribute("id",c);FB.XFBML.parse(document.getElementById(c));b.tempBtn=a},online:function(){var a=this;return a.ready().then(function(){return a.$online()})},login:function(){var a=this;return a.ready().then(function(){return FacebookProvider.login()})},$online:function(){var a=this;return new Promise(function(d,c){var b=setTimeout(function(){d(false)},FacebookProvider.maxWaitTime);FB.getLoginStatus(function(e){clearTimeout(b);d(e&&(e.status==="connected"));MEPH.publish(MEPH.Constants.provider.IDENTITY_STATUS_CHANGE,{status:e.status});MEPH.publish("facebook_provider_response",{type:"facebook",response:e});MEPH.publish(Connection.constant.Constants.ProviderStatusChange,{provider:a,online:e&&(e.status==="connected")})})})},ready:function(){var a=this;a.$providerpromise=a.$providerpromise.then(function(){return new Promise(function(d){if(a.isReady){d(FacebookProvider.key);return}var c=MEPH.subscribe("facebook_provider_response",function(g,f){a.$response=f.response;MEPH.unsubscribe(c);clearTimeout(b)});var e=MEPH.subscribe("facebook_provider_inited",function(f){a.isReady=true;MEPH.unsubscribe(e);d(FacebookProvider.key);clearTimeout(b)});var b=setTimeout(function(){d(FacebookProvider.key)},FacebookProvider.maxWaitTime);FacebookProvider.init(a.args).then(function(){return a.$online()})})});return a.$providerpromise}});
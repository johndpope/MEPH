MEPH.define("MEPH.list.List",{extend:"MEPH.control.Control",requires:["MEPH.util.Dom"],templates:true,alias:"list",properties:{templateNodeName:"template",listTemplates:null,listspace:"[listspace]",namespacePrefix:"MEPH.generated.template",boundSource:null,source:null,updateQueue:null,updatePromise:null,renderingInProgress:false},initialize:function(){var a=this;a.callParent.apply(a,arguments);a.listTemplates=[];a.boundSource=[];a.updateQueue=[];a.templateSelectionFunctions=[];a.setupEventHandlers();a.updatePromise=Promise.resolve()},setupEventHandlers:function(){var a=this;a.on("altered",function(c,b){if(b.path==="source"){a.removeListListeners(b.old);a.addListListeners(b.value);a.renderList()}},a);a.$templatesCreated;a.templateCreationPromise=new Promise(function(c,b){a.$templatesCreated=c})},addListListeners:function(b){var a=this;if(b&&Array.isArray(b)&&b.on){b.on("changed",a.updateList.bind(a),a)}},removeListListeners:function(b){var a=this;if(b&&Array.isArray(b)&&b.un){b.un(null,a)}},handleDomTemplate:function(){},itemClicked:function(i,c,a,b,d,e,h){var g=this,j,f;f=h.domEvent.srcElement||h.domEvent.target;j=g.boundSource.first(function(k){return g.getDomElements(k).first(function(l){return l===f||MEPH.util.Dom.isDomDescendant(l,f)||MEPH.util.Dom.isDomDescendant(f,l)})});if(j){g.getListSpace().dispatchEvent(MEPH.createEvent("itemclicked",{data:j.dataItem}))}},handleInstanceTemplate:function(){var c=this,a,e=0,d=Promise.resolve(),b=c.getInstanceTemplate();MEPH.Array(c.listTemplates).removeWhere(function(f){return f});a=MEPH.Array(b.childNodes).where(function(f){return f.nodeName.toLowerCase()===c.templateNodeName.toLowerCase()}).foreach(function(f){e++;d=d.then(function(){return c.generateClassForTemplate(f)});c.listTemplates.push(f)});if(e){d=d.then(function(){c.$templatesCreated()})}return d},getNameSpace:function(d){var c=this,b,a=d.getAttribute("name"),b=c.namespacePrefix.split(".");b.push(a);return b},generateClassForTemplate:function(f){var e=this,d,a=f.getAttribute("name"),c,b;c=e.getNameSpace(f);b=MEPH.getDefinedClass(c.join("."));d=MEPH.getTemplate(c.join("."));if(!d){d={alias:a,classifiedName:c.join("."),path:c.join("."),template:f.innerHTML,type:MEPH.templateType};MEPH.addTemplateInformation(d)}if(!b){return MEPH.createClass(c.join("."),MEPH.GUID(),"MEPH.control.Control",true,{initialize:function(){var g=this;Object.defineProperty(g,"list",{get:function(){return e},set:function(){}});g.callParent.apply(g,arguments)}})}return Promise.resolve().then(function(){return b})},getBoundSourceInfo:function(b){var c=this,a=c.boundSource.first(function(d){return d.dataItem===b});return a},getBoundSourceIndex:function(a){var b=this,c=b.getBoundSourceInfo(a);return b.boundSource.indexOf(c)},getPreviousBoundSource:function(b){var d=this,c,a;a=d.source.indexOf(b.dataItem);if(a===-1||a===0){return null}c=d.source[a-1];return d.getBoundSourceInfo(c)},updateList:function(c,a){var d=this,b;a.removed.foreach(function(f){var e=d.boundSource.first(function(g){return g.dataItem===f});if(e){d.updatePromise=d.updatePromise.then(function(){return d.removeItem(e).then(function(g){g.renderResult.foreach(function(h){h.classInstance.destroy()})}).then(function(g){d.boundSource.removeWhere(function(h){return h===e})})})}});a.added.foreach(function(e){d.updatePromise=d.updatePromise.then(function(){return d.renderItem(e)}).then(function(f){return d.positionAddDataItem(e)})});d.updatePromise=d.updatePromise.then(function(){d.renderinginprogress=false;if(d.updateQueue.length){b=d.updateQueue.pop();return d.updateList(null,b)}else{d.fire("updatecomplete",d)}})},getLastDomElement:function(a){var b=this;return b.getDomElements(a).last()},getDomElements:function(a){return a.renderResult.first().templateNode},positionAddDataItem:function(g){var a,e=this,f,d,b,c=e.getBoundSourceIndex(g);a=e.source.indexOf(g);if(c!==a){f=e.getBoundSourceInfo(g);d=e.getPreviousBoundSource(f);if(d){b=e.getLastDomElement(d);e.getDomElements(f).foreach(function(h){Dom.insertAfter(b,h);b=h});e.boundSource.removeWhere(function(h){return h===f});e.boundSource.splice(a,0,f)}}return Promise.resolve().then(function(){return g})},renderList:function(){var a=this,b=Promise.resolve();b=a.clearList().then(function(){b=a.render().then(function(){a.renderingInProgress=false});return b});a.fire("render",{renderComplete:b});return b},render:function(){var a=this;return a.templateCreationPromise.then(function(){var b=Promise.resolve();MEPH.Array(a.source).foreach(function(c){b=b.then(function(){return a.renderItem(c)})});a.source.foreach(function(c){b=b.then(function(d){return a.positionAddDataItem(d)})});return b})},clearList:function(){var a=this,b=Promise.resolve();a.boundSource.foreach(function(c){b=b.then(function(){return a.removeItem(c).then(function(d){d.renderResult.foreach(function(e){e.classInstance.destroy()})})})});return b.then(function(){a.boundSource.removeWhere(function(){return true})})},removeItem:function(b){var a=this;return Promise.resolve().then(function(){return b})},renderItem:function(b){var d=this,a,c;c=d.getListSpace();a=d.getTemplateForDataItem(b);if(typeof(a)==="string"){namespace=a.split(".")}else{namespace=d.getNameSpace(a)}return d.renderControl(namespace.join("."),c,d).then(function(e){d.boundSource.push({renderResult:e,dataItem:b});return e}).then(function(e){e.first().classInstance.data=b;e.first().classInstance.fire("databound");return e})},clickedItem:function(){var a=this},getTemplateForDataItem:function(c){var b=this,d,a;b.templateSelectionFunctions.first(function(e){d=e(c);return d});if(d){return d}a=b.getListTemplates().first(function(e){return e});return a},appendTemplateSelectionFunction:function(a){var b=this;if(!b.templateSelectionFunctions.some(function(c){return c===a})){return b.templateSelectionFunctions.push(a)}},removeTemplateSelectionFunction:function(a){var b=this;return b.templateSelectionFunctions.removeWhere(function(c){return c===a})},getListSpace:function(){var a=this;return a.getDomTemplate().first(function(b){return b.querySelector&&b.querySelector(a.listspace)}).querySelector(a.listspace)},getListTemplates:function(){var a=this;return a.listTemplates},destroy:function(){var a=this;if(a.boundSource){a.boundSource.foreach(function(b){b.dataItem.un(null,a);b.dataItem.dun(null,a);b.renderResult.foreach(function(c){c.classInstance.destroy()})})}a.callParent.apply(a,arguments)}});
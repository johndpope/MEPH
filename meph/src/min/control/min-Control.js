MEPH.define("MEPH.control.Control",{requires:["MEPH.dom.ControlLoader","MEPH.mixins.Referrerable","MEPH.util.Dom","MEPH.mixins.Injections","MEPH.mobile.services.MobileServices","MEPH.util.Observable","MEPH.util.Style","MEPH.mixins.Observable"],mixins:{observable:"MEPH.mixins.Observable",referrerable:"MEPH.mixins.Referrerable",injectable:"MEPH.mixins.Injections"},statics:{operations:{inject:"inject"},connectables:{control:"control",view:"view",presenter:"presenter",viewmodel:"viewmodel",model:"model",controller:"controller",html:"html",self:"self",subcontrol:"subcontrol"}},properties:{$subscriptions:null,$listOfTransferableAttributes:null,$domTemplate:null,$controls:null,loaded:false,afterloaded:false,$referenceConnections:null,application:null,instanceTemplate:null,$uniqueId:null,injectControls:null,$window:null,$removeHomePageCls:"meph-view-remove",applicationLoaded:false,$isDestroyed:false,data:null,componentCls:null,$autoBindProperties:null,id:null},initialize:function(){var a=this;a.$controls=[];a.$autoBindProperties=[];a.$listOfTransferableAttributes=[];a.mixins.referrerable.init.apply(a);a.mixins.observable.init.apply(a);a.mixins.injectable.init.apply(a);a.$referenceConnections=MEPH.Array([{type:MEPH.control.Control.connectables.control,obj:a}]);a.$subscriptions=[];a.addTransferableAttribute("MEPHId",{object:a,path:"id"});a.on("setinstancetemplate",a.handleInstanceTemplate.bind(a));a.on("setdomtemplate",a.handleDomTemplate.bind(a));a.on("load",a.setLoadProperties.bind(a));a.on("afterload",a.setAfterLoadedProperties.bind(a));a.on("load",a.initDataBinding.bind(a));a.on("load",a.applyTransferableAttribute.bind(a));a.on("load",a.onLoaded.bind(a))},broadCast:function(b,a){var c=this;MEPH.publish(b,a)},getTemplateEl:function(c){var b=MEPH.getTemplate(c);var a=MEPH.util.Dom.createCenteredElement();a.innerHTML=b.template;return a},getAutoBindProperties:function(){var a=this;return a.$autoBindProperties},addAutoBindProperty:function(c,a){var b=this;b.getAutoBindProperties().push({property:c,autoProperty:a})},getAutoBindPropertyPath:function(a){return a},setLoadProperties:function(){var a=this;a.loaded=true},setAfterLoadedProperties:function(){var a=this;a.afterloaded=true},onLoaded:function(){},getListOfTransferableAttributes:function(){var a=this;return a.$listOfTransferableAttributes},addTransferableAttribute:function(a,c){var b=this;if(!b.getListOfTransferableAttributes().some(function(d){return d.name===a})){b.getListOfTransferableAttributes().push({name:a,options:c})}},subscription:function(b){var a=this;a.$subscriptions.push(b)},applyTransferableAttribute:function(){var c=this,b,a;MEPH.Array(c.getInstanceTemplate().attributes).select(function(d){return d.name}).foreach(function(f){var d=MEPH.getDataBindPrefixes().first(function(g){return f.indexOf(g+MEPH.bindPrefixDelimiter)!==-1});if(d){d+=MEPH.bindPrefixDelimiter;var e=f.substring(d.length,f.length);c.addTransferableAttribute(e,{object:c,path:e})}});c.getListOfTransferableAttributes().foreach(function(e){var d=c.getInstanceTemplate().getAttribute(e.name);if(d===null||d===undefined){d=MEPH.getDataBindPrefixes().selectFirst(function(f){return c.getInstanceTemplate().getAttribute(f+MEPH.bindPrefixDelimiter+e.name)})}if(d!==null){c.getDomTemplate().where(function(f){return f.nodeType===Dom.elementType}).foreach(function(g){var f=e.options;if(f.selector){if(g.parentNode){MEPH.Array(g.parentNode.querySelectorAll(f.selector)).where(function(h){return h==g}).foreach(function(h){h.setAttribute(e.name,d)})}MEPH.Array(g.querySelectorAll(f.selector)).foreach(function(h){h.setAttribute(e.name,d)})}else{if(f.object&&f.path){b=false;if(d){a=MEPH.Array(d.split(MEPH.pathDelimiter)).first();if(MEPH.getBindPrefixShortCut(a)){b=true}}if(!b){MEPH.setPathValue(f.object,f.path,d)}}}})}})},setUniqueId:function(b){var a=this;a.$uniqueId=b},getUniqueId:function(){var a=this;return a.$uniqueId},addSubControl:function(b){var a=this;a.$controls.push(b)},getSubControls:function(){var a=this;return a.$controls},initDataBinding:function(){var a=this;a.getReferenceConnections().where(function(b){return b.creator}).foreach(function(b){if(b.obj[MEPH.isObservablePropertyKey]){b.obj.fire("altered",{path:"",references:[]})}})},initComponent:function(){},handleInstanceTemplate:function(){var a=Promise.resolve();return a},filterEvents:function(b){var a=MEPH.Array(arguments).last().domEvent.srcElement;return !!MEPH.util.Dom.isDomDescendant(a,b)},cancelEvent:function(){var a=MEPH.util.Array.convert(arguments).last();a.domEvent.preventDefault();a.domEvent.cancelBubble=true;a.domEvent.stopPropagation();a.domEvent.cancelled=true;console.log("cancel event");return false},handleDomTemplate:function(){var d=this,a,b={},c;if(d.injectControls){c=d.getInstanceTemplate();if(c){a=MEPH.Array(MEPH.Array(c.childNodes).select(function(e){return e}).reverse()).foreach(function(e){var f=d.getLocationForInjection(d.injectControls,e,b);if(b.childrenOnly){MEPH.Array(MEPH.Array(e.childNodes).select(function(g){return g}).reverse()).foreach(function(g){Dom.insertBefore(f,g)})}else{Dom.insertBefore(f,e)}})}}},setControlObject:function(a){var b=this;b.$controlobject=a},getControlObject:function(){var a=this;return a.$controlobject},loadSubControl:function(b,c){var a=this;return a.application.loadSubControls([b.getControlObject()])},viewTransition:function(a,b){var c=this;return new Promise(function(f,e){var g,d=function(){clearTimeout(g);c.dun(c,"webkitTransitionEnd");c.dun(c,"transitionend");f()};c.don("webkitTransitionEnd",a,d);c.don("transitionend",a,d);if(b.maxTime||MEPH.MaxTransitionTime){g=setTimeout(d,b.maxTime||MEPH.MaxTransitionTime)}if(b.remove){MEPH.Array(b.remove.split(" ")).foreach(function(h){a.classList.remove(h)})}if(b.add){MEPH.Array(b.add.split(" ")).foreach(function(h){a.classList.add(h)})}})},getLocationForInjection:function(g,f,c){var e=this,b=f.nodeName.toLowerCase(),a,d;if(g.location&&typeof g.location==="string"){d=e.getDomTemplate();comment=e.getCommentByName(d,g.location);return comment}else{if(g.location&&typeof g.location==="object"){d=e.getDomTemplate();a=g.location[b];comment=e.getCommentByName(d,a);if(c){c.childrenOnly=true}return comment}}return null},setDomTemplate:function(b){var a=this;a.$domTemplate=MEPH.Array(b)},getDomTemplate:function(){var a=this;return a.$domTemplate},getFirstElement:function(){var a=this;return a.getDomTemplate().first(function(b){return b.nodeType===Dom.elementType})},querySelectorAll:function(a){var b=this;return(b.getDomTemplate()).select(function(d){var c=[],e=d;if(e.parentNode){MEPH.Array(e.parentNode.querySelectorAll(a)).where(function(f){return f===e}).foreach(function(f){if(f){c.push(f)}})}if(d.nodeType===Dom.elementType){MEPH.Array((d.querySelectorAll(a))).foreach(function(f){if(f){c.push(f)}})}return c}).concatFluentReverse(function(c){return c})},hide:function(){var a=this;a.getDomTemplate().foreach(function(b){if(b){Style.hide(b)}})},show:function(){var a=this;a.getDomTemplate().foreach(function(b){if(b){Style.show(b)}})},querySelector:function(a){var b=this;return(b.getDomTemplate()).selectFirst(function(c){var d,e=c;if(c.nodeType===Dom.elementType){d=c.querySelector(a);if(d){return d}}if(e.parentNode){return MEPH.Array(e.parentNode.querySelectorAll(a)).first(function(f){return f===e})}return null})},renderControl:function(a,c,h,d,b){var f=this,j,g;g=f.getApplication();if(g){j=MEPH.createTemplateNode(a);if(j&&j.node&&d){for(var e in d){j.node.setAttribute(e,d[e])}}j.injections=b||null;return g.loadViewObject([j],c,h)}return Promise.resolve().then(function(){throw new Error("application is not present")})},isDestroyed:function(){var a=this;return a.$isDestroyed},destroy:function(){var c=this,a,b=c.getDomTemplate();if(c.$isDestroyed){return}c.fire("beforedestroy",c);if(!Array.isArray(b)){b=([b])}MEPH.Array(b);c.$controls.removeWhere(function(d){d.destroy();return true});c.$isDestroyed=true;b.foreach(function(d){if(d&&d.parentNode&&d.parentNode.removeChild){d.parentNode.removeChild(d)}});c.fire("destroy",c);for(a in c){if(MEPH.IsEventable(c[a])){c[a].un(null,c)}}c.$referenceConnections.foreach(function(d){if(MEPH.IsEventable(d)){d.obj.un(null,c);d.obj.dun(null,c)}});MEPH.unsubscribe(c.$subscriptions);c.un();c.dun()},combineClsIntoDepenendProperty:function(b,c){var a=this;MEPH.util.Observable.defineDependentProperty(b,a,c,function(e){var d=[];MEPH.Array(e).foreach(function(f){if(a[f]){d.push(a[f])}});return d.join(" ")}.bind(a,c))},getApplication:function(){var a=this;return a.application},setApplication:function(a){var b=this;b.application=a;b.application.on(MEPH.Constants.applicationReady,function(){b.applicationLoaded=true})},getTemplates:function(){var a=this;return MEPH.Array(a.templates)},uniqueTemplates:function(){var a=this;a.templates=a.templates.select()},addTemplate:function(a){var b=this;b.templates.push(a)},getBindableProperties:function(){},toggleBoolean:function(b,c){var a=this;b[c]=!!!b[c]},generateDomTemplate:function(){var b=this,a,c;instructionGroups=b.getOrdereredConstructionInstructions();instructionGroups.foreach(function(d){if(b.hasInstructions(d)){MEPH.util.Array.create(d.instructions).foreach(function(e){b.applyInstructionGroup(c,e)})}else{c=MEPH.dom.ControlLoader.getUnattachedDiv();MEPH.util.Array.create(d.nodes).foreach(function(e){c.appendChild(e)})}});return c},getGeneratedTemplateDom:function(){var b,a=this;b=a.generateDomTemplate();return a.getTemplateDom(b)},getUnattachedDiv:function(){return document.createElement("div")},getTemplateDom:function(a){var c=this,d,b;d=c.getUnattachedDiv();d.appendChild(a);b=MEPH.util.Array.convert(a.childNodes);return b},getDomObjectsToBind:function(b){var d=this,e,a=MEPH.getAllAliases(),c=MEPH.getDataBindPrefixes();e=Promise.resolve().then(function(){return c.concatFluentReverse(function(f){return MEPH.util.Array.convert(b.querySelectorAll("["+f+"]"))}).unique(function(f){return f})});return e},setInstanceTemplate:function(a){var b=this;b.instanceTemplate=a},getInstanceTemplate:function(){var a=this;return a.instanceTemplate||null},applyInstructionGroup:function(d,a){var b=this,c=a.startGroupComment;control=MEPH.control.Control;switch(c.operation){case control.operations.inject:return b.injectDom(d,a.startGroupComment,a.domObjects);default:return false}},injectDom:function(g,d,a){var c=this,b=MEPH.util.Dom,e,f;MEPH.Array(a);comment=c.getCommentByName(g,d.position);if(comment){e=b.tryParse(comment);a.foreach(function(h){if(d.before){b.insertBefore(comment,h)}else{b.insertAfter(comment,h)}});return true}return false},getCommentByName:function(f,a){var c=this,b=MEPH.util.Dom,d,e;e=MEPH.util.Array.convert(b.getComments(f));comment=e.first(function(h){var g=b.tryParse(h);if(g&&g.name===a){return h}return false});return comment},hasInstructions:function(a){var b=this;return a.instructions.length>0},getTemplateInstructions:function(b){var d=this,a=MEPH.util.Array.create(),e,c;c=MEPH.getDefinedTemplate(b);e=MEPH.dom.ControlLoader.getTemplateDom(c);return{instructions:d.getCommentGroups(e),nodes:e,template:b}},getOrdereredConstructionInstructions:function(){var b=this,a;a=MEPH.util.Array.create(b.getTemplates()).select(b.getTemplateInstructions.bind(b));return a},getCommentGroups:function(b){var d=this,c=MEPH.util.Dom,a=MEPH.util.Array.create(),e,f=null;b.foreach(function(h,g){if(f===null){f={domObjects:MEPH.util.Array.create(),start:null,end:null}}if(c.isComment(h)){e=c.tryParse(h);if(e&&e.instruction){if(e.close){if(f.start===null){throw"Incorrect template format: close without a matching start."}f.end=true;f.endGroupComment=e;a.push(f);f=null}else{if(f.start!==null){throw"Incorrect template format: start has already been added"}f.start=true;f.startGroupComment=e}}}else{if(f===null){}else{f.domObjects.push(h)}}});return a}});
MEPH.define("MEPH.audio.music.instrument.SoundFontInstrument",{extend:"MEPH.audio.music.instrument.Instrument",alternateNames:["SoundFontInstrument"],requires:["MEPH.audio.soundfont.SoundFontParser","MEPH.audio.Audio","MEPH.graph.Node","MEPH.audio.soundfont.chunks.data.operators.OperatorFactory","MEPH.audio.Constants","MEPH.audio.soundfont.utils.SFByteArray","MEPH.audio.soundfont.utils.NoteSampleDecoder"],statics:{soundFontParse:null,$resources:null,$decoder:null,getSoundFontParse:function(){SoundFontInstrument.soundFontParse=SoundFontInstrument.soundFontParse||new MEPH.audio.soundfont.SoundFontParser();return SoundFontInstrument.soundFontParse},getResources:function(){SoundFontInstrument.$resources=SoundFontInstrument.$resources||[];return SoundFontInstrument.$resources},getResource:function(a){return SoundFontInstrument.getResources().first(function(b){return b.file===a})}},properties:{$samplerate:44100,$soundfontfile:null,$soundfont:null},setFontFile:function(a,b){var c=this;c.$soundfontfile=a;c.$type=b||".sf2"},ready:function(a){var b=this,c=b.getResourcesToLoad();return Promise.all(c.select(function(d){var e={file:d.file,type:d.type};SoundFontInstrument.getResources().push(e);return b.load(d.file,d.type,a).then(function(f){e.result=f})})).then(function(){return true})["catch"](function(d){MEPH.Log(d);return false})},addResource:function(b,c,a,e){var d=this;SoundFontInstrument.getResources().push({file:b,type:c,result:a,id:e})},load:function(c,d,b){var e=this,a=SoundFontInstrument.getResources().first(function(f){return f.file===c&&f.type===d});if(a&&a.result){return Promise.resolve().then(function(){return a.result})}return MEPH.loadJSCssFile(c,d).then(function(f){return f.response})},getResourcesToLoad:function(){var b=this;var a=[{file:MEPH.getClassPath(b.$soundfontfile)+b.$type,type:"audio"}];return a},getFontResource:function(b){var c=this,a=SoundFontInstrument.getResource(b||(MEPH.getClassPath(c.$soundfontfile)+c.$type));return a.result},presets:function(){var b=this,a=b.getSoundFont();if(a){return a.getPresets()}},noteToFrequency:function(a){a=a||60;return 440*Math.pow(2,(a+3)/12-6)},samplerate:function(a){var b=this;if(a!==undefined){b.$samplerate=a}return b.$samplerate},getSoundFont:function(){var a=this;return a.$soundfont},decoder:function(b){var a=new MEPH.audio.soundfont.utils.NoteSampleDecoder(b);return a},note:function(s,j,a){var p=this;var r=new MEPH.audio.Audio();var c=p.selectPreset().notesample(s,j);var h=p.decoder(c);var t=c.getStart();var m=c.getEnd();var o=c.getLoopStart();var l=c.getLoopEnd();var d=p.samplerate();a=Math.round(a*d)||(m-t);var q=new ArrayBuffer(a*8);var k=new SFByteArray(q);h.extract(k,(a)/2,0,d);var b=p.converFloat32(k._dataview);var e=r.createBuffer(2,b.length/2,d);var g=e.getChannelData(0);var f=e.getChannelData(1);for(var n=0;n<b.length/2;n++){g[n]=b[2*n];f[n]=b[(2*n)+1]}return e},nodeprocessor:function(w,j,k){var t=this;var a=t.selectPreset().notesample(w,j),i=t.decoder(a),q=a.getEnd(),x=a.getStart();var s=a.getLoopStart()/2,l=a.getLoopEnd()/2,b=t.samplerate(),f=x/2,d=q/2;s=s-f;l=l-f;i.setup(b);var o=0;var m=false;var c=undefined;var e=false;var r=undefined;var n=false;var h=undefined;var v;var g=0;var p=MEPH.GUID();var u=function(K){var B=K.outputBuffer;var J=[].interpolate(0,K.outputBuffer.numberOfChannels,function(M){return B.getChannelData(M)});if(h===undefined){return}var D=K.outputBuffer.length;var y=K.outputBuffer.sampleRate;if(n){g+=D;if(n&&h>(g/y)){return}}var I=0;if(!n&&(h<=K.playbackTime&&!e)||(n&&h<=(g/y)&&!e)){e=true;if(n){var E=Math.round(h*y);I=D-(g-E)}o=0;if(p){}}if((!n&&(v!==undefined&&v<=K.playbackTime&&e))||(n&&(v!==undefined&&v<=(g/y)&&e))){if(r){r()}return}var C=D;var A=J.length;for(var G=A;G--;){for(var H=I;H<C;H++){if(o>=l&&!k){o=s}var F=o+x/2;F=(F<<1);var L=i._decoder._bytes;L.position=F;if(q<=F){J[G][H]=0}else{var z=L._dataview.getInt16(L.position,L.endian)*0.000030518509476;J[G][H]=z}o++}}};u=u.bind(t);u.context=function(y,z){c=y;n=z};u.start=function(y){h=y;e=false;o=0;g=0};u.stop=function(y,z){v=y;r=z;o=q};return u},createNoteGraph:function(f,b){var d=new MEPH.graph.Graph(),c,e=new MEPH.audio.graph.node.AudioBufferSourceNode();c=new MEPH.graph.Node();c.setId(MEPH.GUID());e.id=MEPH.GUID();e.setNodeInputDefaultValue("source",f);c.appendData(e);c.data=e;d.addNode(c);var a=d.saveGraph();a.id=a.id||MEPH.GUID();a.name=b;e.destroy();MEPH.publish(MEPH.audio.Constants.AUDIO_GRAPH_SAVED,a);return a},sampleChunks:function(){var a=this;return a.$soundfont._data.dataChunk.samplesSubchunk.records.select()},trimResource:function(b){var c=b.firstIndex(function(d){return d!==0});var a=b.lastIndex(function(d){return d!==0});if(a%2){a=Math.min(a+1,b.length)}b=b.subset(c,a);return b},loadDataUri:function(b){var a,d=new Promise(function(e){a=e});var c=new XMLHttpRequest();c.open("GET",b,true);c.responseType="arraybuffer";c.onload=function(){a(c.response)};c.onerror=function(){toFail({error:new Error("AudioSampleLoader: XMLHttpRequest called onerror")})};c.send();return d},converFloat32:function(d){var c=new Float32Array(d.byteLength/4);for(var b=0;b<d.byteLength/4;b++){var a=d.getFloat32(b*4,true);c[b]=a}return c},convert255:function(d){var c=[];for(var b=0;b<d.byteLength/4;b++){var a=d.getFloat32(b*4,true);c[b]=128+Math.round(127*a)}return c},notesample:function(b,d){var c=this;var a=c.getSoundFont();b=b||60;d=d||100;var e=a.getNoteSample(b,d);return e},selectPreset:function(d){var c=this,a=c.getSoundFont(),b=a.getPresetIds();d=d||b.first()||0;if(d!==null){a.selectPreset(d)}return c},prepare:function(b){var c=this;var a=c.parse(b);c.$soundfont=a;return Promise.resolve().then(function(){return c.$soundfont})},parse:function(b){var e=SoundFontInstrument.getSoundFontParse();var c=this;var d=c.getFontResource(b);var a=e.parse(d);return a}});
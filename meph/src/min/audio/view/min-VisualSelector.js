MEPH.define("MEPH.audio.view.VisualSelector",{alias:"visualselector",extend:"MEPH.audio.view.Visualizer",requires:["MEPH.input.Range","MEPH.util.Renderer","MEPH.input.Dropdown","MEPH.signalprocessing.SignalProcessor"],templates:true,properties:{stop:100,maxCache:20,position:0,step:0.0001,markBtnText:"Mark",max:null,min:null,marks:null,offsetbtnheight:19,windowpadding:5,offsetstretchvertical:4,stretchlinewidth:3,marktype:"default",stretchtype:"stretchtype",windowingcolor:"#aa3939",markercolor:"#d9534f",markscolor:"#f0ad4e",markscolorbg:"rgba(45, 64, 114, 0.5)",markerBtns:null,stretchControls:null,stretchcolor:"#f2f233",stretchmarks:null,stretchFlowState:"",beats:null,beatsPerMin:null,pitchShift:0.5,pitchWindowSize:1000,smallestStep:1e-7,silenceThreshold:0,silenceTimeSticky:0,silenceTimeThreshold:0,renderer:null,stretchValue:1,injectControls:{location:"buttonpanel"},detectedPitch:null,$signalProcessor:null,markerrenderer:null},initialize:function(){var a=this;a.great();a.markerBtns=[];a.stretchControls=[];a.$signalProcessor=new SignalProcessor();Observable.defineDependentProperty("silenceThresholdHeight",a,["silenceThreshold"],a.calculateSilenceThreholdHeight.bind(a));a.on("altered",function(c,b){if(b.path==="marks"){if(a.marks){a.marks.onIf("changed",a.update.bind(a))}a.update()}if(b.path==="stretchmarks"){if(a.stretchmarks){a.stretchmarks.onIf("changed",a.update.bind(a))}a.update()}if(b.path==="vertical"||b.path==="scrollMutiplier"||b.path==="scrollleft"){a.update()}})},onLoaded:function(){var a=this;a.beats=MEPH.util.Observable.observable([].interpolate(35,170,function(b){return{name:b,value:b}}));a.beatsPerMin=72;a.stretchFlowState="Start"},calculateSilenceThreholdHeight:function(){var c=this,a=c.height||0,b=c.silenceThreshold||0,d=a*b;Style.top(c.silenceThresholdDiv,(a/2)-(d/2));Style.height(c.silenceThresholdDiv,d);Style.width(c.silenceThresholdDiv,c.width);return d},addMark:function(){var c=this,a=c.getCurrentPosition();var b=c.getAbsoluteMarkPosition(a);c.$addMark(b)},$addMark:function(b){var a=this;if(a.marks&&!a.marks.some(function(c){return c.position===b})){a.marks.push({position:b,type:a.marktype})}},addStretchMark:function(){var c=this,a=c.getCurrentPosition();var b=c.getAbsoluteMarkPosition(a);if(c.stretchmarks&&!c.stretchmarks.some(function(d){return d.position===b||(d.position<b&&d.targetposition>b)})){c.$addStretchMark(b)}},$addStretchMark:function(a,b){var c=this;c.stretchmarks.push({position:a,targetposition:b||0,stretch:0,type:c.stretchtype})},detectPitch:function(){var c=this,b=c.getSelectedClip();if(b){var a=MEPH.audio.Audio.updatePitch(b.buffer.buffer.getChannelData(0),c.source.buffer.buffer.sampleRate);c.detectedPitch=a}},getSelectedClip:function(){var d=this,b=d.getStartEndPosition();if(b){var e=b.start;var a=b.end;if(d.source){var c=d.getClip(d.source,e,a);return c}}return null},getStartEndPosition:function(){var b=this,d=b.width;if(b.selectedRange){var c=b.getAbsoluteMarkPosition(b.selectedRange.start/d)/b.source.buffer.buffer.sampleRate;var a=b.getAbsoluteMarkPosition((b.selectedRange.end)/d)/b.source.buffer.buffer.sampleRate;return{start:c,end:a}}return null},detectPitches:function(){var d=this,e=d.getStartEndPosition(),c=d.getSelectedClip();if(c){var a=d.source.buffer.buffer.sampleRate;var b=MEPH.audio.Audio.detectPitches(c.buffer.buffer.getChannelData(0),a,parseInt(d.pitchWindowSize));d.renderAreasOfInterest("pitches",b.select(function(f){return{start:f.start+e.start*a,key:f.key,end:f.end+e.start*a}}))}},detectSilence:function(){var d=this,e=d.getStartEndPosition(),c=d.getSelectedClip();if(c){var a=d.source.buffer.buffer.sampleRate;var b=MEPH.audio.Audio.detectSilence(c.buffer.buffer.getChannelData(0),parseFloat(d.silenceThreshold),parseFloat(d.silenceTimeThreshold),parseFloat(d.silenceTimeSticky));d.renderAreasOfInterest("silence",b.select(function(f){return{start:f.start+e.start*a,end:f.end+e.start*a}}))}},renderAreasOfInterest:function(d,b){var e=this,a=e.container,c=(e.$areasOfInterest||[]).where(function(g){if(d===undefined){return true}return g.type===d});if(b===undefined){b=(e.$areasOfInterest||[]).select()}var f=b.select(function(g){var k=e.getRelativeMarkPosition(g.start);var i=e.getRelativeMarkPosition(g.end);if(i-k<5){return null}var j=c.unshift(),l;if(j){l=j.div}l=l||document.createElement("div");Style.height(l,e.height);Style.absolute(l);Style.top(l,0);l.classList.add("infoarea");l.classList.add("noresponse");if(d==="pitches"){var h=document.createElement("h3");h.innerHTML=g.key.note;l.appendChild(h)}if(l.parentNode!==a){a.appendChild(l)}Style.left(l,k);Style.width(l,i-k);return{div:l,start:g.start,type:d||g.type,end:g.end}}).where();c.foreach(function(g){g.div.parentNode.removeChild(g.div)});e.$areasOfInterest=f},addSelectionAsMarks:function(){var b=this,d=b.width;if(b.selectedRange){var c=b.getAbsoluteMarkPosition(b.selectedRange.start/d);var a=b.getAbsoluteMarkPosition((b.selectedRange.end)/d);if(b.marks&&!b.marks.some(function(e){return e.position===c})){b.marks.push({position:c,type:b.marktype})}if(b.marks&&!b.marks.some(function(e){return e.position===a})){b.marks.push({position:a,type:b.marktype})}}},getAbsoluteMarkPosition:function(b){var a,e=this,g=e.width,c=e.getBuffer();if(c){var f=c.length*e.timeScroll;var d=(c.length*e.magnification);return(b*d)+f}},shiftPitch:function(){var d=this;var f=d.$signalProcessor;if(d.playingClip){d.playingClip.stop();return}var a=d.getBuffer();var h=d.getSnippet();var e;var g;if(!h){return}var c=new MEPH.audio.Audio();c.buffer(h.buffer,{name:"buffer"}).processor({name:"proce",process:function(i){var k=i.inputBuffer;var j=i.inputBuffer.getChannelData(0);var l=i.outputBuffer.getChannelData(0);f.pitchShift(parseFloat(d.pitchShift),j.length,j.length,4,d.source.buffer.buffer.sampleRate,j,l)}}).complete();var b=c.get({name:"buffer"});b.first().node.onended=function(){c.disconnect();delete d.playingClip;delete c;delete b.first().node};d.playingClip=b.first().node;d.playingClip.start()},getSnippet:function(){var d=this,e=d.source,c=new MEPH.audio.Audio(),b=parseFloat(d.magnification);if(d.source){var g=d.getSnippetStart();var f=e.buffer.buffer.duration*b;var a=d.getClip(e,g,g+f);return a}return null},getSnippetStart:function(){var c=this,d=c.source,b=parseFloat(c.magnification),a=parseFloat(c.timeScroll);var e=a*d.buffer.buffer.duration;return e},getClip:function(c,d,a){var b=MEPH.audio.Audio.clip(c,d,Math.min(c.buffer.buffer.duration,a));return b},playClip:function(){var b=this;if(b.playingClip){b.playingClip.stop();return}var a=b.getSnippet();if(a){a=b.$playSnippet(a)}},saveClip:function(){var b=this,a=b.getSnippet();if(!a){return}b.markCanvas.dispatchEvent(MEPH.createEvent("saveclip",{snippets:[a]}))},saveClips:function(){var c=this,d;if(!c.source){return null}d=c.source;var a=c.marks.orderBy(function(e,f){return e.position-f.position});c.marks.length=0;c.marks.push.apply(c.marks,a);var b=c.marks.select(function(e,g){if(g){var i=c.marks[g-1];var f=c.marks[g]?c.marks[g].position:d.buffer.buffer.length;var h=MEPH.audio.Audio.clipBuffer(c.source,i.position,f);return h}return false}).where();if(b.length){c.markCanvas.dispatchEvent(MEPH.createEvent("saveclip",{snippets:b}))}},cutSectionOut:function(){var c=this,e=c.width;if(c.selectedRange){var d=c.getAbsoluteMarkPosition(c.selectedRange.start/e);var a=c.getAbsoluteMarkPosition((c.selectedRange.end)/e);if(a-d>10){var b=MEPH.audio.Audio.cutOutSection(c.source,d,a,null);c.source.buffer=b.buffer}}},trimSection:function(){var c=this,e=c.width;if(c.selectedRange){var d=c.getAbsoluteMarkPosition(c.selectedRange.start/e);var a=c.getAbsoluteMarkPosition((c.selectedRange.end)/e);console.log("start : "+d+"  end "+a);if(a-d>10){c.marks.removeWhere(function(f){return f.position>a||f.position<d});c.marks.where(function(f){return f.position<a&&f.position>d}).foreach(function(f){f.position-=d});var b=MEPH.audio.Audio.clipBuffer(c.source,d,a,null);c.source.buffer=b.buffer}}},$playSnippet:function(c){var b=this;if(b.playingClip){b.playingClip.stop()}if(c){var a=new MEPH.audio.Audio();a.buffer(c.buffer.buffer,{name:"buffer"}).gain({name:"gain",volume:1}).complete();var c=a.get({name:"buffer"});c.first().node.onended=function(){a.disconnect();if(b.getCurrentTime){b.clipEnded=b.getCurrentTime()}delete b.getCurrentTime;delete b.playingClip;delete a;delete c.first().node};b.playingClip=c.first().node;b.getCurrentTime=function(){return a.getAudioContext().currentTime};b.playingClip.start();b.startedTime=a.getAudioContext().currentTime}return c},getRelativeMarkPosition:function(a){var d=this,f=d.width,b=d.getBuffer();if(b){var e=b.length*d.timeScroll;a-=e;var c=(b.length*d.magnification);a/=c;return(a)*f}},getCurrentPosition:function(){var g=this;var c=parseFloat(g.position);var d=parseFloat(g.container.scrollLeft);var b=parseFloat(g.canvas.clientWidth);var h=parseFloat(g.container.clientWidth);var e=Math.min(h,b-d);var f=e*c;return(f+d)/b},getMarkerPosition:function(){var g=this;var c=parseFloat(g.position);var d=parseFloat(g.container.scrollLeft);var b=parseFloat(g.canvas.clientWidth);var h=parseFloat(g.container.clientWidth);var e=Math.min(h,b-d);var f=e*c;return(f+d)},scanToMark:function(c){var d=this,b=d.getBuffer();if(b){if(d.$currentMark===undefined){var e=d.marks.first();if(e){d.timeScroll=e.position/b.length;d.$currentMark=0}}else{d.$currentMark=(d.$currentMark+parseInt(c));if(d.$currentMark===d.marks.length){d.$currentMark=-1}if(d.$currentMark<-1){d.$currentMark=d.marks.length-1}if(d.$currentMark===-1){d.timeScroll=0;return}d.$currentMark=d.$currentMark%d.marks.length;var a=d.marks[d.$currentMark].position;d.timeScroll=a/b.length}}},updateStretchControls:function(){var c=this;if(c.stretchmarks){var d=c.stretchControls.removeWhere(function(e){return !c.stretchmarks.some(function(f){return f===e.marker})});d.foreach(function(e){if(e.destroy){e.destroy()}});var a=c.stretchmarks.where(function(e){return !c.stretchControls.some(function(f){return f.marker===e})});var b=c.createNewStretchMarkerControls(a);c.stretchControls.push.apply(c.stretchControls,b);c.stretchControls.foreach(function(e){c.positionStretchControls(e)})}},updateMarkBtns:function(){var b=this;if(b.marks){var c=b.markerBtns.removeWhere(function(e){return !b.marks.some(function(f){return f===e.marker})});c.foreach(function(e){e.dom.parentNode.removeChild(e.dom)});var a=b.marks.where(function(e){return !b.markerBtns.some(function(f){return f.marker===e})});var d=b.createNewMarkerBtns(a);b.markerBtns.push.apply(b.markerBtns,d);b.markerBtns.foreach(function(f){var e=b.getRelativeMarkPosition(f.marker.position,b.magnification,b.timeScroll);f.dom.style.left=(e)+"px";f.dom.style.top=(b.height-b.offsetbtnheight)+"px"})}},getBufferSampleRate:function(){var b=this,a=b.getBuffer();if(a){return b.source.buffer.buffer.sampleRate}return null},getBufferLength:function(){var b=this,a=b.getBuffer();if(a){return a.length}return null},createStretchPointFlow:function(){var c=this;if(!c.stretchPointFlowState){c.stretchFlowState="Mark Start";c.playClip();c.stretchPointFlowState={state:true,started:c.getCurrentTime()}}else{if(c.stretchPointFlowState.state&&c.getCurrentTime){c.stretchPointFlowState.start=c.getCurrentTime();c.stretchPointFlowState.state=false;c.stretchFlowState="Mark End"}else{if(!c.stretchPointFlowState.state){if(c.getCurrentTime){c.stretchPointFlowState.end=c.getCurrentTime()}else{c.stretchPointFlowState.end=c.clipEnded}var b=c.getBufferSampleRate();var d=c.getSnippetStart()+b*(c.stretchPointFlowState.start-c.stretchPointFlowState.started);var a=c.getSnippetStart()+b*(c.stretchPointFlowState.end-c.stretchPointFlowState.started);if(c.playingClip){c.playingClip.stop()}c.$addStretchMark(d,a-d);c.stretchFlowState="";c.stretchPointFlowState=null}}}},getWindowfunctions:function(){var c=this;var b=[];for(var a in MEPH.math.Util.window){b.push({name:a,value:a})}return b},createNewStretchMarkerControls:function(b){var a=this;return b.select(function(m,i){var d=a.createStretchMark();var f=d.querySelector("[anchorbtn]");var y=d.querySelector("[targetbtn]");var r=d.querySelector("[stretchselect]");var e=d.querySelector("[stretchcontrol]");var p=d.querySelector("[stretchvalue]");var c=d.querySelector("[removebtn]");var q=d.querySelector("[stretchbeattarget]");var u=d.querySelector("[stretchactualbeattarget]");var j=d.querySelector("[addanchormarker]");var t=d.querySelector("[addtargetmarker]");var s=d.querySelector("[stretchandplay]");var g=d.querySelector("[normalplaybtn]");var l=d.querySelector("[windowfunction]");var h=d.querySelector("[saveclip]");var o=d.querySelector("[savestretchclip]");var w=d.querySelector("[windowfunctionspread]");var n=[{name:"Sixteenth note",value:0.25},{name:"Eighth note",value:0.5},{name:"Quarter note",value:1},{name:"Half note",value:2},{name:"Whole note",value:4},{name:"2 Whole",value:8},{name:"4 Whole",value:16},{name:"8 Whole",value:32},{name:"16 Whole",value:64},{name:"32 Whole",value:128},{name:"64 Whole",value:256}];n.foreach(function(x){MEPH.util.Dom.addOption(x.name,x.value,q);MEPH.util.Dom.addOption(x.name,x.value,u)});a.getWindowfunctions().foreach(function(z){MEPH.util.Dom.addOption(z.name,z.value,l)});var k={marker:m,dom:d,targetbtn:y,anchorbtn:f,destroy:function(){}};var v=function(z,A,x){return 1/(z/60)*A*x};p.innerHTML=Math.round(100*parseFloat(k.marker.stretch))/100;a.don("change",q,function(C){var D=parseFloat(q.value);var B=parseFloat(a.beatsPerMin);if(B&&a.source&&a.source.buffer){var z=a.source.buffer.buffer.sampleRate;var A=v(B,D,z);var x=A/C.marker.targetposition;C.marker.stretch=x;a.update()}}.bind(a,k));a.don("change",l,function(z){var x=l.value;if(MEPH.math.Util.window[x]){z.marker.windowFunc=x;a.update()}}.bind(a,k));a.don("change",w,function(z){if(MEPH.math.Util.window[z.marker.windowFunc]){var x=parseFloat(w.value);z.marker.windowFuncValue=x;a.update()}}.bind(a,k));a.don("change",u,function(B){var C=parseFloat(u.value);var A=parseFloat(a.beatsPerMin);if(A&&a.source&&a.source.buffer){var x=a.source.buffer.buffer.sampleRate;var z=v(A,C,x);B.marker.targetposition=z;a.update()}}.bind(a,k));a.don("click",h,function(E){var x=a.getBufferSampleRate();var D=E.marker.windowFunc?a.createWindow(E.marker.targetposition,E.marker.windowFunc,E.marker.windowFuncValue):null;var A=MEPH.audio.Audio.clipBuffer(a.source,E.marker.position,E.marker.position+E.marker.targetposition,null,D);var B=A.buffer.buffer.getChannelData(0);var z=new MEPH.audio.Audio();var C=z.copyToBuffer(A,0,B.length/x);a.markCanvas.dispatchEvent(MEPH.createEvent("saveclip",{snippets:[A]}))}.bind(a,k));a.don("click",g,function(D){var x=a.getBufferSampleRate();var A=MEPH.audio.Audio.clipBuffer(a.source,D.marker.position,D.marker.position+D.marker.targetposition);var B=A.buffer.buffer.getChannelData(0);var z=new MEPH.audio.Audio();var C=z.copyToBuffer(A,0,B.length/x);a.$playSnippet(C)}.bind(a,k));a.don("click",o,function(F){var x=a.getBufferSampleRate();var B=a.getCache({sampleRate:x,position:F.marker.position,targetposition:F.marker.targetposition,stretch:F.marker.stretch});if(B){var E=F.marker.windowFunc?a.createWindow(F.marker.targetposition,F.marker.windowFunc,F.marker.windowFuncValue):null;var A=MEPH.audio.Audio.clipBuffer(a.getResource(B.resource,B.sampleRate),0,B.resource.length,null,E);var C=A.buffer.buffer.getChannelData(0);var z=new MEPH.audio.Audio();var D=z.copyToBuffer(A,0,C.length/x);a.markCanvas.dispatchEvent(MEPH.createEvent("saveclip",{snippets:[D]}))}}.bind(a,k));a.don("click",s,function(B){var C=new MEPH.audio.Audio();var F=a.getBufferSampleRate();var G=a.getCache({sampleRate:F,position:B.marker.position,targetposition:B.marker.targetposition,stretch:B.marker.stretch});if(G){var A=C.copyToBuffer(a.getResource(G.resource,G.sampleRate),0,G.resource.length/G.sampleRate);a.$playSnippet(A);return}var x=MEPH.audio.Audio.clipBuffer(a.source,B.marker.position,B.marker.position+B.marker.targetposition);var E=x.buffer.buffer.getChannelData(0);var z=a.$signalProcessor;var D=z.modifySignal(1,[{start:0,scale:0},{start:1,scale:B.marker.stretch||1}],4096,8,F,E);var A=C.copyToBuffer(a.getResource(D,F),0,D.length/F);a.cacheAudio({resource:D,sampleRate:F,position:B.marker.position,targetposition:B.marker.targetposition,stretch:B.marker.stretch});a.$playSnippet(A)}.bind(a,k));a.don("click",j,function(x){a.$addMark(x.marker.position)}.bind(a,k));a.don("click",t,function(x){a.$addMark(x.marker.position+x.marker.targetposition)}.bind(a,k));a.don("click",c,function(x){a.stretchmarks.removeWhere(function(z){return z===x.marker});d.parentNode.removeChild(d);a.update()}.bind(a,k));a.don("mouseover",d,function(){Style.show(e)});a.don("mouseout",d,function(){Style.hide(e)});a.don("change",r,function(x){p.innerHTML=Math.round(100*parseFloat(r.value))/100;x.marker.stretch=parseFloat(r.value);a.update()}.bind(a,k));a.don("click",f,function(z){a.toggleStretchMarkerDrag(z,"dom")}.bind(a,k));a.don("click",y,function(z){a.toggleStretchMarkerDrag(z,"targetbtn")}.bind(a,k));return k})},cacheAudio:function(b){var a=this;a.$audioCache=a.$audioCache||[];a.$audioCache.push(b);if(a.$audioCache.length>a.maxCache){a.$audioCache=a.$audioCache.subset(a.maxCache-a.$audioCache.length)}},getCache:function(b){var a=this;a.$audioCache=a.$audioCache||[];return a.$audioCache.first(function(d){for(var c in b){if(b[c]!==d[c]){return false}}return true})},toggleStretchMarkerDrag:function(a,c){var b=this;if(!b.stretchdrag){b.stretchdrag={marker:a.marker,target:c,callback:function(){b.positionStretchControls(a);b.update()}}}else{b.stretchdrag=false}},onMouseMove:function(){var b=this,c;if(b.stretchdrag){c=MEPH.util.Dom.getEventPositions(MEPH.Array(arguments).last().domEvent).first();if(c){c.x+=-50;var a=b.getAbsoluteMarkPosition(c.x/b.width);switch(b.stretchdrag.target){case"targetbtn":b.stretchdrag.marker.targetposition=a-b.stretchdrag.marker.position;break;default:b.stretchdrag.marker.position=a;break}b.stretchdrag.callback()}}else{b.great()}},getResource:function(a,b){b=b||44100;var c={buffer:{buffer:{getChannelData:function(){return a},sampleRate:b},channelCount:1}};return c},positionStretchControls:function(d){var c=this;var b=c.getRelativeMarkPosition(d.marker.position);var a=c.getRelativeMarkPosition(d.marker.position+d.marker.targetposition);d.dom.style.left=(b)+"px";d.dom.style.top=(c.offsetstretchvertical)+"px";Style.top(d.targetbtn,(0));Style.left(d.targetbtn,(a-b))},createNewMarkerBtns:function(a){var b=this;return a.select(function(c,d){var f=b.createMarkerBtn();var e=f.querySelector("[removebtn]");b.don("click",e,function(g){b.marks.removeWhere(function(h){return h===g})}.bind(b,c));b.don("click",f.querySelector("[playbtn]"),function(g){console.log("play snippet");b.playSnippet(g)}.bind(b,c));return{marker:c,dom:f}})},playSnippet:function(f){var e=this;var b=e.marks.orderBy(function(g,h){return g.position-h.position});e.marks.length=0;e.marks.push.apply(e.marks,b);var c=e.marks.indexWhere(function(g){return g.position===f.position}).first();if(c!==null){var a=e.marks[c+1]?e.marks[c+1].position:e.source.buffer.buffer.length;var d=MEPH.audio.Audio.clipBuffer(e.source,f.position,a);e.$playSnippet(d)}},createMarkerBtn:function(){var a=this;var b=a.markerBtnTemplate.cloneNode(true);a.markerCanvas.parentNode.appendChild(b);return b},createStretchMark:function(){var a=this;var b=a.stretchMarkTemplate.cloneNode(true);a.stretcherCanvas.parentNode.appendChild(b);return b},update:function(){var a=this;return Promise.resolve().then(function(){a.updateMarkBtns();a.updateStretchControls()}).then(function(){return a.updateMarks()}).then(function(){return a.updateMarker()}).then(function(){return a.updateStretcher()}).then(function(){a.draw()}).then(function(){a.renderAreasOfInterest()})},updateBpm:function(){var a=this;if(a.source){MEPH.audio.Audio.bpm(a.source.buffer).then(function(b){if(b&&b.length){var c=b.subset(0,4).orderBy(function(d,e){return e.count-d.count}).select(function(d,e){return"Tempo :"+d.tempo+"(Score:"+d.count+")  "}).join("|");setTimeout(function(){a.calculatedBpm=c},10)}})["catch"](function(b){MEPH.Log(b)})}},updateMarks:function(){var a=this;return a.render()},updateStretcher:function(){var b=this;if(b.stretcherFrame){cancelAnimationFrame(b.stretcherFrame)}if(b.stretcherrenderer){b.stretcherrenderer.clear()}b.stretcherFrame=requestAnimationFrame(function(){b.stretcherFrame=null;var e=b.height;var d=b.width;if(!b.stretcherrenderer){b.stretcherrenderer=new MEPH.util.Renderer();b.stretcherrenderer.setCanvas(b.stretcherCanvas)}b.stretcherrenderer.clear();if(b.stretchmarks){var c=b.stretchmarks.concatFluent(function(o){var k=b.getRelativeMarkPosition(o.position);var f=b.getRelativeMarkPosition(o.position+o.targetposition);var i=o.targetposition;var j=b.getRelativeMarkPosition(o.position+i*(o.stretch||1));var n=[{shape:MEPH.util.Renderer.shapes.polygon,lb:{x:k,y:e/2},rb:{x:f,y:e/2},rt:{x:j,y:b.offsetstretchvertical},lt:{x:k,y:b.offsetstretchvertical},fillStyle:b.markscolorbg},{shape:MEPH.util.Renderer.shapes.line,lineWidth:b.stretchlinewidth,end:{x:f,y:e/2},start:{x:j,y:b.offsetstretchvertical},strokeStyle:b.markscolor},{shape:MEPH.util.Renderer.shapes.line,lineWidth:b.stretchlinewidth,end:{x:k,y:e/2},start:{x:k,y:b.offsetstretchvertical},strokeStyle:b.markscolor}];if(o.windowFunc){var g=Math.floor(f-k);var h=4;var m=10;var l=(g/m);b.createWindow(l,o.windowFunc,o.windowFuncValue).select(function(p,q){return{shape:MEPH.util.Renderer.shapes.circle,lineWidth:b.stretchlinewidth,y:e/2-e/2*p+(b.windowpadding||0),x:q*m+k,fillStyle:b.windowingcolor,radius:h}}).foreach(function(p){n.push(p)})}return n});b.renderer.draw(c)}a()});var a;return new Promise(function(c){a=c})},createWindow:function(e,c,d){d=d*e||0;var b=d/2+e/2;var a=e/2-d/2;return[].interpolate(0,e,function(g){var f=MEPH.math.Util.window[c](g,e);if(b>g&&a<g){f=1}else{if(g<a){f=MEPH.math.Util.window[c](g,e-d)}else{f=MEPH.math.Util.window[c](g-d,e-d)}}return f})},updateMarker:function(){var b=this;if(b.markerFrame){cancelAnimationFrame(b.markerFrame)}b.markerFrame=requestAnimationFrame(function(){var e=b.height;var d=b.width;b.markerFrame=null;if(!b.markerrenderer){b.markerrenderer=new MEPH.util.Renderer();b.markerrenderer.setCanvas(b.markerCanvas)}b.markerrenderer.clear();var c=b.getMarkerPosition();b.markerrenderer.draw({shape:MEPH.util.Renderer.shapes.line,end:{x:c,y:e},start:{x:c,y:0},strokeStyle:b.markercolor});a()});var a;return new Promise(function(c){a=c})},stectchClip:function(){var b=this,c=b.source,a=parseFloat(b.stretchValue)||1;if(c){b.source=MEPH.audio.Audio.stretch(c,a)}},render:function(){var b=this;if(b.markframe){cancelAnimationFrame(b.markframe)}b.markframe=requestAnimationFrame(function(){var f=b.height;var e=b.width;var c=b.source;b.markframe=null;if(!b.renderer){b.renderer=new MEPH.util.Renderer();b.renderer.setCanvas(b.markCanvas)}b.renderer.clear();if(b.marks){var d=b.marks.select(function(g){var h=b.getRelativeMarkPosition(g.position,b.magnification,b.timeScroll);return{shape:MEPH.util.Renderer.shapes.line,end:{x:h,y:f},start:{x:h,y:0},strokeStyle:b.markscolor}});b.renderer.draw(d)}a()});var a;return new Promise(function(c){a=c})}});
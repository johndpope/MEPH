MEPH.define("MEPH.audio.view.AudioSequencer",{alias:"audiosequencer",templates:true,scripts:["MEPH.audio.view.sequencer.CanvasContextMenu","MEPH.audio.view.sequencer.SequencerResourcesSelect","MEPH.audio.view.sequencer.CanvasHeaderLeftMenu"],extend:"MEPH.table.Sequencer",requires:["MEPH.audio.Audio","MEPH.audio.music.theory.Notes","MEPH.audio.AudioResources","MEPH.input.Text","MEPH.audio.view.AudioSignalVisualizer","MEPH.audio.Sequence","MEPH.util.FileReader","MEPH.audio.graph.AudioGraph","MEPH.input.Checkbox","MEPH.input.Range","MEPH.util.Dom","MEPH.input.Number","MEPH.input.Dropdown","MEPH.file.Dropbox","MEPH.audio.Constants","MEPH.audio.music.theory.Scales","MEPH.util.Observable"],statics:{TrackResource:"TrackResource",ContextMenu:"ContextMenu",Play:"Play"},injections:["audioResources","fileSaver","recorder","scheduler"],properties:{firstMidiNote:null,lastMidiNote:null,selectedSoundFontValue:null,defaultColumnWidth:25,nearest:32,singleUnit:1,sequence:null,animatemode:true,currentSoundFontSelection:null,smallestnote:16,scalevalue:1,selectedSoundFont:null,fontlistsource:null,defaultBpm:75,beatspermin:null,selectedSoundFontChunks:null,resources:null,scales:null,triadExtensions:null,availableShortCutKeys:null,selectedShortCutKey:null,chordShortCuts:null,selectedTriadExtensionType:null,triadTypes:null,timeLength:null,whistleBuffer:null,currentChord:null},initialize:function(){var a=this;a.setupFunctions();a.setupKeyCommands();Object.defineProperty(a,"bpm",{get:function(){var b=a.beatspermin;return(1/(b/60))*(1/a.smallestnote)}});a.great();if(!a.sequence){a.sequence=new MEPH.audio.Sequence()}a.on("altered",function(c,b){if(b.property==="sequence"){a.translateToSource(a.sequence)}if(b.property==="beatspermin"){a.updateBeat()}if(b.property==="commands"||b.property==="chordShortCuts"){a.updateAvailableShortCutKeys()}});a.setupHeaders();MEPH.subscribe(MEPH.audio.Constants.RECORDING_COMPLETE,function(d,b){var c=prompt("Save As : ","");MEPH.publish(MEPH.Constants.REQUEST_BLOB_SAVE,b,c+".wav")});MEPH.subscribe("removekey",function(c,b){a.commands.removeWhere(function(d){return d.key===b});a.chordShortCuts.removeWhere(function(d){return d.key===b})});MEPH.subscribe(MEPH.audio.Constants.VIEW_RESOURCE,function(b,d,c){if(a.$inj.audioResources){var d=a.$inj.audioResources.getResourceById(d);switch(d.type){case"soundfont":a.showSoundFont(d);break;default:if(d.nodes){var e=a.addTrackSequence(d.name);e.setDefault("graph",d.id)}break}}})},onLoaded:function(){var a=this;a.great();a.beatspermin=a.defaultBpm;a.firstMidiNote=0;a.lastMidiNote=192;a.resources=MEPH.util.Observable.observable([]);a.fontlistsource=MEPH.util.Observable.observable([]);a.currentSoundFontSelection=MEPH.util.Observable.observable([]);a.scales=[{id:null,name:"none"}].concat(TheoryScales.getScales());a.setupHeaders();a.sequence.title=a.sequence.title||"untitled";a.fire("altered",{path:"sequence"});document.body.appendChild(a.soundfontlistholder);document.body.appendChild(a.audiographholder);document.body.appendChild(a.resourceloader);document.body.appendChild(a.shortcutconfigpanel);a.hideSoundFontList();a.hideParts(a.audiographholder,a.hideGraph.bind(a));a.hideParts(a.whistlinlistenin,a.hideWhistlin.bind(a));a.hideParts(a.soundfontlistholder,a.hideSoundFontList.bind(a));a.hideParts(a.resourceloader,a.hideResource.bind(a));a.hideParts(a.shortcutconfigpanel,a.hideShortCutConfigPanel.bind(a));a.triadTypes=[{name:"",text:"",triad:[]},{name:"Major",text:"major",triad:["0","4","7"]},{name:"Minor",text:"minor",triad:["0","3","7"]},{name:"Dim",text:"dim",triad:["0","3","6"]},{name:"Aug",text:"aug",triad:["0","4","8"]},{name:"Sus4",text:"sus4",triad:["0","5","7"]},{name:"Sus2",text:"sus2",triad:["0","2","7"]},{name:"Flat2nd",text:"flat2nd",triad:["0","1","7"]},{name:"Sharp4th",text:"sharp4th",triad:["0","6","7"]}];a.triadExtensions=[{text:"",ext:[]},{text:"Maj 7th",ext:["b"]},{text:"Dom 7th",ext:["a"]},{text:"Maj 9th",ext:["b","12"]},{text:"Dom 9th",ext:["a","12"]},{text:"Maj 11th",ext:["b","12","15"]},{text:"Dom 11th",ext:["a","12","15"]}];a.chordShortCuts=MEPH.util.Observable.observable([]);a.chordShortCuts.on("changed",function(){a.updateAvailableShortCutKeys()});a.updateAvailableShortCutKeys()},hideWhistlin:function(){var a=this;Style.hide(a.whistlinlistenin)},showShortCuts:function(){var a=this;Style.show(a.chordshortcuts)},hideShortCuts:function(){var a=this;Style.hide(a.chordshortcuts)},showWhistlin:function(){var a=this;Style.show(a.whistlinlistenin)},updateAvailableShortCutKeys:function(){var b=this,a="abcdefghijklmnopqrstuvwxyz,./;[]".split("");a=a.where(function(c){var d=b.commands.first(function(e){return e.key===c});return d===null}).select(function(c){return{text:c}});b.availableShortCutKeys=a},hideParts:function(b,a){var c=this;c.don("click",document.body,function(d){if(!MEPH.util.Dom.isDomDescendant(d.srcElement,b)&&!d.srcElement.classList.contains("form-control")){a()}});a()},createAudioGraph:function(){var a=this;return a.renderControl("MEPH.audio.graph.AudioGraph",a.audiographholder,a)},loadResources:function(){var a=this;return MEPH.util.FileReader.readFileList(MEPH.Array(arguments).last().domEvent.files,{readas:"ArrayBuffer"}).then(function(b){if(a.$inj&&a.$inj.audioResources){a.$inj.audioResources.addResources(b).then(function(){a.updateResources()})}})},updateResources:function(){var a=this;if(a.$updateTimeout){clearTimeout(a.$updateTimeout)}a.$updateTimeout=setTimeout(function(){var b=a.$inj.audioResources.getResources();a.resources=b.select(function(c){if(c.resource&&c.resource.file){return({name:c.resource.file.name,id:c.id,type:"font"})}else{if(c.name){return({name:c.name,id:c.id,type:"graph"})}}})},1000)},viewResource:function(c,a){var b=this;MEPH.publish(MEPH.audio.Constants.VIEW_RESOURCE,c,a)},openResources:function(){var a=this;a.showResource()},showResource:function(){var a=this;Style.show(a.resourceloader);a.$resourcehidden=false;a.updateResources()},hideResource:function(){var a=this;if(a.$resourcehidden){return}Style.hide(a.resourceloader);a.$resourcehidden=true},showShortCutConfigPanel:function(){var a=this;Style.show(a.shortcutconfigpanel);a.$shotcutConfigPanelHidden=false},hideShortCutConfigPanel:function(){var a=this;if(a.$shotcutConfigPanelHidden){return}Style.hide(a.shortcutconfigpanel);a.$shotcutConfigPanelHidden=true},hideSoundFontList:function(){var a=this;if(a.$fontlisthidden){return}Style.hide(a.soundfontlistholder);a.$fontlisthidden=true},showSoundFontList:function(){var a=this;Style.show(a.soundfontlistholder);a.$fontlisthidden=false},showSoundFont:function(c){var b=this,a=c.soundfontInstrument;b.hideAll();var d=a.sampleChunks();b.selectedSoundFontId=c.id;b.selectedSoundFont=a.$soundfontfile;b.selectedSoundFontChunks=d.select(function(e){return({name:e.name,id:e.id,sid:c.id})});b.showSoundFontList()},selectSoundFontNotes:function(){var b=this,c,a;c=b.selectedScale;b.currentSoundFontSelection.clear();if(c==="none"||!c){a=[].interpolate(parseInt(b.firstMidiNote),parseInt(b.lastMidiNote)+1,function(d){return d})}else{a=TheoryScales.getNotesInScale(c,parseInt(b.firstMidiNote),parseInt(b.lastMidiNote)+1)}a=a.select(function(d){return{name:Notes.convertToNote(d),id:d,midi:d,selected:true,sid:b.selectedSoundFontId}});a.foreach(function(d){b.currentSoundFontSelection.push(d)})},toNote:function(b){var a=Notes.convertToNote(b);return a},addToSelection:function(a){var b=this;var c=b.selectedSoundFontChunks.first(function(d){return d.id.toString()===a});if(c){b.currentSoundFontSelection.push(c)}},addAllChunks:function(){var a=this;a.currentSoundFontSelection.clear();a.selectedSoundFontChunks.foreach(function(b){b.selected=true;a.currentSoundFontSelection.push(b)})},addToSequence:function(){var a=this;a.currentSoundFontSelection.where(function(b){return b.selected}).foreach(function(b){var c=a.addTrackSequence(b.name);c.setDefaultSoundFont({sid:b.sid,id:b.id});if(b.midi){c.midiNote(b.midi)}});a.currentSoundFontSelection.clear()},hideAll:function(){var a=this;a.hideGraph();a.hideSoundFontList();a.hideResource()},hideGraph:function(){var a=this;if(a.$graphhidden){return}Style.hide(a.audiographholder);if(a.editedSequence){a.editedSequence.saveGraph(a.audiographinstance.saveGraph());a.editedSequence=null}a.$graphhidden=true},showGraph:function(){var a=this;a.$graphhidden=false;Style.show(a.audiographholder)},showGraphForSequence:function(){var c=this,d=MEPH.clone(c.hovercells),a=d.first().row;var b=c.sequence.items()[a];if(b){return Promise.resolve().then(function(){return c.audiographinstance||c.createAudioGraph()}).then(function(f){if(!c.audiographinstance){var e=f.first();c.audiographinstance=e.classInstance}}).then(function(){c.showGraph()}).then(function(){c.editedSequence=b.source;return c.audiographinstance.loadGraph(JSON.stringify(b.source.getGraph()))}).then(function(){c.audiographinstance.resize()})}},updateBeat:function(){var a=this;if(a.$inj&&a.$inj.scheduler){a.$inj.scheduler.bpm=a.bpm}},onInjectionsComplete:function(){var a=this;a.updateBeat()},addShortcut:function(){var a=this,b={triad:a.selectedTriadType,triadExt:a.selectedTriadExtensionType,key:a.selectedShortCutKey};if(a.selectedShortCutKey){a.setCommand(b.key,b.key+" : shortcut set current chord",a.setCurrentChord.bind(a,b));a.chordShortCuts.push(b);a.selectedShortCutKey=null;a.selectedTriadExtensionType=null;a.selectedTriadType=null}},setCurrentChord:function(b){var a=this;a.currentChord=b},removeShortCut:function(a){MEPH.publish("removekey",a)},saveSequence:function(){var a=this;if(a.$inj&&a.$inj.audioResources){a.$inj.audioResources.addSequence(a.sequence)}},loadGrandPiano:function(){var a=this;a.pianoloaded=true;return MEPH.requires("MEPH.audio.music.instrument.piano.GrandPiano").then(function(b){var c=new MEPH.audio.music.instrument.piano.GrandPiano();return c.ready().then(function(){var d=c.createSequence();if(a.$inj&&a.$inj.audioResources){a.$inj.audioResources.addSequence(d);a.openSequence(d.id)}})})},newSequence:function(){var a=this;a.sequence=new MEPH.audio.Sequence();a.update()},openSequence:function(b){var a=this;if(a.$inj&&a.$inj.audioResources){a.sequence=a.$inj.audioResources.getSequenceInstance(b)||a.sequence}},setupHeaders:function(){var b=this,a=2000,c=88;b.leftheadersource=[].interpolate(0,c,function(d){return MEPH.util.Observable.observable({lane:d,time:d,length:1})});b.topheadersource=[].interpolate(0,a,function(d){return MEPH.Observable.observable({lane:0,time:d,length:1})});b.rowheaders=1;b.columnheaders=1;b.columns=a;b.rows=c},setupKeyCommands:function(){var a=this;a.setContextMenuOpenKey("v");a.setTrackResourceOpenKey("t");a.setDurationKeys();a.setRemoveKey("x");a.setSequenceGraphMod("m");a.setPlayButton("p");a.setClearCurrentChord("q");a.updateAvailableShortCutKeys()},translateToSource:function(b){var a=this;if(!a.source){a.source=b.itemSequences()}else{a.source.clear();a.source.push.apply(a.source,b.itemSequences())}},setupFunctions:function(){var a=this;a.time={"function":function(b,c){if(b&&(b.source instanceof MEPH.audio.Audio||b.source instanceof MEPH.audio.Sequence)||typeof b.source==="string"){return a.scaleValue(b.relativeTimeOffset)}if(c==="left"){return 0}return b.time}};a.lane={"function":function(b,c){if(b&&(b.source instanceof MEPH.audio.Audio||b.source instanceof MEPH.audio.Sequence||typeof b.source==="string")){return a.sequence.getParentIndexOf(b)}return b.lane}};a.settime={"function":function(c,b){if(b&&(b.source instanceof MEPH.audio.Audio||b.source instanceof MEPH.audio.Sequence||typeof b.source==="string")){c=Math.round(c*a.nearest)/a.nearest;c=a.scaleValue(c);a.sequence.setRelativeTime(b,c);a.update()}return b}};a.color={"function":function(f){var b="#ff0000";if(f&&(f.source instanceof MEPH.audio.Audio||f.source instanceof MEPH.audio.Sequence)){var h=a.sequence.getDuration(f);b=a.getColorForDuration(h)}else{if(f&&typeof f.source==="string"){if(f.duration===null){var d=f.getAudio();var c;if(d.getSourceDuration){c=d.getSourceDuration()}if(c){try{c=c*(parseFloat(a.beatspermin)/60)*a.smallestnote}catch(g){c=0}}return a.getColorForDuration(a.singleUnit)}b=a.getColorForDuration(f.duration)}}return b}};a.length={"function":function(f){var b;if(f&&(f.source instanceof MEPH.audio.Audio||f.source instanceof MEPH.audio.Sequence)){var h=a.sequence.getDuration(f);b=h}else{if(f&&typeof f.source==="string"){if(f.duration===null){var d=f.getAudio();var c;if(d.getSourceDuration){c=d.getSourceDuration()}if(c){try{c=c*(parseFloat(a.beatspermin)/60)*a.smallestnote}catch(g){c=0}}return a.singleUnit}b=f.duration}}return a.scaleValue(b)}};a["delete"]={"function":function(b){if(b){b.foreach(function(d){var c=a.sequence.getParent(d);if(c){c.source.remove(d)}});a.translateToSource(a.sequence);a.update()}}};a.rowheader={"function":function(c){var b=a.sequence.items()[c.lane];return b&&b.source?(b.source.title||""):""}};a.columnheader={"function":function(b){return b.time%a.smallestnote===0?(b.time/a.smallestnote)+" ":null}}},getColorForDuration:function(a){a=parseFloat(a);if(isNaN(a)){a=0}if(a>=32){return"#dabfff"}else{if(a>=16){return"#907ad6"}else{if(a>=8){return"#4f518c"}else{if(a>=4){return"#2c2a4a"}else{if(a>=2){return"#7fdeff"}else{if(a>=1){return"#204442"}else{if(a>=-1){return"#7956f"}}}}}}}},scaleValue:function(b){var a=this;return parseFloat(a.scalevalue)*b},unscaleValue:function(b){var a=this;return b/parseFloat(a.scalevalue)},openContextMenu:function(b){var e=this,d;var g=e.hovercells;if(b.currentTarget===e.leftheader){var c=e.getTemplateEl("MEPH.audio.view.sequencer.CanvasHeaderLeftMenu");var a=c.querySelector("input");a.focus();var f;Dom.addSimpleDataEntryToElments(e,[{element:a,setFunc:function(h){f=h}}],c,function(){if(f){e.addTrackSequence(f)}});Dom.centerElement(c)}else{e.addSequence(g.first())}},onInjectionsComplete:function(){var a=this;if(a.$inj.audioResources){MEPH.subscribe(MEPH.audio.AudioResources.RESOURCE_MANAGER_UPDATE,function(){a.updateResources()})}},openSavedSequence:function(){var a=this;return new Promise(function(f){if(a.$inj.audioResources){var d=a.getTemplateEl("MEPH.audio.view.sequencer.SequencerResourcesSelect");var b=d.querySelector("select");b.focus();var e;var g=a.$inj.audioResources.getSequences();var c=g.select(function(h,i){return{title:h.title,value:h.id}});c.foreach(function(h){Dom.addOption(h.title,h.value,b)});Dom.addSimpleDataEntryToElments(a,[{element:b,setFunc:function(h){e=h}}],d,function(){var h=g.first(function(i){return i.id===e});if(h){a.openSequence(h.id)}f()})}})},selectTrackResource:function(i){var e=this;var c=MEPH.clone(e.hovercells);if(e.$inj.audioResources&&c){var b=e.getTemplateEl("MEPH.audio.view.sequencer.SequencerResourcesSelect");var g=b.querySelector("select");g.focus();var h;var d=e.$inj.audioResources.getGraphs();var f=e.$inj.audioResources.getSequences();var a=d.select(function(j,k){return{title:j.name,value:j.id}});f.foreach(function(j){a.push({title:j.title,value:j.id})});a.foreach(function(j){Dom.addOption(j.title,j.value,g)});Dom.addSimpleDataEntryToElments(e,[{element:g,setFunc:function(j){h=j}}],b,function(){var j=d.first(function(k){return k.id===h})||f.first(function(k){return k.id===h});e.setTrackResource(c.first().row,j)})}},setTrackResource:function(a,c){var b=this,d=b.sequence.items()[a];if(d){d.source.setDefault(c instanceof MEPH.audio.Sequence?"sequence":"graph",c.id)}},addTrackSequence:function(b){var a=this,c=new MEPH.audio.Sequence({title:b});a.sequence.add(c);a.update();return c},getCurrentChord:function(){var b=this,a;if(b.currentChord){var a=b.triadTypes.first(function(d){return d.text===b.currentChord.triad});var c=b.triadExtensions.first(function(d){return d.text===b.currentChord.triadExt});if(a&&c){return a.triad.concat(c.ext)}else{if(a){return a.triad.select()}else{if(c){return c.ext.select()}}}}return null},addSequence:function(a){var d=this,h,g=a.row,c=a.column;h=d.getSequenceItem(g);if(h){var e=d.getCurrentChord();var f=h.source.midiNote();if(e&&f!==null&&f!==undefined){d.addChordSequence(e,f,c)}else{h.source.add(null,d.unscaleValue(c));d.translateToSource(d.sequence);var b=h.source.parts.last();d.drawSingleDataItem(b)}}},getSequenceNotes:function(c){var d=this,e=d.sequence,a=e.items();var b=c.select(function(f){return a.first(function(g){return g.source.midiNote()===f})});return b},removeSequence:function(){var d=this,a=d.hovercells.first(),f,e=a.row,c=a.column;f=d.getSequenceItem(e);if(f&&d.lastitem){var b=f.source.remove(d.lastitem);d.translateToSource(d.sequence);d.update()}},addSequenceDuration:function(i){var g=this,h=g.hovercells.first(),d,j=h.row,c=h.column;d=g.getSequenceItem(j);if(d){var e=g.getCurrentChord();var a=d.source.midiNote();if(e&&a!==null&&a!==undefined){g.addChordSequence(e,a,c,i)}else{var f=d.source.add(null,g.unscaleValue(c),g.getDuration(i));g.translateToSource(g.sequence);var b=d.source.parts.last();g.drawSingleDataItem(b)}}},addChordSequence:function(e,f,c,b){var d=this;if(e&&f!==null&&f!==undefined){var a=Notes.midiNotes(f,e);var g=d.getSequenceNotes(a).where();itemtodraw=g.concatFluent(function(i){i.source.add(null,d.unscaleValue(c),b?d.getDuration(b):null);var h=i.source.parts.last();return h});d.drawSingleDataItem(itemtodraw);d.translateToSource(d.sequence)}},removeSelectedSequences:function(b){var a=this;a.deleteSelected()},getDuration:function(a){switch(a){case"1":return 16;case"2":return 8;case"3":return 6;case"4":return 4;case"5":return 2;case"6":return 1;case"0":return 64;case"9":return 32;case"8":return 24;case"7":return 20;default:return 1}},getSequenceItem:function(b){var a=this;return a.sequence.items()[b]||null},setTrackResourceOpenKey:function(a){var b=this;b.setCommand(a,MEPH.audio.view.AudioSequencer.TrackResource,b.selectTrackResource.bind(b))},saveSequenceAsWave:function(){var a=this;if(a.$inj&&a.$inj.scheduler){a.$inj.scheduler.render().then(function(b){MEPH.publish(MEPH.audio.Constants.REQUEST_RECORDING,{buffer:{buffer:b.renderedBuffer}})})}},setPlayButton:function(a){var b=this;b.setCommand(a,MEPH.audio.view.AudioSequencer.Play,function(){if(b.$inj&&b.$inj.scheduler){if(!b.$inj.scheduler.playing){b.$inj.scheduler.sequence(b.sequence);b.$inj.scheduler.play()}else{b.$inj.scheduler.sequence(b.sequence);b.$inj.scheduler.stop()}}});b.setCommand("r","render",function(){if(b.$inj&&b.$inj.scheduler){b.$inj.scheduler.render().then(function(c){;var d=c})["catch"](function(c){})}})},setCommand:function(a,d,c){var b=this,e;b.commands=b.commands||[];e=b.commands.first(function(f){return f.command===d});if(!e){e={command:d,"function":c};b.commands.push(e)}e.key=a.toLowerCase()},setContextMenuOpenKey:function(a){var b=this;b.setCommand(a,MEPH.audio.view.AudioSequencer.ContextMenu,b.openContextMenu.bind(b))},setSequenceGraphMod:function(a){var b=this;b.setCommand(a,"sequencegraphmod",b.showGraphForSequence.bind(b))},setClearCurrentChord:function(a){var b=this;b.setCommand(a,"clearurrentchord",function(){b.currentChord=null})},setRemoveKey:function(a){var b=this;b.setCommand(a,"RemoveSequence",b.removeSequence.bind(b))},setDurationKeys:function(){var a=this;[1,2,3,4,5,6,7,8,9,0].foreach(function(b){a.setCommand(b.toString(),"AddSequence"+b,a.addSequenceDuration.bind(a,b.toString()))})},rowDrawInstruction:function(){return null},recordWhistle:function(){var a=this;if(!a.$whistleRecorder&&parseFloat(a.timeLength)){a.$whistleRecorder=new MEPH.audio.Audio();a.$whistleRecorder.mediastream({callback:function(c){var b=document.createElement("video");document.body.appendChild(b);b.src=(window.URL&&window.URL.createObjectURL(c))||c;b.autoPlay=true;b.muted=true;b.onloadedmetadata=function(h){b.play();var f=a.$whistleRecorder.createContext();var d=Math.ceil(parseFloat(a.timeLength)*f.sampleRate);var g=f.createBuffer(2,d,f.sampleRate);var i=0;a.$whistleRecorder.processor({process:function(q){var m=q.inputBuffer;var e=q.inputBuffer.numberOfChannels;var j=m.length;var p;var k;for(var l=e;l--;){p=m.getChannelData(l);k=g.getChannelData(l);for(var o=0;o<j;o++){k[o+i]=p[o]}}i+=j;if(d<i){a.$whistleRecorder.disconnect();a.$whistleRecorder=null;var n=f.createBufferSource();n.buffer=g;a.whistleBuffer={buffer:n}}}}).complete()}}})}}});
MEPH.define("MEPH.audio.view.AudioSignalVisualizer",{alias:"audiosignalvisualizer",extend:"MEPH.audio.view.Visualizer",requires:["MEPH.input.Range","MEPH.util.Renderer","MEPH.signalprocessing.SignalProcessor"],templates:true,properties:{stop:100,position:0,step:0.0001,markBtnText:"Mark",max:null,min:null,marks:null,offsetbtnheight:19,marktype:"default",markercolor:"#d9534f",markscolor:"#f0ad4e",markerBtns:null,pitchShift:0.5,pitchWindowSize:1000,smallestStep:1e-7,silenceThreshold:0,silenceTimeSticky:0,silenceTimeThreshold:0,renderer:null,injectControls:{location:"buttonpanel"},detectedPitch:null,$signalProcessor:null,markerrenderer:null},initialize:function(){var a=this;a.great();a.markerBtns=[];a.$signalProcessor=new SignalProcessor();Observable.defineDependentProperty("silenceThresholdHeight",a,["silenceThreshold"],a.calculateSilenceThreholdHeight.bind(a));a.on("altered",function(c,b){if(b.path==="marks"){if(a.marks){a.marks.on("changed",a.update.bind(a))}a.update()}if(b.path==="vertical"||b.path==="scrollMutiplier"||b.path==="scrollleft"){a.update()}})},calculateSilenceThreholdHeight:function(){var c=this,a=c.height||0,b=c.silenceThreshold||0,d=a*b;Style.top(c.silenceThresholdDiv,(a/2)-(d/2));Style.height(c.silenceThresholdDiv,d);Style.width(c.silenceThresholdDiv,c.width);return d},addMark:function(){var c=this,a=c.getCurrentPosition();var b=c.getAbsoluteMarkPosition(a,c.magnification,c.timeScroll);if(c.marks&&!c.marks.some(function(d){return d.position===b})){c.marks.push({position:b,type:c.marktype})}},detectPitch:function(){var c=this,b=c.getSelectedClip();if(b){var a=MEPH.audio.Audio.updatePitch(b.buffer.buffer.getChannelData(0),c.source.buffer.buffer.sampleRate);c.detectedPitch=a}},getSelectedClip:function(){var d=this,b=d.getStartEndPosition();if(b){var e=b.start;var a=b.end;if(d.source){var c=d.getClip(d.source,e,a);return c}}return null},getStartEndPosition:function(){var b=this,d=b.width;if(b.selectedRange){var c=b.getAbsoluteMarkPosition(b.selectedRange.start/d)/b.source.buffer.buffer.sampleRate;var a=b.getAbsoluteMarkPosition((b.selectedRange.end)/d)/b.source.buffer.buffer.sampleRate;return{start:c,end:a}}return null},detectPitches:function(){var d=this,f=d.getStartEndPosition(),c=d.getSelectedClip();d.clearAreasOfInterest();if(c){var a=d.source.buffer.buffer.sampleRate;if(d.$detectedSilence){var b=d.$detectedSilence.select(function(g,h){if(h){return{start:d.$detectedSilence[h-1].end,end:d.$detectedSilence[h].start,length:d.$detectedSilence[h].start-d.$detectedSilence[h-1].end}}else{return{start:0,end:g.start,length:g.start}}});var e=b.where(function(g){return g.length>4000}).select(function(g){var h=d.getClip(c,g.start/a,(g.start+g.length)/a);var i=MEPH.audio.Audio.detectPitches(h.buffer.buffer.getChannelData(0),a,parseInt(d.pitchWindowSize));var k=new SignalProcessor();i=k.getNotes(h.buffer.buffer.getChannelData(0),a,4000,4096*2,512);var j=i.select(function(l){return l}).mostcommon(function(l){return l});return{start:g.start+f.start*a,end:g.end+f.start*a,key:{note:j}}});d.renderAreasOfInterest("pitches",e)}else{d.renderAreasOfInterest();var b=MEPH.audio.Audio.detectPitches(c.buffer.buffer.getChannelData(0),a,parseInt(d.pitchWindowSize));d.renderAreasOfInterest("pitches",b.select(function(g){return{start:g.start+f.start*a,key:g.key,end:g.end+f.start*a}}))}}},detectSilence:function(){var d=this,e=d.getStartEndPosition(),c=d.getSelectedClip();d.clearAreasOfInterest();if(c){var a=d.source.buffer.buffer.sampleRate;var b=MEPH.audio.Audio.detectSilence(c.buffer.buffer.getChannelData(0),parseFloat(d.silenceThreshold),parseFloat(d.silenceTimeThreshold),parseFloat(d.silenceTimeSticky));d.$detectedSilence=b;d.renderAreasOfInterest("silence",b.select(function(f){return{start:f.start+e.start*a,end:f.end+e.start*a}}))}},clearAreasOfInterest:function(){var b=this,a;areas=(b.$areasOfInterest||[]).select();areas.foreach(function(c){c.div.parentNode.removeChild(c.div)});b.$areasOfInterest=[]},renderAreasOfInterest:function(d,b){var e=this,a=e.container,c=(e.$areasOfInterest||[]).where(function(g){if(d===undefined){return true}return g.type===d});if(b===undefined){b=(e.$areasOfInterest||[]).select()}var f=b.select(function(g){var k=e.getRelativeMarkPosition(g.start);var i=e.getRelativeMarkPosition(g.end);if(i-k<5){return null}var j=c.unshift(),l;if(j){l=j.div}l=l||document.createElement("div");Style.height(l,e.height);Style.absolute(l);Style.top(l,0);l.classList.add("infoarea");l.classList.add("noresponse");if(d==="pitches"){l.classList.add("pitches");var h=document.createElement("h3");h.innerHTML=g.key.note;l.appendChild(h)}if(l.parentNode!==a){a.appendChild(l)}Style.left(l,k);Style.width(l,i-k);return{div:l,start:g.start,type:d||g.type,end:g.end}}).where();c.foreach(function(g){g.div.parentNode.removeChild(g.div)});e.$areasOfInterest=f},addSelectionAsMarks:function(){var b=this,d=b.width;if(b.selectedRange){var c=b.getAbsoluteMarkPosition(b.selectedRange.start/d);var a=b.getAbsoluteMarkPosition((b.selectedRange.end)/d);if(b.marks&&!b.marks.some(function(e){return e.position===c})){b.marks.push({position:c,type:b.marktype})}if(b.marks&&!b.marks.some(function(e){return e.position===a})){b.marks.push({position:a,type:b.marktype})}}},getAbsoluteMarkPosition:function(f,e,h){var i,g=this,c=g.width,d=g.getBuffer();if(d){var a=d.length*g.timeScroll;var b=(d.length*g.magnification);return(f*b)+a}},shiftPitch:function(){var d=this;var f=d.$signalProcessor;if(d.playingClip){d.playingClip.stop();return}var a=d.getBuffer();var h=d.getSnippet();var e;var g;if(!h){return}var c=new MEPH.audio.Audio();c.buffer(h.buffer,{name:"buffer"}).processor({name:"proce",process:function(i){var k=i.inputBuffer;var j=i.inputBuffer.getChannelData(0);var l=i.outputBuffer.getChannelData(0);f.pitchShift(parseFloat(d.pitchShift),j.length,j.length,4,d.source.buffer.buffer.sampleRate,j,l)}}).complete();var b=c.get({name:"buffer"});b.first().node.onended=function(){c.disconnect();delete d.playingClip;delete c;delete b.first().node};d.playingClip=b.first().node;d.playingClip.start()},getSnippet:function(){var e=this,f=e.source,d=new MEPH.audio.Audio(),c=parseFloat(e.magnification),a=parseFloat(e.timeScroll);if(e.source){var h=a*f.buffer.buffer.duration;var g=f.buffer.buffer.duration*c;var b=e.getClip(f,h,h+g);return b}return null},getClip:function(c,d,a){var b=MEPH.audio.Audio.clip(c,d,Math.min(c.buffer.buffer.duration,a));return b},playClip:function(){var b=this;if(b.playingClip){b.playingClip.stop();return}var a=b.getSnippet();if(a){a=b.$playSnippet(a)}},saveClip:function(){var b=this,a=b.getSnippet();if(!a){return}b.markCanvas.dispatchEvent(MEPH.createEvent("saveclip",{snippets:[a]}))},saveClips:function(){var c=this,d;if(!c.source){return null}d=c.source;var a=c.marks.orderBy(function(e,f){return e.position-f.position});c.marks.length=0;c.marks.push.apply(c.marks,a);var b=c.marks.select(function(e,g){if(g){var i=c.marks[g-1];var f=c.marks[g]?c.marks[g].position:d.buffer.buffer.length;var h=MEPH.audio.Audio.clipBuffer(c.source,i.position,f);return h}return false}).where();if(b.length){c.markCanvas.dispatchEvent(MEPH.createEvent("saveclip",{snippets:b}))}},cutSectionOut:function(){var c=this,e=c.width;if(c.selectedRange){var d=c.getAbsoluteMarkPosition(c.selectedRange.start/e);var a=c.getAbsoluteMarkPosition((c.selectedRange.end)/e);if(a-d>10){var b=MEPH.audio.Audio.cutOutSection(c.source,d,a,null);c.source.buffer=b.buffer}}},trimSection:function(){var c=this,e=c.width;if(c.selectedRange){var d=c.getAbsoluteMarkPosition(c.selectedRange.start/e);var a=c.getAbsoluteMarkPosition((c.selectedRange.end)/e);console.log("start : "+d+"  end "+a);if(a-d>10){c.marks.removeWhere(function(f){return f.position>a||f.position<d});c.marks.where(function(f){return f.position<a&&f.position>d}).foreach(function(f){f.position-=d});var b=MEPH.audio.Audio.clipBuffer(c.source,d,a,null);c.source.buffer=b.buffer}}},$playSnippet:function(c){var b=this;if(c){var a=new MEPH.audio.Audio();a.buffer(c.buffer.buffer,{name:"buffer"}).gain({name:"gain",volume:1}).complete();var c=a.get({name:"buffer"});c.first().node.onended=function(){a.disconnect();delete b.playingClip;delete a;delete c.first().node};b.playingClip=c.first().node;b.playingClip.start()}return c},getRelativeMarkPosition:function(b,f,a){var e=this,h=e.width,c=e.getBuffer();if(c){var g=c.length*e.timeScroll;b-=g;var d=(c.length*e.magnification);b/=d;return(b)*h}},getCurrentPosition:function(){var g=this;var c=parseFloat(g.position);var d=parseFloat(g.container.scrollLeft);var b=parseFloat(g.canvas.clientWidth);var h=parseFloat(g.container.clientWidth);var e=Math.min(h,b-d);var f=e*c;return(f+d)/b},getMarkerPosition:function(){var g=this;var c=parseFloat(g.position);var d=parseFloat(g.container.scrollLeft);var b=parseFloat(g.canvas.clientWidth);var h=parseFloat(g.container.clientWidth);var e=Math.min(h,b-d);var f=e*c;return(f+d)},scanToMark:function(c){var d=this,b=d.getBuffer();if(b){if(d.$currentMark===undefined){var e=d.marks.first();if(e){d.timeScroll=e.position/b.length;d.$currentMark=0}}else{d.$currentMark=(d.$currentMark+parseInt(c));if(d.$currentMark===d.marks.length){d.$currentMark=-1}if(d.$currentMark<-1){d.$currentMark=d.marks.length-1}if(d.$currentMark===-1){d.timeScroll=0;return}d.$currentMark=d.$currentMark%d.marks.length;var a=d.marks[d.$currentMark].position;d.timeScroll=a/b.length}}},updateMarkBtns:function(){var b=this;if(b.marks){var c=b.markerBtns.removeWhere(function(e){return !b.marks.some(function(f){return f===e.marker})});c.foreach(function(e){e.dom.parentNode.removeChild(e.dom)});var a=b.marks.where(function(e){return !b.markerBtns.some(function(f){return f.marker===e})});var d=b.createNewMarkerBtns(a);b.markerBtns.push.apply(b.markerBtns,d);b.markerBtns.foreach(function(f){var e=b.getRelativeMarkPosition(f.marker.position,b.magnification,b.timeScroll);f.dom.style.left=(e)+"px";f.dom.style.top=(b.height-b.offsetbtnheight)+"px"})}},getBufferSampleRate:function(){var b=this,a=b.getBuffer();if(a){return b.source.buffer.buffer.sampleRate}return null},getBufferLength:function(){var b=this,a=b.getBuffer();if(a){return a.length}return null},createNewMarkerBtns:function(a){var b=this;return a.select(function(c,d){var f=b.createMarkerBtn();var e=f.querySelector("[removebtn]");b.don("click",e,function(g){b.marks.removeWhere(function(h){return h===g})}.bind(b,c));b.don("click",f.querySelector("[playbtn]"),function(g){console.log("play snippet");b.playSnippet(g)}.bind(b,c));return{marker:c,dom:f}})},playSnippet:function(f){var e=this;var b=e.marks.orderBy(function(g,h){return g.position-h.position});e.marks.length=0;e.marks.push.apply(e.marks,b);var c=e.marks.indexWhere(function(g){return g.position===f.position}).first();if(c!==null){var a=e.marks[c+1]?e.marks[c+1].position:source.buffer.buffer.length;var d=MEPH.audio.Audio.clipBuffer(e.source,f.position,a);e.$playSnippet(d)}},createMarkerBtn:function(){var a=this;var b=a.markerBtnTemplate.cloneNode(true);a.markerCanvas.parentNode.appendChild(b);return b},update:function(){var a=this;return Promise.resolve().then(function(){a.updateMarkBtns()}).then(function(){return a.updateMarks()}).then(function(){return a.updateMarker()}).then(function(){a.draw()}).then(function(){a.renderAreasOfInterest()})},updateBpm:function(){var a=this;if(a.source){MEPH.audio.Audio.bpm(a.source.buffer).then(function(b){if(b&&b.length){var c=b.subset(0,4).orderBy(function(d,e){return e.count-d.count}).select(function(d,e){return"Tempo :"+d.tempo+"(Score:"+d.count+")  "}).join("|");setTimeout(function(){a.calculatedBpm=c},10)}})["catch"](function(b){MEPH.Log(b)})}},updateMarks:function(){var a=this;return a.render()},updateMarker:function(){var b=this;if(b.markerFrame){cancelAnimationFrame(b.markerFrame)}b.markerFrame=requestAnimationFrame(function(){var f=b.height;var e=b.width;var c=b.source;b.markerFrame=null;if(!b.markerrenderer){b.markerrenderer=new MEPH.util.Renderer();b.markerrenderer.setCanvas(b.markerCanvas)}b.markerrenderer.clear();var d=b.getMarkerPosition();b.markerrenderer.draw({shape:MEPH.util.Renderer.shapes.line,end:{x:d,y:f},start:{x:d,y:0},strokeStyle:b.markercolor});a()});var a;return new Promise(function(c){a=c})},render:function(){var b=this;if(b.markframe){cancelAnimationFrame(b.markframe)}b.markframe=requestAnimationFrame(function(){var f=b.height;var e=b.width;var c=b.source;b.markframe=null;if(!b.renderer){b.renderer=new MEPH.util.Renderer();b.renderer.setCanvas(b.markCanvas)}b.renderer.clear();if(b.marks){var d=b.marks.select(function(g){var h=b.getRelativeMarkPosition(g.position,b.magnification,b.timeScroll);return{shape:MEPH.util.Renderer.shapes.line,end:{x:h,y:f},start:{x:h,y:0},strokeStyle:b.markscolor}});b.renderer.draw(d)}a()});var a;return new Promise(function(c){a=c})}});
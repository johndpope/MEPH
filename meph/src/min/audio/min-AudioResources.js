MEPH.define("MEPH.audio.AudioResources",{requires:["MEPH.audio.Constants","MEPH.audio.Audio","MEPH.graph.Graph","MEPH.audio.music.instrument.SoundFontInstrument","MEPH.audio.graph.AudioGraphReader"],statics:{RESOURCE_MANAGER_UPDATE:"RESOURCE_MANAGER_UPDATE"},properties:{sequences:null,resources:null,graphs:null},initialize:function(){var b=this,a=MEPH.audio.Audio;b.graphReader=new MEPH.audio.graph.AudioGraphReader();b.resources=[];b.graphs=[];b.sequences=[];b.soundfonts=[];MEPH.subscribe(MEPH.audio.Audio.CHANGED_BUFFER_SOURCE,b.onResourcesChanged.bind(b));MEPH.subscribe(MEPH.audio.Constants.AUDIO_GRAPH_SAVED,b.onAudioGraphSaved.bind(b));if(a.GetSourceBuffer()){a.GetSourceBuffer().foreach(function(c){b.resources.push(c)});MEPH.publish(MEPH.audio.AudioResources.RESOURCE_MANAGER_UPDATE,{})}MEPH.subscribe(MEPH.audio.Constants.CREATE_GRAPH,function(d,f,c){var e=b.createGraph(f,c);MEPH.publish(MEPH.audio.Constants.AUDIO_GRAPH_SAVED,e)})},addResources:function(b){var a=this,c=Promise.resolve();b.foreach(function(d){if(d.file&&d.file.name.indexOf(".sf2")!==-1){var e=new MEPH.audio.music.instrument.SoundFontInstrument();var f=MEPH.GUID();e.addResource(d.file.name,".sf2",d.res,f);e.setFontFile(d.file.name);e.samplerate();e.prepare(d.file.name);a.soundfonts.push({resource:d,type:"soundfont",id:f,soundfontInstrument:e})}else{if(d.file&&(d.file.type==="audio/wav"||d.file.type==="audio/mp3")){c=c.then(function(){var g=new MEPH.audio.Audio();return g.loadByteArray(d.res,null,d.file.name,d.file.type).then(function(h){var i=a.createGraph(h.id,h.file);MEPH.publish(MEPH.audio.Constants.AUDIO_GRAPH_SAVED,i)}.bind(a))})}}});return c},createGraph:function(f,b){var d=new MEPH.graph.Graph(),c,e=new MEPH.audio.graph.node.AudioBufferSourceNode();c=new MEPH.graph.Node();c.setId(MEPH.GUID());e.id=MEPH.GUID();e.setNodeInputDefaultValue("source",f);c.appendData(e);c.data=e;d.addNode(c);var a=d.saveGraph();a.id=a.id||MEPH.GUID();a.name=b;a.file=b;e.destroy();return a},collectProject:function(){var c=this,b=new MEPH.audio.Audio(),a={};a.graphs=c.getGraphs();a.resources=c.resources.select(function(d){return b.serializeBuffer(d)});a.sequences=c.sequences.select(function(d){return JSON.stringify(d.toJSON())});return a},onAudioGraphSaved:function(a,c){var b=this;b.graphs.push(c);MEPH.publish(MEPH.audio.AudioResources.RESOURCE_MANAGER_UPDATE,{})},onResourcesChanged:function(c,b,e){var d=this,a;a=(e||[]).where(function(f){return !d.resources.some(function(g){return g===f})});d.resources.push.apply(d.resources,a);MEPH.publish(MEPH.audio.AudioResources.RESOURCE_MANAGER_UPDATE,{})},getDuration:function(e){var c=this;;var d=c.getResourceById(e);if(d){if(d.nodes){var b=d.nodes.first(function(f){return f.data.type==="MEPH.audio.graph.node.AudioBufferSourceNode"});if(b&&b.data&&b.data.nodeInputs){b=b.data.nodeInputs.first(function(f){return f.title==="source"});if(b){var a=b.defaultValue}}}}},getGraphs:function(){var a=this;return a.graphs.select()},getFontGraphInstance:function(d,a){var c=this;var b=new MEPH.audio.Audio();b.processor({size:1024,process:d});return b},getGraphInstance:function(f,b){var c=this,a=c.getGraphs().first(function(e){return e.id===f});b=b||[];if(a){c.graphReader.setGraph(MEPH.audio.graph.AudioGraphReader.cloneUnique(a));b.foreach(function(e){c.graphReader.connectGraph(e)});try{return c.graphReader.createAudio()}catch(d){MEPH.Log(d)}}return null},getSequenceInstance:function(b){var a=this;return a.sequences.first(function(c){return c.id===b})},getSoundFontInstance:function(b){var a=this;return b.sid+"/"+b.id},getSoundFontAudioInstance:function(f,c){var d=this,g=d.getSoundFontInstance(f),e=d.getSoundFont(f);e.cache=e.cache||{};var b=MEPH.GUID();var a=e.soundfontInstrument.nodeprocessor(f.id,30,true);e.cache[g]={graphid:b,sid:f.sid,id:b,process:a};return d.getFontGraphInstance(e.cache[g].process,c)},getSoundFont:function(b){var a=this;return a.soundfonts.first(function(c){return c.id===b.sid})},addSequence:function(b){var a=this;if(b.title){if(a.sequences.indexOf(b)===-1){a.sequences.push(b)}}},getSequences:function(){var a=this;return a.sequences.select()},getResources:function(b){var a=this;if(b){return a.resources.select()}return a.graphs.select().concat(a.soundfonts.select())},getResourceById:function(c){var a=this;var b=a.getResources().first(function(d){return d.id===c});return b},clearResources:function(){var a=this;a.graphs.clear();a.soundfonts.clear()}}).then(function(){return MEPH.requires("MEPH.audio.graph.node.AudioBufferSourceNode")});
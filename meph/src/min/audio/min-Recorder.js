MEPH.define("MEPH.audio.Recorder",{requires:["MEPH.query.QueryableWorker","MEPH.audio.Constants"],properties:{recBuffersL:null,recBuffersR:null,sampleRate:null},initialize:function(){var a=this;MEPH.subscribe(MEPH.audio.Constants.REQUEST_RECORDING,function(b,c){a.requestRecording(c)})},setup:function(a){var b=this;b.sampleRate=a.sampleRate;return b},requestRecording:function(c){if(!c||!c.buffer||!c.buffer.buffer){return}var b=new MEPH.audio.Audio();var e=b.createContext().createBufferSource();e.buffer=c.buffer.buffer;var d=MEPH.getClassPath("MEPH.audio.RecorderWorker")+".js";var a=new _Recorder(e,{workerPath:d});a.recordBuffer([c.buffer.buffer.getChannelData(0),c.buffer.buffer.getChannelData(1)]);a.exportWAV(function(f){MEPH.publish(MEPH.audio.Constants.RECORDING_COMPLETE,f)})},record:function(b){var a=this;a.recBuffersL.push(b[0]);a.recBuffersR.push(b[1]);a.recLength+=b[0].length;return a},exportWAV:function(c){var d=this;var e=d.mergeBuffers(d.recBuffersL,d.recLength);var b=d.mergeBuffers(d.recBuffersR,d.recLength);var g=d.interleave(e,b);var a=d.encodeWAV(g);var f=new Blob([a],{type:c});return(f)},getBuffer:function(){var a=[];var b=this;a.push(b.mergeBuffers(b.recBuffersL,b.recLength));a.push(b.mergeBuffers(b.recBuffersR,b.recLength))},clear:function(){var a=this;a.recLength=0;a.recBuffersL=[];a.recBuffersR=[];return a},mergeBuffers:function(d,b){var a=new Float32Array(b);var e=0;for(var c=0;c<d.length;c++){a.set(d[c],e);e+=d[c].length}return a},interleave:function(f,b){var d=f.length+b.length;var a=new Float32Array(d);var c=0,e=0;while(c<d){a[c++]=f[e];a[c++]=b[e];e++}return a},floatTo16BitPCM:function(b,e,a){for(var c=0;c<a.length;c++,e+=2){var d=Math.max(-1,Math.min(1,a[c]));b.setInt16(e,d<0?d*32768:d*32767,true)}},writeString:function(a,d,b){for(var c=0;c<b.length;c++){a.setUint8(d+c,b.charCodeAt(c))}},encodeWAV:function(c){var b=new ArrayBuffer(44+c.length*2);var a=new DataView(b);var d=this;d.writeString(a,0,"RIFF");a.setUint32(4,36+c.length*2,true);d.writeString(a,8,"WAVE");d.writeString(a,12,"fmt ");a.setUint32(16,16,true);a.setUint16(20,1,true);a.setUint16(22,2,true);a.setUint32(24,d.sampleRate,true);a.setUint32(28,d.sampleRate*4,true);a.setUint16(32,4,true);a.setUint16(34,16,true);d.writeString(a,36,"data");a.setUint32(40,c.length*2,true);d.floatTo16BitPCM(a,44,c);return a}}).then(function(){(function(b){var c="recorderWorker.js";var a=function(g,d){var f=d||{};var h=f.bufferLen||4096;this.context=g.context;this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,h,2,2);var i=new Worker(f.workerPath||c);i.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}});var e=false,j;this.node.onaudioprocess=function(k){if(!e){return}i.postMessage({command:"record",buffer:[k.inputBuffer.getChannelData(0),k.inputBuffer.getChannelData(1)]})};this.recordBuffer=function(k){i.postMessage({command:"record",buffer:[k[0],k[1]]})};this.configure=function(k){for(var l in k){if(k.hasOwnProperty(l)){f[l]=k[l]}}};this.record=function(){e=true};this.stop=function(){e=false};this.clear=function(){i.postMessage({command:"clear"})};this.getBuffer=function(k){j=k||f.callback;i.postMessage({command:"getBuffer"})};this.exportWAV=function(k,l){j=k||f.callback;l=l||f.type||"audio/wav";if(!j){throw new Error("Callback not set")}i.postMessage({command:"exportWAV",type:l})};i.onmessage=function(l){var k=l.data;j(k)};g.connect(this.node);this.node.connect(this.context.destination)};a.forceDownload=function(e,d){var f=(b.URL||b.webkitURL).createObjectURL(e);var h=b.document.createElement("a");h.href=f;h.download=d||"output.wav";var g=document.createEvent("Event");g.initEvent("click",true,true);h.dispatchEvent(g)};b._Recorder=a})(window)});
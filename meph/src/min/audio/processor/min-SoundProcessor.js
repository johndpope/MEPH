MEPH.define("MEPH.audio.processor.SoundProcessor",{extend:"MEPH.audio.processor.FIFOProcessor",requires:["MEPH.audio.processor.RateTransposer","MEPH.audio.processor.TDStretch"],statics:{Process:function(j){var h;var d=new MEPH.audio.processor.SoundProcessor();d.setup();d.setTempo(1.4);var k=d.standardsize;var i=0;var a=0;var g=1;var e=k/g;var m=new Float32Array(k);var b=new Float32Array(j.length);while(i<j.length){var f=j.subset(i,i+k);var l=f.length/g;d.putSamples(f,l);do{nSamples=d.receiveSamples(m,e);[].interpolate(0,nSamples,function(c){b[c+a]=m[c]});a+=nSamples}while(nSamples!=0);i+=k}return b}},properties:{pRateTransposer:null,pTDStretch:null,tempo:0,standardsize:2048},initialize:function(c){var d=this;var b=new MEPH.audio.processor.FIFOSampleBuffer(1);d.pRateTransposer=new MEPH.audio.processor.RateTransposer(b);var a=new MEPH.audio.processor.FIFOSampleBuffer(1);var e=new MEPH.audio.processor.FIFOSampleBuffer(1);d.pTDStretch=new MEPH.audio.processor.TDStretch(a,e);d.setOutPipe(d.pTDStretch);d.rate=0;d.tempo=0;d.virtualPitch=1;d.virtualRate=1;d.virtualTempo=1;d.calcEffectiveRateAndTempo();d.channels=0;d.bSrateSet=false},setup:function(){var c=this;var b=44100;var a=1;c.setSampleRate(b);c.setChannels(a);c.setTempoChange(0);c.setPitchSemiTones(0);c.setRateChange(0)},setChannels:function(a){var b=this;if(a!=1&&a!=2){throw new Error("Illegal number of channels")}b.channels=a;b.pRateTransposer.setChannels(a);b.pTDStretch.setChannels(a)},setRate:function(a){var b=this;b.virtualRate=a;b.calcEffectiveRateAndTempo()},setRateChange:function(a){var b=this;b.virtualRate=1+0.01*a;b.calcEffectiveRateAndTempo()},setTempo:function(a){var b=this;b.virtualTempo=a;b.calcEffectiveRateAndTempo()},setTempoChange:function(a){var b=this;b.virtualTempo=1+0.01*a;b.calcEffectiveRateAndTempo()},setPitch:function(b){var a=this;a.virtualPitch=b;a.calcEffectiveRateAndTempo()},setPitchOctaves:function(b){var a=this;a.virtualPitch=Math.exp(0.69314718056*b);a.calcEffectiveRateAndTempo()},setPitchSemiTones:function(b){var a=this;a.setPitchOctaves(b/12)},setPitchSemiTones:function(b){var a=this;a.setPitchOctaves(b/12)},calcEffectiveRateAndTempo:function(){var c=this;var f=c.tempo;var d=c.rate;c.tempo=c.virtualTempo/c.virtualPitch;c.rate=c.virtualPitch*c.virtualRate;var e=function(h,g){return(Math.abs(h-g)<1e-10)};if(!e(c.rate,d)){c.pRateTransposer.setRate(c.rate)}if(!e(c.tempo,f)){c.pTDStretch.setTempo(c.tempo)}if(c.rate<=1){if(c.output!=c.pTDStretch){var a;c.assert(c.output===c.pRateTransposer);a=c.pTDStretch.getOutput();a.moveSamples(c.output);c.pTDStretch.moveSamples(c.pRateTransposer.getStore());c.output=c.pTDStretch}}else{if(c.output!=c.pRateTransposer){var b;c.assert(c.output===c.pTDStretch);b=c.pRateTransposer.getOutput();b.moveSamples(c.output);c.pRateTransposer.moveSamples(c.pTDStretch.getInput());c.output=c.pRateTransposer}}},setSampleRate:function(a){var b=this;b.bSrateSet=true;b.pTDStretch.setParameters(a)},putSamples:function(b,a){var c=this;if(c.bSrateSet==false){throw new Error("SoundTouch : Sample rate not defined")}else{if(c.channels==0){throw new Error("SoundTouch : Number of channels not defined")}}if(c.rate===1){c.assert(c.output===c.pTDStretch);if(c.pRateTransposer.isEmpty()==0){c.pTDStretch.moveSamples(c.pRateTransposer)}c.pTDStretch.putSamples(b,a)}else{if(c.rate<=1){c.assert(c.output==c.pTDStretch);c.pRateTransposer.putSamples(b,a);c.pTDStretch.moveSamples(c.pRateTransposer)}else{c.assert(c.output==c.pRateTransposer);c.pTDStretch.putSamples(b,a);c.pRateTransposer.moveSamples(c.pTDStretch)}}},flush:function(){var b=this;var a;var e;var d;var c=new Float32Array(64*2);e=b.numUnprocessedSamples();e=Math.floor(e/(tempo*rate)+0.5);d=b.numSamples();d+=e;for(a=0;a<128;a++){b.putSamples(c,64);if(b.numSamples()>=d){b.adjustAmountOfSamples(d);break}}b.pRateTransposer.clear();b.pTDStretch.clearInput()},setSetting:function(h,g){var d,c,b,a;var f=this;var e={sampleRate:null,sequenceMs:null,seekWindowMs:null,overlapMs:null};f.pTDStretch.getParameters(e);switch(h){case"SETTING_USE_AA_FILTER":f.pRateTransposer.enableAAFilter((g!=0)?true:false);return true;case"SETTING_AA_FILTER_LENGTH":f.pRateTransposer.getAAFilter().setLength(g);return true;case"SETTING_USE_QUICKSEEK":f.pTDStretch.enableQuickSeek((g!=0)?true:false);return true;case"SETTING_SEQUENCE_MS":f.pTDStretch.setParameters(d,g,b,a);return true;case"SETTING_SEEKWINDOW_MS":f.pTDStretch.setParameters(d,c,g,a);return true;case"SETTING_OVERLAP_MS":f.pTDStretch.setParameters(d,c,b,g);return true;default:return false}},getSetting:function(d){var c={sampleRate:null,sequenceMs:null,seekWindowMs:null,overlapMs:null};var a;var b=this;switch(d){case"SETTING_USE_AA_FILTER":return b.pRateTransposer.isAAFilterEnabled();case"SETTING_AA_FILTER_LENGTH":return b.pRateTransposer.getAAFilter().getLength();case"SETTING_USE_QUICKSEEK":return b.pTDStretch.isQuickSeekEnabled();case"SETTING_SEQUENCE_MS":b.pTDStretch.getParameters(c);return c.sequenceMs;case"SETTING_SEEKWINDOW_MS":b.pTDStretch.getParameters(c);return c.seekWindowMs;case"SETTING_OVERLAP_MS":b.pTDStretch.getParameters(c);return c.overlapMs;case"SETTING_NOMINAL_INPUT_SEQUENCE":return b.pTDStretch.getInputSampleReq();case"SETTING_NOMINAL_OUTPUT_SEQUENCE":return b.pTDStretch.getOutputBatchSize();default:return 0}},clear:function(){var a=this;if(a.pRateTransposer){a.pRateTransposer.clear()}if(a.pTDStretch){a.pTDStretch.clear()}},numUnprocessedSamples:function(){var a=this;var b;if(a.pTDStretch){b=a.pTDStretch.getInput();if(b){return b.numSamples()}}return 0}});
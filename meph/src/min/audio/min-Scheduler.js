MEPH.define("MEPH.audio.Scheduler",{requires:["MEPH.audio.Sequence","MEPH.audio.Audio","MEPH.query.QueryableWorker"],properties:{$sequence:null,$queryWorker:null,playWindow:200,interval:50,bpm:75/16/60,playing:false},initialize:function(a){var b=this;MEPH.Events(b);if(a&&a.init){b.init()}},get:function(c,b){var a=this;return a.sequence().getScheduledAudio(c,b)},getAudio:function(c,b){var a=this;a.orderedSequence=a.sequence().getAudioWithAbsoluteTime();return a.orderedSequence.where(function(d){return d.absoluteTime*a.bpm>=c&&d.absoluteTime*a.bpm<=(b*a.bpm+c)}).orderBy(function(d,e){return d.absoluteTime-e.absoluteTime})},render:function(){var e=this,d;if(!e.sequence()){return}var g=(e.sequence().duration()||0);var b=g*e.bpm;var c=48000,h;e.sequence().setMode(true);MEPH.audio.Audio.OfflineMode=true;MEPH.audio.Audio.OfflineAudioContext=new OfflineAudioContext(2,c*b,c);var f=e.getAudio(0,g);if(d===undefined){d=0}f.foreach(function(j){var k=e.sequence().getAbsoluteTime(j)*e.bpm;j.getAudio().complete();j.getAudio().play(k+d);h=j.getAudio().duration();if(h!==null){j.getAudio().stop(k+d+(h*e.bpm))}});var a;var i=new Promise(function(j,k){a=j});MEPH.audio.Audio.OfflineAudioContext.oncomplete=function(j){a(j)};MEPH.audio.Audio.OfflineAudioContext.startRendering();return i},play:function(){var e=this,f=[],b;if(!e.sequence()){return}MEPH.audio.Audio.OfflineMode=false;var a=(e.sequence().duration()||0)*e.bpm;var d=(e.sequence().duration()||0);var c=e.getAudio(0,d);e.sequence().setMode(false);e.on("tick",function(){var h=MEPH.audio.Audio.GetContext().currentTime;if(b===undefined){b=h;a+=b}var g;c=c.where(function(i){return f.indexOf(i)===-1});c.foreach(function(i){var j=e.sequence().getAbsoluteTime(i)*e.bpm;i.getAudio().complete();i.getAudio().play(j+b);g=i.getAudio().duration();if(g!==null){i.getAudio().stop(j+b+(g*e.bpm))}f.push(i)});if(a<h&&e.playing){e.fire("complete",{currentTime:h});e.stop()}},"play");e.start();e.playing=true},init:function(){var a=this;a.$queryWorker=new MEPH.query.QueryableWorker();return a.$queryWorker.ready().then(function(b){return b.load("MEPH.audio.AudioTimer")})},start:function(){var a=this;if(a.playing){return}a.$queryWorker.message(function(){MEPH.audio.AudioTimer.start(1000)},[],function(b){if(b.data&&b.data.tick){a.fire("tick",true)}})},stop:function(){var a=this;if(!a.playing){return}a.$queryWorker.message(function(){MEPH.audio.AudioTimer.stop()},[],function(b){});a.un(null,"play");a.playing=false},terminate:function(){var a=this;a.$queryWorker.terminate()},sequence:function(a){if(a instanceof MEPH.audio.Sequence){this.$sequence=a}return this.$sequence}});
MEPH.define("MEPH.audio.Audio",{requires:["MEPH.util.Dom","MEPH.util.Observable"],statics:{audioCtx:null,OfflineMode:false,sourcebuffer:null,CHANGED_BUFFER_SOURCE:"CHANGED_BUFFER_SOURCE",nodeTypes:{oscillator:"oscillator",gain:"gain",convolver:"convolver",delay:"delay",audioElement:"audioElement",dynamicsCompressor:"dynamicsCompressor",mediastream:"mediastream",waveShaper:"waveShaper",analyser:"analyser",splitter:"splitter",processor:"processor",merger:"merger",periodicWave:"periodicWave",panner:"panner",buffer:"buffer ",biquadFilter:"biquadFilter"},GetSourceBuffer:function(){MEPH.audio.Audio.$sourcebuffer=MEPH.audio.Audio.$sourcebuffer||[];return MEPH.audio.Audio.$sourcebuffer},GetContext:function(a){var b=new MEPH.audio.Audio();return b.createContext(a)},quickAnalysis:function(e,b,f,h){var m=[];b=b||0;f=f||e.buffer.buffer.duration;var l=e.buffer.buffer.sampleRate;var j=l*b;var a=l*f;var d=a-j;h=h||2000;h=Math.min(h,2000);h=Math.round(Math.max(1,d/h));for(var g=0;g<e.buffer.channelCount;g++){var k=e.buffer.buffer.getChannelData(g);var c=k.skipEveryFromTo(Math.round(h),Math.round(j),Math.round(a),function(i){return i});m.push({channel:g,data:c})}return m},copy:function(c,a){var b=new MEPH.audio.Audio();return b.copyToBuffer(c,0,c.buffer.buffer.duration,a)},noteFromPitch:function(a){var b=12*(Math.log(a/440)/Math.log(2));return Math.round(b)+69},frequencyFromNoteNumber:function(a){return 440*Math.pow(2,(a-69)/12)},centsOffFromPitch:function(c,b){var a=MEPH.audio.Audio;return Math.floor(1200*Math.log(c/a.frequencyFromNoteNumber(b))/Math.log(2))},autoCorrelate:function(q,e){var r=q.length;var g=0;var a=Math.floor(r/2);var j=-1;var d=0;var l=0;var c=false;var m=new Array(a);var h=null;var p=null;for(var n=0;n<r;n++){var s=q[n];l+=s*s}l=Math.sqrt(l/r);if(l<0.01){return -1}var b=1;for(var f=g;f<a;f++){var k=0;for(var n=0;n<a;n++){k+=Math.abs((q[n])-(q[n+f]))}k=1-(k/a);m[f]=k;if((k>0.9)&&(k>b)){c=true;if(k>d){d=k;j=f}}else{if(c){var o=(m[j+1]-m[j-1])/m[j];return e/(j+(8*o))}}b=k}if(d>0.01){return e/j}return -1},bpm:function(a){return new Promise(function(f){var e=new MEPH.audio.Audio();var c=MEPH.audio.Audio.OfflineAudioContext=new OfflineAudioContext(1,a.buffer.length,a.buffer.sampleRate);e.buffer(a.buffer,{name:"buffer"}).biquadFilter({type:"lowpass"}).complete({channels:1,length:a.buffer.length,sampleRate:a.buffer.sampleRate});var b=function(i){var m=i.renderedBuffer;var k,l=0.9,n=l,o=0.1,j=30;do{k=MEPH.audio.Audio.getPeaksAtThreshold(i.renderedBuffer.getChannelData(0),n);n-=0.05}while(k.length<j&&n>=o);var h=MEPH.audio.Audio.countIntervalsBetweenNearbyPeaks(k);var g=MEPH.audio.Audio.groupNeighborsByTempo(h,m.sampleRate);c.removeEventListener(b);f(g.where(function(p){return !isNaN(p.tempo)}).orderBy(function(p,q){return q.count-p.count}))};var d=e.get({name:"buffer"}).first();d.node.start(c.currentTime);c.startRendering();c.addEventListener("complete",b)})},detectSilence:function(c,d,e,b){var a=[];b=b||1;e=e||10;d=d||0;var f=Math.ceil(c.length/e);[].interpolate(0,f,function(j){var i=c.subset(j*e,(j+1)*e);var g=i.maximum(function(k){return Math.abs(k)});var h=a.last();if(d>=(g)){if(!h){a.push({section:j,start:j})}else{if(h.section>=j-b&&h.end===undefined){h.section=j}else{a.push({section:j,start:j})}}}else{if(h&&h.end===undefined){h.end=j-1}}});return a.select(function(g){return{start:g.start*e,end:(g.end+1)*e}})},detectPitches:function(e,d,f,b){var c=MEPH.audio.Audio,a=[];b=b||1;f=f||e.length/2;var g=Math.ceil(e.length/f);[].interpolate(0,g,function(k){var j=e.subset(k*f,(k+1)*f);var h=c.updatePitch(j,d);var i=a.last();if(h){if(!i){a.push({section:k,start:k,key:h})}else{if(i.key.note===h.note&&i.section>=k-b&&i.end===undefined){i.section=k}else{if(i.key.note!==h.note&&i.end===undefined){i.end=k-1}a.push({section:k,start:k,key:h})}}}else{if(i&&i.end===undefined){i.end=k-1}}});return a.select(function(h){return{start:h.start*f,end:(h.end+1)*f,key:h.key}})},updatePitch:function(b,f){var i=MEPH.audio.Audio,a;var h=i.autoCorrelate(b,f);var j={};var c=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(h==-1){j=null}else{a=h;var e=i.noteFromPitch(a);var g=c[e%12];var d=i.centsOffFromPitch(a,e);j.pitch=Math.round(a*100)/100;j.note=g;if(d==0){}else{if(d<0){j.detune="flat"}else{j.detune="sharp"}}}return j},countIntervalsBetweenNearbyPeaks:function(a){var b=[];a.foreach(function(g,d){for(var e=0;e<10;e++){var c=a[d+e]-g;var f=b.some(function(h){if(h.interval===c){return h.count++}});if(!f){b.push({interval:c,count:1})}}});return b},groupNeighborsByTempo:function(b,a){var c=[];b.foreach(function(e,f){if(e.interval!==0){var d=60/(e.interval/a);while(d<90){d*=2}while(d>180){d/=2}d=Math.round(d);var g=c.some(function(h){if(h.tempo===d){return h.count+=e.count}});if(!g){c.push({tempo:d,count:e.count})}}});return c},getPeaksAtThreshold:function(e,a){var c=[];var d=e.length;for(var b=0;b<d;){if(e[b]>a){c.push(b);b+=10000}b++}return c},analyze:function(b,e,a){var d=new MEPH.audio.Audio(),c=function(f){if(a===undefined){a=Math.max(1,Math.round((f.buffer.buffer.duration*f.buffer.buffer.sampleRate)/5760))}d.buffer(f.buffer).volume({name:"volume",resolution:a}).gain({name:"gain",volume:0}).complete();return new Promise(function(g){f.buffer.onended=function(){var h=d.get({name:"volume"}).first();d.disconnect();f.buffer.stop();g(h)};f.buffer.start()})};if(arguments.length===2){return d.load(b,e).then(function(g){var f=d.copyToBuffer(g,0,g.buffer.buffer.duration);return c(f)})}else{if(arguments.length===1){return c({buffer:b})}}},clip:function(c,e,d,a){var b=new MEPH.audio.Audio();return b.copyToBuffer(c,e,d,a)},clipBuffer:function(c,f,e,a,d){var b=new MEPH.audio.Audio();return b.copyBuffer(c,f,e,a,null,d)},stretch:function(d,e){var c=new MEPH.audio.Audio();var a=Math.round(d.buffer.buffer.sampleRate*e);var b=c.copyBuffer(d,0,0,null,a);return c.copyBuffer(b,0,0,null,d.buffer.buffer.sampleRate)},cutOutSection:function(c,e,d,a){var b=new MEPH.audio.Audio();return b.cutOutSection(c,e,d,a)}},properties:{audioCtx:null,nodes:null,sourcebuffer:null,$destination:null,title:"Untitled",id:null,offlineContext:false},initialize:function(a){var b=this;MEPH.applyIf(a,b);b.nodes=[];b.id=MEPH.GUID();b.sourcebuffer=[]},load:function(c,d,b){var e=this,a=e.getBufferSources().first(function(f){return f.file===c&&f.type===d});if(a){return Promise.resolve().then(function(){return a})}return MEPH.loadJSCssFile(c,d).then(function(f){return e.loadByteArray(f.response,b,c,d)})},loadByteArray:function(e,i,d,g){var f=this,a,c,j=f.getBufferSources().first(function(k){return k.file===d&&k.type===g});var h=new Promise(function(l,k){a=l;c=k});if(j){a(j);return h}var b=f.createContext(i);b.decodeAudioData(e,function(k){var l=f.buffersource();l.buffer=k;f.addBufferSource({buffer:l,file:d,type:g});a(f.getBufferSources().last())},function(k){c(k)});return h},copyToBuffer:function(c,a,e,l){var k=this;var f=c.buffer;var i=f.buffer.sampleRate;var g=f.channelCount;var d=(e-a);var i=f.buffer.sampleRate;var j=Math.round(a*i);var h=Math.round(e*i);var b=h-j;b=Math.round(b);return k.copyBuffer(c,j,h,l)},copyBuffer:function(c,e,h,f,d,j){var q=this;h=Math.round(h)||c.buffer.buffer.length;e=Math.round(e)||0;var o=c.buffer;var r=o.buffer.sampleRate;var a=o.channelCount;var l=h-e;l=Math.round(l);var m=q.createContext(f);var g=m.createBuffer(a,l,Math.min(192000,Math.max(3000,d||m.sampleRate)));for(var s=0;s<a;s++){var b=g.getChannelData(s);var k=o.buffer.getChannelData(Math.min(o.buffer.numberOfChannels-1,s));for(var p=0;p<l;p++){if(j){b[p]=k[p+e]*(j[p]!==undefined?j[p]:1)}else{b[p]=k[p+e]}}}var n=m.createBufferSource();n.buffer=g;return{name:MEPH.GUID(),buffer:n,type:""}},cutOutSection:function(e,p,k,r){var o=this;k=Math.round(k);p=Math.round(p);var g=e.buffer;var m=g.buffer.sampleRate;var j=g.channelCount;var b=k-p;var f=g.buffer.duration*m;b=Math.round(b);f-=b;b=f;var n=o.createContext(r);var d=n.createBuffer(j,b,n.sampleRate);for(var l=0;l<j;l++){var q=d.getChannelData(l);var c=g.buffer.getChannelData(l);for(var h=0;h<b;h++){if(h<p){q[h]=c[h]}else{q[h]=c[h+k]}}}var a=n.createBufferSource();a.buffer=d;return{name:MEPH.GUID(),buffer:a,type:""}},createBuffer:function(a,b,d,c){var f=this;var e=f.createContext(c);return e.createBuffer(a,b,d)},serializeBuffer:function(a){var d=this,c={};c.name=a.name;c.type=a.type;var b=[].interpolate(0,a.buffer.numberOfChannels,function(e){var f=a.buffer.getChannelData(e);return{channel:e,data:[].interpolate(0,f.length,function(g){return f[g]})}});c.sampleRate=a.buffer.sampleRate;c.buffer=b;c.id=a.id;return btoa(JSON.stringify(c))},deserializeBuffer:function(c){var e=this;var d=atob(c);var g=JSON.parse(d);var a=g.buffer.length;var b=g.buffer.first().data.length;var f=e.createContext().createBuffer(a,b,g.sampleRate);g.buffer.foreach(function(j,h){var k=f.getChannelData(j.channel);j.data.foreach(function(i,l){k[l]=i})});return{name:g.name,type:g.type,buffer:f,id:g.id}},duration:function(b){var a=this;if(b!==undefined){this.$duration=b}return this.$duration},getSourceDuration:function(){var a=this;var b=a.nodes.where(function(c){return c.type===MEPH.audio.Audio.nodeTypes.buffer}).maximum(function(c){return c.buffer.duration});return b||0},getBufferSources:function(){var b=this,a=MEPH.audio.Audio;a.$sourcebuffer=a.$sourcebuffer||[];return MEPH.audio.Audio.$sourcebuffer.select()},getBuffer:function(c){var b=this;var a=b.getBufferSources().first(function(d){return d.id===c});if(a&&a.buffer&&a.buffer.buffer){return a.buffer.buffer}else{if(a&&a.buffer){return a.buffer}}},addBufferSource:function(b){var c=this,a=MEPH.audio.Audio;a.$sourcebuffer=a.$sourcebuffer||([]);b.id=b.id||MEPH.GUID();a.$sourcebuffer.push(b);MEPH.publish(MEPH.audio.Audio.CHANGED_BUFFER_SOURCE,b,a.$sourcebuffer);return b},removeBufferSource:function(b){var a=MEPH.audio.Audio;if(a.$sourcebuffer){MEPH.publish(MEPH.audio.Audio.CHANGED_BUFFER_SOURCE,a.$sourcebuffer);return a.$sourcebuffer.removeWhere(function(c){return c.id===b})}return null},clearContext:function(){var a=this;a.audioCtx=null;a.offlineAudioCtx=null;return a},createContext:function(a){var c=this;if(a||c.offlineMode||MEPH.audio.Audio.OfflineMode){c.offlineMode=true;a=a||{};var b=MEPH.audio.Audio.OfflineAudioContext||c.offlineAudioCtx||new (window.OfflineAudioContext)(a.channels||32,a.length||10000,a.sampleRate||44100);if(a){b.addEventListener("complete",a.oncomplete)}MEPH.audio.Audio.OfflineAudioContext=b;c.currentContext=b;return b}else{c.audioCtx=MEPH.audio.Audio.AudioContext||c.audioCtx||new (window.AudioContext||window.webkitAudioContext)();MEPH.audio.Audio.AudioContext=c.audioCtx;c.currentContext=b;return c.audioCtx}},getContext:function(){var a=this;return a.currentContext},getAudioContext:function(){var a=this;return a.audioCtx},buffersource:function(a){var c=this;var b=c.createContext(a);return b.createBufferSource()},buffer:function(a,b){var d=this;b=b||{name:"buffer"};if(!a&&b.source){var c=MEPH.audio.Audio.$sourcebuffer.first(function(e){return e.id===b.source});if(c){a=c.buffer.buffer}}if(!a&&MEPH.audio.Audio.$sourcebuffer){var c=MEPH.audio.Audio.$sourcebuffer.first(function(e){return e});if(c){a=c.buffer.buffer}}b.buffer=a instanceof AudioBufferSourceNode?a.buffer:a;b.noinputs=true;d.nodes.push({options:b,buffer:a,type:MEPH.audio.Audio.nodeTypes.buffer});return d},volume:function(c){var e=this;var d=e.createContext();var a=d.createScriptProcessor(4096,1,1);var b={options:c||null,node:a};e.nodes.push(b);b.data=[];a.onaudioprocess=function(g,m){var i=m.inputBuffer;var f=m.outputBuffer;for(var j=0;j<f.numberOfChannels;j++){var n=i.getChannelData(j);var l=f.getChannelData(j);for(var k=0;k<i.length;k++){l[k]=n[k];var h={};if(k%(c.resolution||32)===0){h[j]={amplitude:0,num:0};h[j].amplitude+=Math.pow((n[k]),2);h[j].num++;g.data.push({channels:h})}}}}.bind(e,b);return e},processor:function(b){var d=this;var c=d.createContext();if(!b||!b.process){throw new Error("Processor requires a process function.")}var a={options:b||null,processor:b.process,type:MEPH.audio.Audio.nodeTypes.processor};d.nodes.push(a);a.data=[];return d},oscillator:function(a){var b=this,c=b.createK().concat(b.createA("frequency","detune")).concat(b.createS("type"));a=a||{};a.noinputs=true;b.createNode(a,function(){return MEPH.audio.Audio.nodeTypes.oscillator},c);return b},mediastream:function(a){var b=this,c=[];a=a||{};if(!a.stream){MEPH.util.Dom.getUserMedia({audio:true}).then(function(d){a.stream=d}).then(function(){if(a.callback){a.callback(a.stream)}})}b.createNode(a,function(){return MEPH.audio.Audio.nodeTypes.mediastream},c);return b},convolver:function(a){var b=this,c=b.createK().concat(b.createA()).concat(b.createParams("boolean","normalize"));var d=b.createParams("buffer","convobuffer").first();d.alias="buffer";c.push(d);b.createNode(a,function(){return MEPH.audio.Audio.nodeTypes.convolver},c);return b},delay:function(a){var b=this,c=b.createK().concat(b.createA("delayTime"));b.createNode(a,function(){return MEPH.audio.Audio.nodeTypes.delay},c);return b},dynamicsCompressor:function(a){var b=this,c=b.createK("attack","knee","ratio","reduction","release","threshold").concat(b.createA());b.createNode(a,function(){return MEPH.audio.Audio.nodeTypes.dynamicsCompressor},c);return b},waveShaper:function(a){var b=this,c=b.createS("oversample").concat(b.createParams("float32array","curve"));b.createNode(a||null,function(){return MEPH.audio.Audio.nodeTypes.waveShaper},c);return b},audioelement:function(c,a){var b=this;a=a||{};a.node=c;b.createNode(a||null,function(){return MEPH.audio.Audio.nodeTypes.audioElement});return b},analyser:function(a){var b=this,c=b.createS().concat(b.createParams("plainNumber","fftSize","frequencyBinCount","maxDecibels","minDecibels","smoothingTimeConstant"));b.createNode(a||null,function(){return MEPH.audio.Audio.nodeTypes.analyser},c);return b},splitter:function(a){var b=this;a=a||{};a.splitIndex=0;b.setChannels(a);b.createNode(a||null,function(){return MEPH.audio.Audio.nodeTypes.splitter});return b},merger:function(a){var b=this;a=a||{};a.mergeIndex=0;b.setChannels(a);b.createNode(a,function(){return MEPH.audio.Audio.nodeTypes.merger});return b},setChannels:function(a){var c=this;if(a&&a.buffer&&a.buffer.id){var b=c.nodes.count(function(d){if(d&&d.options&&d.options.node&&d.options.node.data&&d.options.node.data.nodeOutputs){return d.options.node.data.nodeOutputs.some(function(e){return e.id===a.buffer.id})}return false});if(b>2){a.channels=b}}},periodicWave:function(a){var b=this;b.createNode(a,function(){return MEPH.audio.Audio.nodeTypes.periodicWave});return b},panner:function(a){var c=this;var b=c.createContext(),d=c.createParams("valueType","coneOuterAngle","coneInnerAngle","coneOuterGain","refDistance","maxDistance","rolloffFactor","panningModel");c.createNode(a,function(){return MEPH.audio.Audio.nodeTypes.panner},d);return c},createNode:function(a,e,f){var d=this;var b=d.createContext();var c=e();d.nodes.push({params:f,options:a||null,type:c});return d},createK:function(){var b=this,a=MEPH.Array(arguments);return b.createParams.apply(b,["k"].concat(a.select()))},createA:function(){var b=this,a=MEPH.Array(arguments);return b.createParams.apply(b,["a"].concat(a.select()))},createS:function(){var b=this,a=MEPH.Array(arguments);return b.createParams.apply(b,(["S"].concat(a.select())))},createParams:function(){var c=this,a=MEPH.Array(arguments);var b=a.first();return a.subset(1).select(function(d){return{type:b,name:d}})},biquadFilter:function(a){var b=this,c=b.createK("Q","frequency","gain").concat(b.createA("detune")).concat(b.createS("type"));b.nodes.push({params:c,options:a||null,type:MEPH.audio.Audio.nodeTypes.biquadFilter});return b},play:function(a){var b=this;a=a||0;b.nodes.where(function(c){return c.type===MEPH.audio.Audio.nodeTypes.oscillator||c.type===MEPH.audio.Audio.nodeTypes.buffer||c.type===MEPH.audio.Audio.nodeTypes.processor}).foreach(function(c){if(c.node.played){}if(c.type===MEPH.audio.Audio.nodeTypes.processor){if(c.processor.context){c.processor.context(b.createContext(),MEPH.audio.Audio.OfflineMode)}if(c.processor.start){c.processor.start(a)}}if(c.node.start){c.node.start(a)}c.node.played=true})},stop:function(a){var b=this;a=a||0;b.nodes.where(function(c){return c.type===MEPH.audio.Audio.nodeTypes.oscillator||c.type===MEPH.audio.Audio.nodeTypes.buffer||c.type===MEPH.audio.Audio.nodeTypes.processor}).foreach(function(c){if(c&&c.processor&&c.processor.stop){c.processor.stop(a,function(){b.disconnect()})}if(c.node.stop){c.node.stop(a)}})},disconnect:function(){var c=this,b,a=c.createContext();if(!c.completed){return}c.nodes.foreach(function(d,e){if(d.node){d.node.disconnect()}d.node=null});c.completed=false},gain:function(a){var b=this,c=b.createK().concat(b.createA("gain")).concat(b.createS());b.nodes.push({params:c,options:a||null,type:MEPH.audio.Audio.nodeTypes.gain});return b},createAudioNode:function(i,l,a){var d=MEPH.audio.Audio;a=a||{};var h=this;var j=new Float32Array(2);var b=new Float32Array(2);j[0]=0;b[0]=0;j[1]=1;b[1]=0;var f;switch(i){case d.nodeTypes.oscillator:return h.createContext(l).createOscillator();case d.nodeTypes.gain:e=h.createContext(l).createGain();e.gain.value=a.volume===undefined||a.volume===null?1:a.volume;return e;case d.nodeTypes.panner:return h.createContext(l).createPanner();case d.nodeTypes.convolver:return h.createContext(l).createConvolver();case d.nodeTypes.delay:return h.createContext(l).createDelay();case d.nodeTypes.dynamicsCompressor:return h.createContext(l).createDynamicsCompressor();case MEPH.audio.Audio.nodeTypes.audioElement:return h.createContext(l).createMediaElementSource(a.node);case d.nodeTypes.waveShaper:return h.createContext(l).createWaveShaper();case d.nodeTypes.analyser:return h.createContext(l).createAnalyser();case d.nodeTypes.splitter:return h.createContext(l).createChannelSplitter(a.channels||2);case d.nodeTypes.merger:return h.createContext(l).createChannelMerger(a.channels||2);case d.nodeTypes.periodicWave:return h.createContext(l).createPeriodicWave(a.real||j,a.imaginary||b);case d.nodeTypes.biquadFilter:return h.createContext(l).createBiquadFilter();case d.nodeTypes.buffer:var k=h.createContext(l).createBufferSource();k.buffer=a.buffer;return k;case d.nodeTypes.bufferSource:return h.createContext(l).createBufferSource();case d.nodeTypes.mediastream:var e=h.createContext(l).createMediaStreamSource(a.stream);return e;case d.nodeTypes.processor:var c=h.createContext(l);var g=c.createScriptProcessor(a.size||1024,1,1);g.onaudioprocess=a.process;return g;default:throw new Error("unhandled case: createAudioNode. : "+i)}},get:function(b){var a=this;return a.nodes.where(function(c){for(var d in b){return(c.options&&c.options[d]===b[d])}return false})},connect:function(b){var a=this;if(a!==b&&!a.contains(b)&&!b.contains(a)){a.nodes.push({type:"Audio",options:{audio:b}});return a}throw new Error("adding node will create a circular loop.")},contains:function(a){var b=this;return !!b.getAudioNodes().first(function(c){return c.options.audio===a})},getAudioNodes:function(){var b=this;var a=b.nodes.where(function(c){return c.type==="Audio"}).concatFluent(function(c){return[c].concat(c.options.audio.getAudioNodes())});return a},getNodes:function(){var b=this;var a=b.nodes.concatFluent(function(c){if(c.type==="Audio"){return c.options.audio.getNodes()}else{return[c]}});return a},playbuffer:function(){var b=this,a;a=b.get({name:"buffer"}).first();if(a){a.node.start()}},complete:function(c){var e=this,d,a,b=e.getNodes();if(e.completed){e.disconnect()}e.completed=true;b.foreach(function(f,g){if(!f.node){f.node=e.createAudioNode(f.type,c,f.options)}if(g){if(f.options&&f.options.buffer&&f.options.buffer.id){e.completeTargetNodes(b,f)}else{if(f.options&&f.options.noinputs){}else{d.connect(f.node)}}}if(f.params){f.params.foreach(function(h){if(f.options&&f.options[h.name]&&typeof f.options[h.name]==="object"){e.connectTargetToNode(b,f,h)}else{if(f.node[h.name]!==undefined&&f.options&&f.options[h.name]!==null&&f.options[h.name]!==undefined){if(typeof f.node[h.name]==="object"&&f.node[h.name]){f.node[h.name].value=f.options[h.name]}else{f.node[h.name]=f.options[h.name]}}else{if(h.alias){switch(h.type){case"buffer":f.node[h.alias]=e.getBuffer(f.options[h.name]);break}}}}})}d=f.node});e.connectToDestination(d,c);return e},connectToDestination:function(g,c){var e=this,a=e.getDestination();if(a){var f=a.getNodeToConnectTo();if(!f){MEPH.Log("Audio.js : No node to connect to.")}g.connect(f)}else{var d=e.createContext(c);var b=d.destination;g.connect(b)}},getNodeToConnectTo:function(){var b=this;var a=b.nodes.first();if(a){if(!b.completed){b.complete()}return a.node}return null},getDestination:function(){var a=this;return a.$destination||null},setDestination:function(a){var b=this;b.$destination=a},getBufferIndex:function(a){if(a.type===MEPH.audio.Audio.nodeTypes.merger){switch(a.options.buffer.name){case"buffer":return 0;case"buffer2":return 1;case"buffer3":return 2;case"buffer4":return 3}}},connectTargetToNode:function(c,b,e){var a,d=this;a=c.first(function(f){return f.options.node.data.nodeOutputs.some(function(g){return g.id===b.options[e.name].id})});switch(a.type){case"splitter":b.options.splitIndex=b.options.splitIndex||-1;b.options.splitIndex++;a.node.connect(b.node[e.name],0,b.options.splitIndex);break;default:if(b.type===MEPH.audio.Audio.nodeTypes.merger){b.options.mergedIndex=b.options.mergedIndex||-1;b.options.mergedIndex++;a=c.first(function(f){return f.options.node.data.nodeOutputs.some(function(g){return g.id===b.options.buffer.id})});a.node.connect(b.node[e.name],0,b.options.mergedIndex)}else{a.node.connect(b.node[e.name])}break}},completeTargetNodes:function(c,b){var a,e=this;a=c.first(function(f){return f.options.node.data.nodeOutputs.some(function(g){return g.id===b.options.buffer.id})});switch(a.type){case"splitter":b.options.splitIndex=b.options.splitIndex||-1;b.options.splitIndex++;a.node.connect(b.node,0,b.options.splitIndex);break;default:if(b.type===MEPH.audio.Audio.nodeTypes.merger){b.options.mergedIndex=b.options.mergedIndex||-1;b.options.mergedIndex++;var d=[].interpolate(0,4,function(f){if(f){return"buffer"+(f+1)}return"buffer"});d.where(function(f){return b.options[f]}).foreach(function(f){a=c.first(function(g){return g.options.node.data.nodeOutputs.some(function(h){return h.id===b.options[f].id})});if(a){a.node.connect(b.node,0,b.options.mergedIndex)}})}else{a.node.connect(b.node)}break}}});
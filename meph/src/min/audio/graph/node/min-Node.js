MEPH.define("MEPH.audio.graph.node.Node",{requires:["MEPH.util.Observable","MEPH.graph.ActiveZone","MEPH.util.Dom","MEPH.audio.graph.node.controls.AudioRange","MEPH.audio.graph.node.controls.AudioSelect","MEPH.util.Style","MEPH.audio.graph.node.controls.Control"],alias:"audionode",templates:true,extend:"MEPH.control.Control",statics:{AudioBuffer:"AudioBuffer",Boolean:"Boolean",Number:"Number",Anything:"Anything",String:"String",Float32Array:"Float32Array"},properties:{title:null,type:null,id:null,y:null,sx:null,sy:null,refresh:0,hideConnector:null,booleanSource:null,bufferTitle:"",normalizefill:"",normalizeTitle:"",numberFill:"",stringFill:"",controlverticalpadding:4,inputoutputverticalpadding:10,nodeInputs:null,nodeOutputs:null,booleanFill:"",audioBufferFill:"",bodyy:null,menuheightspace:0,inputsy:0,bodyry:1,bodyrx:1,bodystrokewidth:null,bodyfill:null,footerheight:null,headerfill:null,nodewidth:null,titlepadding:null,inputradius:0,inputstroke:null,bodystroke:null,headerheight:null,titlepaddingtop:null},initialize:function(){var a=this;a.nodecontrols=a.nodecontrols||[];a.nodeInputs=MEPH.util.Observable.observable([]);a.nodeOutputs=MEPH.util.Observable.observable([]);a.id=MEPH.GUID();a.great();a.defineNodeDependentProperties()},getRelPosition:function(c){var d=this;var e=d.svg;var b=d.svg.getTransformToElement(c);var a={x:b.e,y:b.f};return a},setupActiveControlZones:function(a,c){var b=this;if(b.nodecontrols){b.nodecontrols.foreach(function(d){b.setActiveControlZone(d,a,c)})}},getCorrespondingMatch:function(a){var d=this;var b=d.nodeInputs.first(function(e){return e.name+"input"===a||e.name===a});b=b||d.nodeOutputs.first(function(e){return e.name+"output"===a||e.name===a});var c=d.getCorrespondingControl(a);if(c&&!b){return d.getInputNodeObject(c)}return b},getCorrespondingControls:function(){var a=this;a.$correspondingcontrols=a.$correspondingcontrols||[];return a.$correspondingcontrols},getCorrespondingControl:function(a){var b=this;return b.getCorrespondingControls().first(function(c){if(typeof a==="string"){return c.name===a}return c.inout===a})},addCorrespondingControl:function(b,a){var c=this;c.getCorrespondingControls().push({name:b,inout:a})},getInputNodeObject:function(a){return a.inout},setActiveControlZone:function(b,a,f){var e=this;a=a||e.$viewport;f=f||e.$node;if(e[b]){var d=e.getCorrespondingMatch(b);var c=a.requestZone(f,{managed:true,id:d.id,type:MEPH.graph.ActiveZone.type.connector,property:b,dom:e[b].connector,connectortype:d.type});c.$options.option={canConnect:e.canConnect.bind(e),isOutput:!e[b].left}}},onLoaded:function(){var a=this;a.nodex=0;a.bodyrx=10;a.bodyry=10;a.bodystrokewidth=2;a.bodyy=0;a.title=a.title||"Node";a.nodewidth=a.nodewidth||170;a.titlepadding=15;a.footerheight=15;a.headerheight=24;a.titlepaddingtop=17;a.booleanFill=a.booleanFill||"#FAF332";a.audioBufferFill=a.audioBufferFill||"#3AF3F2";a.numberFill="#3e3e11";a.stringFill="#de31f1";a.bodyfill="rgb(90,90,90)";a.headerfill="rgb(79,79,79)";a.inputradius=a.inputradius||8;a.inputstroke="black";a.bodystroke="rgb(234,168,68)";if(a.bufferoutput){a.bufferoutput.left=false}a.bufferTitle="buffer";a.booleanSource=["true","false"];a.normalizeTitle="normalize";a.applyNodeInputsAndOutputs()},applyNodeInputsAndOutputs:function(){var a=this;a.nodeInputs.foreach(function(b){b.canConnect=a.canConnect.bind(a);b.isOutput=false;if(a[b.name]&&b.defaultValue){a[b.name].value=b.defaultValue}});a.nodeOutputs.foreach(function(b){b.canConnect=a.canConnect.bind(a);b.isOutput=false;if(a[b.name]&&b.defaultValue){a[b.name].value=b.defaultValue}})},involvedInConnections:function(a){var b=this;return b.graph.getConnections().where(function(c){return c.getZones().contains(a)})},inAConnection:function(b,a){var c=this;return c.graph.getConnections().where(function(d){return d.getZones().contains(b)&&d.getZones().contains(a)}).length>0},isOutput:function(a){return a.isOutput()},checkZoneTypeCompatibility:function(b,a){var c=this;if(c.getZoneType(b)===MEPH.audio.graph.node.Node.String||c.getZoneType(a)===MEPH.audio.graph.node.Node.String){return c.getZoneType(b)===c.getZoneType(a)}return true},canConnect:function(b,a){var c=this;if(b.getNode()===a.getNode()){return false}if(c.isOutput(b)!==!c.isOutput(a)){return false}if(!(c.getZoneType(b)==="Anything"||c.getZoneType(a)==="Anything")){if(!c.isOutput(b)&&c.involvedInConnections(b).length>0){return false}}if(!c.checkZoneTypeCompatibility(b,a)){return false}if(c.inAConnection(b,a)){return false}return true},removeNodeOutput:function(a){var b=this;b.nodeOutputs.removeWhere(function(c){return c===a})},removeNodeInput:function(a){var b=this;b.nodeInputs.removeWhere(function(c){return c===a})},addNodeInput:function(a,c,e){var d=this;if(!d.nodeInputs.some(function(f){return f.id===e})){var b=d.createInput(a,c);b.id=e;d.nodeInputs.push(b);return b}return false},addNodeOutput:function(a,c,e){var d=this;if(!d.nodeOutputs.some(function(f){return f.id===e})){var b=d.createOutput(a,c);b.id=e;d.nodeOutputs.push(b);return b}return false},getZoneType:function(a){var b=this;if(a&&a.$options&&a.$options.option){return a.$options.connectortype}return null},setupActiveZones:function(a,c){var b=this;b.$viewport=a;b.$node=c;b.setupActiveHeaderZone(a,c);b.setupActiveControlZones(a,c)},setupConnectingListeners:function(){},updatedValue:function(c){var a=this;var b=MEPH.Array(arguments).last().domEvent.value;a.setNodeInputDefaultValue(c,b)},setNodeInputDefaultValue:function(d,c){var b=this;var a=b.nodeInputs.first(function(e){return e.name===d});a=a||b.nodeOutputs.first(function(e){return e.name===d});if(a){a.defaultValue=c}},setupActiveHeaderZone:function(a,c){var b=this;a.requestZone(c,{managed:true,id:c.getId()+"-header",type:MEPH.graph.ActiveZone.type.header,dom:b.body});b.don("mousedown",[b.body,b.container,b.inputs],function(){b.svg.parentNode.appendChild(b.svg)},b);b.don("close",[b.svg],function(d){});b.graphnode=c;b.graphnode.on("removed",function(){b.closeNode()})},closeNode:function(){var a=this;if(a.graph&&a.graphnode){a.graph.removeNode(a.graphnode)}a.destroy()},defineNodeDependentProperties:function(){var a=this;a.definePositionProperty();a.defineNodeHeightProperty();a.definerHeaderBufferProperties();a.defineBodyHeightProperty();a.defineBodyWidthProperty();a.defineBodyXProperty();a.defineTitleProperties()},definePositionProperty:function(){},heightchanged:function(){var a=this;a.refresh+=1},defineNodeHeightProperty:function(){var b=this;b.nodecontrols=b.nodecontrols||[];var c=["headerheight","footerheight","refresh"];var a=b.nodecontrols.concat(c);MEPH.util.Observable.defineDependentProperty("nodeheight",b,a,function(){var d=(b.titlepaddingtop||0);a.foreach(function(g,f){var e=g;if(!c.some(function(h){return h===g})){e+=".height"}d+=parseFloat(MEPH.getPathValue(e,b)||0)});d+=(b.controlverticalpadding||0)*b.nodecontrols.length;d+=(b.inputoutputverticalpadding||0);Style.height(b.svg,d);return d});MEPH.util.Observable.defineDependentProperty("inputoutputposition",b,["headerbuffer"],function(){var d=parseFloat(b.headerbuffer||0);d+=(b.inputoutputverticalpadding||0);return d});b.controlsOffsets(b.nodecontrols)},defineTitleProperties:function(){var a=this;MEPH.util.Observable.defineDependentProperty("menutransform",a,["headerbuffer","inputsx","menuheight"],function(){var b=parseFloat(a.headerbuffer||0)-parseFloat(a.menuheight||0);return"translate("+(a.inputsx||0)+","+(b)+")"});MEPH.util.Observable.defineDependentProperty("inputtransform",a,["inputoutputposition","inputsx","inputsy"],function(){var b="translate("+(a.inputsx||0)+","+((a.inputoutputposition||0)+(a.inputsy||0))+")";return b});MEPH.util.Observable.defineDependentProperty("titlex",a,["titlepadding","titlepaddingtop"],function(){var b=(a.titlepadding||0);return b});MEPH.util.Observable.defineDependentProperty("titley",a,["titlepadding","titlepaddingtop"],function(){var b=(a.titlepaddingtop||0);return b})},defineBodyXProperty:function(){var a=this;MEPH.util.Observable.defineDependentProperty("inputsx",a,["inputradius"],function(){var b=(a.inputradius||0);return b});MEPH.util.Observable.defineDependentProperty("nodex",a,["inputradius"],function(){var b=(a.inputradius||0);return b});MEPH.util.Observable.defineDependentProperty("bodyx",a,["nodex","bodystrokewidth"],function(){var b=(parseFloat(a.nodex)||0)+(a.bodystrokewidth||0);return b});MEPH.util.Observable.defineDependentProperty("iconX",a,["nodewidth","bodystrokewidth"],function(){var b=(parseFloat(a.nodewidth)||0)+(a.bodystrokewidth||0);return b-12});MEPH.util.Observable.defineDependentProperty("iconY",a,["titley"],function(){return 5})},defineBodyHeightProperty:function(){var a=this;MEPH.util.Observable.defineDependentProperty("bodyheight",a,["nodeheight","headerheight","footerheight"],function(){var b=a.nodeheight-(a.headerheight||0)-(a.footerheight||0);return b})},controlsOffsets:function(b){var a=this;[].interpolate(0,b.length+1,function(c){if(c){MEPH.util.Observable.defineDependentProperty(b[c-1]+"y",a,b.subset(0,c-1).concat(["headerbuffer","refresh"]),function(e){var d=0;e.foreach(function(g){var f=g+".height";var h=MEPH.getPathValue(f,a);d+=parseFloat(h||0)+(a.controlverticalpadding||0)});return d}.bind(a,b.subset(0,c-1)))}})},getControlVerticalOffset:function(a){var d=this;var c=d.nodecontrols.subset(0,d.nodecontrols.indexWhere(function(e){return e===a}).first());c=c.concat(["headerbuffer"]);var b=0;c.foreach(function(f){var e=f+".height";var g=MEPH.getPathValue(e,d);b+=parseFloat(g||0)+(d.controlverticalpadding||0)});return b},defineBodyWidthProperty:function(){var a=this;MEPH.util.Observable.defineDependentProperty("bodywidth",a,["inputradius","nodewidth","bodystrokewidth"],function(){var b=a.nodewidth-(a.bodystrokewidth*2||0);Style.width(a.svg,(parseFloat(a.nodewidth)||0)+(parseFloat(a.inputradius)*2||0));return b})},definerHeaderBufferProperties:function(){var a=this;MEPH.util.Observable.defineDependentProperty("menuheight",a,["menuheightspace"],function(){var b=a.menuheightspace||0;return b});MEPH.util.Observable.defineDependentProperty("headerbuffer",a,["headerheight","menuheight"],function(){var b=0;["menuheight","headerheight"].foreach(function(c){if(a[c]){b+=a[c]}});return b})},createInput:function(b,c,a){return{name:b.nodename(),title:b,type:c,connector:null,id:MEPH.GUID(),options:a||null,output:false}},createOutput:function(a,b){return{name:a.nodename(),title:a,type:b,connector:null,id:MEPH.GUID(),output:true}}});
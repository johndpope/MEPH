MEPH.define("MEPH.audio.graph.AudioGraph",{templates:true,alias:"audiograph",extend:"MEPH.graph.GraphControl",requires:["MEPH.button.Button","MEPH.audio.graph.node.DelayNode","MEPH.graph.SVGGraphViewPort","MEPH.list.List","MEPH.graph.SVGGraph","MEPH.util.Style","MEPH.audio.graph.node.Convolver","MEPH.util.Dom","MEPH.input.Text","MEPH.graph.renderer.svg.BlenderNodeRenderer","MEPH.graph.renderer.svg.ConnectionRenderer","MEPH.audio.graph.node.BiquadFilter","MEPH.audio.graph.node.ChannelMergerNode","MEPH.audio.graph.node.GeneratedNode","MEPH.audio.graph.node.ChannelSplitterNode","MEPH.graph.SVGGraphRenderer","MEPH.audio.graph.node.DynamicsCompressorNode","MEPH.audio.graph.node.GainNode","MEPH.audio.graph.node.AudioBufferSourceNode","MEPH.audio.graph.node.OutputNode","MEPH.audio.graph.node.InputNode","MEPH.audio.graph.node.OscillatorNode","MEPH.audio.graph.node.PannerNode","MEPH.audio.graph.node.WaveShaperNode","MEPH.audio.AudioResources"],scripts:["MEPH.audio.graph.AudioGraphNameChange"],properties:{graphsources:null},injections:["audioResources"],initialize:function(){var a=this;a.graph=new MEPH.graph.SVGGraph();MEPH.subscribe(MEPH.audio.AudioResources.RESOURCE_MANAGER_UPDATE,a.updateGraphList.bind(a));MEPH.subscribe("opengraphinstance",a.openGraphInstanceHandler.bind(a));a.great()},statics:{screate:function(g,i,b,d){b=b||"body";var e=new MEPH.graph.SVGGraphViewPort();var f=new MEPH.graph.SVGGraphRenderer();var h=new MEPH.graph.renderer.svg.ConnectionRenderer();var c=new MEPH.graph.renderer.svg.BlenderNodeRenderer(e);var a=new MEPH.graph.ConnectionHandler();a.setGraph(g);e.setConnectionHandler(a);e.setup(b,i);f.setNodeRenderer(c);f.setConnectionRenderer(h);f.setGraph(g);f.setViewPort(e);f.use("viewport");e.setGraph(g);f.render();if(d&&document.querySelector(d)){e.setHolder(d);e.resize();window.addEventListener("resize",function(){e.resize()})}e.selectConnectionOnClick=true;return e}},openGraphInstanceHandler:function(c,b){var d=this;var e=d.graphsources.first(function(f){return f.name===b});d.graph.clear();var a=JSON.stringify(e);return d.graph.load(a,d)},onLoaded:function(){var a=this;a.id="graph"+MEPH.GUID();a.graphsources=MEPH.util.Observable.observable([]);a.querySelectorAll("div.graphBody").first().parentNode.setAttribute("id",a.id);a.graphviewport=MEPH.audio.graph.AudioGraph.screate(a.graph||new MEPH.graph.SVGGraph(),{element:"svg"},"#"+a.id+" div.graphBody","#"+a.id);a.don("click",document.body,function(b){if(!MEPH.util.Dom.isDomDescendant(document.activeElement,a.audiographpopup)){a.closepopup()}},a)},resize:function(){var a=this;a.graphviewport.resize()},removeSelectedConnections:function(){var a=this;a.graph.removeConnections(a.graphviewport.getSelectedConnections().select());a.graphviewport.removeSelectedConnections()},updateGraphList:function(){var a=this;if(a.$inj&&a.$inj.audioResources){a.graphsources.clear();a.graphsources.push.apply(a.graphsources,a.$inj.audioResources.getGraphs())}},openGraphInstance:function(a){var b=this;MEPH.publish("opengraphinstance",a)},openGraph:function(){var a=this;if(!a.openedonce){a.openedonce=true;document.body.appendChild(a.audiographpopup);MEPH.util.Dom.centerElement(a.audiographpopup)}a.popupopen=true;Style.show(a.audiographpopup);MEPH.util.Dom.centerElement(a.audiographpopup)},closepopup:function(){var a=this;a.popupopen=false;Style.hide(a.audiographpopup)},saveGraph:function(){var c=this;var b=c.graph.save();var a={id:c.graph.id||MEPH.GUID(),connections:b.connections.select(),nodes:b.nodes.select(function(d){var e={id:d.id,position:d.position,data:{id:d.data.id,type:d.data.____type,nodeInputs:d.data.nodeInputs.select(),nodeOutputs:d.data.nodeOutputs.select()}};if(d.data.subGraph){e.data.subGraph=JSON.parse(JSON.stringify(d.data.subGraph))}return e})};return a},nameGraph:function(b){var a=this;return new Promise(function(d,g){var h=a.getTemplateEl("MEPH.audio.graph.AudioGraphNameChange");var c=h.querySelector("input");var e;Dom.addSimpleDataEntryToElments(a,[{element:c,setFunc:function(f){e=f}}],h,function(){if(e){b.name=e;d(b)}});c.focus()})},save:function(){var a=this;return JSON.stringify(a.saveGraph())},loadGraph:function(b){var a=this;return a.graph.load(b,a)},addConvolver:function(){var b=this,a;return b.addAudioNode("MEPH.audio.graph.node.Convolver")},addCustom:function(){var b=this;var a={connections:[{id:"1fd470e0-e09d-4c65-b512-3f2001227685",nodes:["df585831-ac49-443f-bdae-c48fc85183e3","037a064b-374d-40eb-9648-4e7ca5591baf"],zones:["1ca9a3a1-0642-4054-b654-3cc2f896619d","9c782c6e-2ebf-4afc-9f17-d8e8874e44f5"]},{id:"acbbaf26-525e-420b-8ac5-20ef066efd09",nodes:["df585831-ac49-443f-bdae-c48fc85183e3","037a064b-374d-40eb-9648-4e7ca5591baf"],zones:["f7f889d7-152c-42fb-b5d4-74a0d802bfcc","9c782c6e-2ebf-4afc-9f17-d8e8874e44f5"]},{id:"c27827d0-b8e2-49d3-b2f6-3ff2827c13f8",nodes:["df585831-ac49-443f-bdae-c48fc85183e3","037a064b-374d-40eb-9648-4e7ca5591baf"],zones:["6d7a696b-c1e9-4cf7-8b29-c8213f528b6e","9c782c6e-2ebf-4afc-9f17-d8e8874e44f5"]},{id:"f90a7359-7124-4e01-ade3-b6c394f28a6d",nodes:["df585831-ac49-443f-bdae-c48fc85183e3","037a064b-374d-40eb-9648-4e7ca5591baf"],zones:["4905939a-f5ab-44ff-8d8f-1e2973d3eafe","9c782c6e-2ebf-4afc-9f17-d8e8874e44f5"]},{id:"48a4446f-6537-4059-a490-31cede7ac8a1",nodes:["df585831-ac49-443f-bdae-c48fc85183e3","cef80e71-f0b9-45ef-99c6-67ee4554745c"],zones:["13d343a0-9cc4-4c7d-8674-25069bdca343","bfee62ed-9a4f-4fab-875b-3e24c87b8e06"]}],nodes:[{id:"037a064b-374d-40eb-9648-4e7ca5591baf",position:{x:0,y:0,z:0},data:{id:"6b241096-8024-4f84-ae5b-3e4ea5ff0abb",type:"MEPH.audio.graph.node.InputNode",nodeInputs:[{name:"bufferinput",title:"bufferinput",type:"AudioBuffer",connector:null,id:"1ca9a3a1-0642-4054-b654-3cc2f896619d",options:null,output:false},{name:"q",title:"q",type:"Number",connector:null,id:"f7f889d7-152c-42fb-b5d4-74a0d802bfcc",options:null,output:false},{name:"frequency",title:"frequency",type:"Number",connector:null,id:"6d7a696b-c1e9-4cf7-8b29-c8213f528b6e",options:null,output:false},{name:"detune",title:"detune",type:"Number",connector:null,id:"4905939a-f5ab-44ff-8d8f-1e2973d3eafe",options:null,output:false}],nodeOutputs:[{name:"buffer",title:"buffer",type:"Anything",connector:null,id:"9c782c6e-2ebf-4afc-9f17-d8e8874e44f5",output:true,isOutput:false}]}},{id:"cef80e71-f0b9-45ef-99c6-67ee4554745c",position:{x:953,y:217,z:0},data:{id:"5a46043a-dc5d-46b2-a479-58bb29137be3",type:"MEPH.audio.graph.node.OutputNode",nodeInputs:[{name:"buffer",title:"buffer",type:"Anything",connector:null,id:"bfee62ed-9a4f-4fab-875b-3e24c87b8e06",options:null,output:false,isOutput:false}],nodeOutputs:[{name:"bufferoutput",title:"bufferoutput",type:"AudioBuffer",connector:null,id:"13d343a0-9cc4-4c7d-8674-25069bdca343",output:true}]}},{id:"df585831-ac49-443f-bdae-c48fc85183e3",position:{x:537,y:71,z:0},data:{id:"dd2ce35b-bbba-4b22-9141-ae14426c5f16",type:"MEPH.audio.graph.node.BiquadFilter",nodeInputs:[{name:"buffer",title:"buffer",type:"AudioBuffer",connector:null,id:"1ca9a3a1-0642-4054-b654-3cc2f896619d",options:null,output:false,isOutput:false},{name:"q",title:"q",type:"Number",connector:null,id:"f7f889d7-152c-42fb-b5d4-74a0d802bfcc",options:{path:"Q.value"},output:false,isOutput:false},{name:"frequency",title:"frequency",type:"Number",connector:null,id:"6d7a696b-c1e9-4cf7-8b29-c8213f528b6e",options:{path:"frequency.value"},output:false,isOutput:false},{name:"detune",title:"detune",type:"Number",connector:null,id:"4905939a-f5ab-44ff-8d8f-1e2973d3eafe",options:{path:"detune.value"},output:false,isOutput:false},{name:"gain",title:"gain",type:"Number",connector:null,id:"1add0375-f396-4cb0-8f6e-d5f520919856",options:{path:"gain.value"},output:false,isOutput:false},{name:"type",title:"type",type:"String",connector:null,id:"35d307d9-097d-4e07-b0e3-f09acbd658d3",options:{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]},output:false,isOutput:false}],nodeOutputs:[{name:"buffer",title:"buffer",type:"AudioBuffer",connector:null,id:"13d343a0-9cc4-4c7d-8674-25069bdca343",output:true,isOutput:false}]}}]};return b.addAudioNode("MEPH.audio.graph.node.GeneratedNode",a)},addOutput:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.OutputNode")},addInput:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.InputNode")},addAudioSource:function(){var b=this,a;return b.addAudioNode("MEPH.audio.graph.node.AudioBufferSourceNode")},addDelay:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.DelayNode")},addBiquadFilter:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.BiquadFilter")},addChannelMerger:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.ChannelMergerNode")},addChannelSplitter:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.ChannelSplitterNode")},addDynamicsCompressor:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.DynamicsCompressorNode")},addGain:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.GainNode")},addOscillator:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.OscillatorNode")},addPanner:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.PannerNode")},addWaveShaper:function(){var a=this;return a.addAudioNode("MEPH.audio.graph.node.WaveShaperNode")},addAudioNode:function(e,a){var d=this,b=d.graphviewport.getGCanvas(),c;return d.renderControl(e,b,d,null,a).then(function(g){var f=g.first();c=new MEPH.graph.Node();c.setId(MEPH.GUID());c.appendData(f.classInstance);d.addNode(c)})}});
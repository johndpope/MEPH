MEPH.define("MEPH.audio.Sequence",{requires:["MEPH.mixins.Injections","MEPH.audio.graph.AudioGraphReader"],mixins:{injections:"MEPH.mixins.Injections"},statics:{defaultSequenceGraphRecipe:{id:"b2ab59ba-df15-48ad-b6a0-0fc76c14d963",connections:[],nodes:[{id:"a13c9096-907e-49a1-97f8-76bd929585e8",position:{x:400,y:107,z:0},data:{id:"17afd0d6-aec7-4006-8510-b32a0cbef594",type:"MEPH.audio.graph.node.GainNode",nodeInputs:[{name:"buffer",title:"buffer",type:"AudioBuffer",connector:null,id:"30cae3fa-52c6-477f-9420-8f2bc5a6c346",options:null,output:false,isOutput:false},{name:"gain",title:"gain",type:"Number",connector:null,id:"3552de45-df3e-47c4-8fd6-32df291079ff",options:{path:"gain.value"},output:false,isOutput:false,defaultValue:"0.56"}],nodeOutputs:[{name:"buffer",title:"buffer",type:"AudioBuffer",connector:null,id:"26190909-b9a9-443f-9a30-c544ac469c7a",output:true,isOutput:false}]}}]},deserialize:function(b,d){var c=new MEPH.audio.Sequence();var a=JSON.parse(b);c.deserialize(a,d);return c}},injections:["audioResources"],properties:{parts:null,title:null,id:null,$midinote:null,containsSequences:false},initialize:function(a){var b=this;b.parts=[];b.mixins.injections.init.apply(b);b.id=MEPH.GUID();if(a){if(a.title){b.title=a.title}if(a.id){b.id=a.id}}},setDefault:function(a,c){var b=this;b.$defaultType=a;b.$defaultRefId=c},setDefaultGraph:function(b){var a=this;a.setDefault("graph",b)},setDefaultSoundFont:function(b){var a=this;a.setDefault("soundfont",b)},setMode:function(a){var b=this,c=b.getGraph(true);if(c){c.disconnect();c.offlineMode=a}if(b.containsSequences){res=[];b.parts.foreach(function(d){d.source.setMode(a)})}else{b.parts.select(function(d){d.getAudio().disconnect();d.getAudio().clearContext();d.getAudio().offlineMode=a})}},getGraph:function(b){var d=this;if(!d.$$graph&&d.$graph){var c=MEPH.audio.graph.AudioGraphReader.cloneUnique(d.$graph);var a=new MEPH.audio.graph.AudioGraphReader();a.setGraph(c);try{d.$$graph=a.createAudio();d.$$graph.sequencecreated=true}catch(f){d.$$graph=null;MEPH.Log(f)}}if(b){return d.$$graph}d.$graph=d.$graph||MEPH.audio.graph.AudioGraphReader.cloneUnique(MEPH.audio.Sequence.defaultSequenceGraphRecipe);return d.$graph},saveGraph:function(b){var a=this;a.$graph=b;if(a.$$graph){a.$$graph.disconnect()}a.$$graph=null},getDefaultInstance:function(){var b=this,a=null;if(b.$inj.audioResources){switch(b.$defaultType){case"graph":a=b.$defaultRefId;break;case"sequence":a=b.$inj.audioResources.getSequenceInstance(b.$defaultRefId);break;case"soundfont":a=b.$inj.audioResources.getSoundFontInstance(b.$defaultRefId);break}}return a},midiNote:function(a){var b=this;if(a!==undefined){b.$midinote=parseFloat(a)}return b.$midinote},items:function(){var a=this;return a.parts},itemSequences:function(){var a=this;return a.items().concatFluent(function(b){return b.source.items()})},applyAbsoluteTime:function(a){},getAbsoluteTime:function(b){var a=this;if(b.absoluteTime!==undefined){return b.absoluteTime}},setRelativeTime:function(c,d){var b=this;var a=b.getParent(c);if(a.source.isChild(c)){c.relativeTimeOffset=Math.max(0,d);c.absoluteTime=undefined}else{a.source.setRelativeTime(c,d-a.relativeTimeOffset)}},getParentIndexOf:function(c){var b=this,a;if(c.parentIndex!==undefined){return c.parentIndex}else{a=b.getParent(c);if(c.parent&&c.parent!==a){}c.parent=a}c.parentIndex=b.items().indexOf(a);return c.parentIndex},getParent:function(c){var b=this;var a=b.items().first(function(d){return d===c||(b.containsSequences?d.source.hasDescendant(c):false)});return a},isChild:function(b){var a=this;return a.items().first(function(c){return b===c})},hasDescendant:function(b){var a=this;return a.items().any(function(c){return c===b||(a.containsSequences?c.source.hasDescendant(b):false)})},containsRef:function(b){var a=this;return a.items().any(function(c){return c.source===b||(a.containsSequences?c.source.containsRef(b):false)})},remove:function(b){var a=this;return a.items().removeWhere(function(c){return c===b})},add:function(d,a,f){var c=this,e,b=MEPH.Array(arguments);f=f||null;if(!d){d=c.getDefaultInstance();if(!d){return}}if(c.parts.length===0){c.containsSequences=d instanceof MEPH.audio.Sequence}if(((c.containsSequences&&d instanceof MEPH.audio.Sequence)||(!c.containsSequences&&d instanceof MEPH.audio.Audio)||(!c.containsSequences&&typeof d==="string"))&&(typeof d==="string"||d instanceof MEPH.audio.Audio||(!d.containsRef(c)))){c.parts.push({source:d,relativeTimeOffset:a||0,duration:f,getAudio:function(){if(typeof this.source==="string"&&this.audioSource){this.audioSource.duration(this.duration);return this.audioSource}return this.source}});if(d instanceof MEPH.audio.Audio&&f){d.duration(f)}return d}return false},get:function(){var a=this;return a.parts.select()},duration:function(a){var b=this;a=a||[];return b.parts.maximum(function(c){if(c.containsSequences){return c.source.duration(a)+c.relativeTimeOffset}else{if(typeof c.source==="string"){return c.duration+c.relativeTimeOffset}return c.source.duration()+c.relativeTimeOffset}})},getDuration:function(a){return a.source.duration()},getScheduledAudio:function(d,c,a){var b=this;a=a||[];a=b.connectExtensions(a);if(b.containsSequences){return b.parts.concatFluent(function(e){return e.source.getScheduledAudio(e.relativeTimeOffset-d,c,a)})}else{return b.parts.where(function(e){return e.relativeTimeOffset>=d&&e.relativeTimeOffset<=(d+c)}).select(function(e){return b.assignAudioSource(e,a)})}},connectExtensions:function(b){var c=this;var a=c.getGraph(true)||null;if(a){a.setDestination(b.first());a.complete();b=[a]}return b},assignAudioSource:function(a,b){var c=this;if(typeof a.source==="string"){if(c.$defaultType==="soundfont"){a.audioSource=c.$inj.audioResources.getSoundFontAudioInstance(c.$defaultRefId)}else{a.audioSource=c.$inj.audioResources.getGraphInstance(a.source)}if(b&&b.length){a.audioSource.setDestination(b.first())}}return a},clone:function(a){var c={};for(var b in a){c[b]=a[b]}return c},getAudios:function(b,a){var d=this,c;a=a||0;b=b||[];b=d.connectExtensions(b);if(d.containsSequences){c=[];d.parts.foreach(function(f){var e=f.source.getAudios(b,a+f.relativeTimeOffset);e.foreach(function(g){if(c.indexOf(g)===-1){c.push(g)}})})}else{c=d.parts.select(function(e){var f=d.clone(d.assignAudioSource(e,b));f.absoluteTime=a+e.relativeTimeOffset;return f})}return c},getAudioWithAbsoluteTime:function(){var b=this,a=b.getAudios();return a},toJSON:function(){var b=this,a;if(b.containsSequences){if(b.parts){a=b.parts.select(function(c){return{sequence:c.source.toJSON(),relativeTimeOffset:c.relativeTimeOffset}})}}else{if(b.parts){a=b.parts.select(function(c){return{audioId:c.id,relativeTimeOffset:c.relativeTimeOffset}})}}return{parts:a,id:b.id,title:b.title,graph:b.getGraph(true),sequence:b.containsSequences}},deserialize:function(b,d,c){var a=this;c=c||[];a.id=b.id;a.title=b.title||a.title;a.$graph=b.graph||null;if(b.sequence){b.parts.foreach(function(e){var g=new MEPH.audio.Sequence();var f=a.add(g,e.relativeTimeOffset);if(!c.some(function(h){return h===e.sequence.id})){c.push(g.id);g.deserialize(e.sequence,d,c)}})}else{b.parts.foreach(function(e){var f=d.get(e.audioId);a.add(f,e.relativeTimeOffset)})}}});